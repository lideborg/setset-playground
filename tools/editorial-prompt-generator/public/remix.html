<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remix - Nano Banana Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            background: #ffffff;
            line-height: 1.5;
            color: #1a1a1a;
            padding: 24px 16px;
        }

        .container {
            max-width: 650px;
            margin: 0 auto;
        }

        h1 {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 4px;
            text-align: center;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: #737373;
            margin-bottom: 24px;
            font-size: 12px;
            text-align: center;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: #737373;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-align: center;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            padding: 10px;
            border: 2px dashed #e5e5e5;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .upload-grid.drag-over {
            border-color: #1a1a1a;
            background: #fafafa;
        }

        .upload-slot {
            aspect-ratio: 3/4;
            border: 1px solid #e5e5e5;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.15s ease;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #d4d4d4;
        }

        .upload-slot:hover {
            border-color: #1a1a1a;
            background: #f5f5f5;
        }

        .upload-slot.filled {
            border-color: #1a1a1a;
            background: white;
        }

        .upload-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-slot .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 11px;
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .upload-slot.filled:hover .remove-btn {
            display: flex;
        }

        .upload-slot .checkbox-wrapper {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        .upload-slot .checkbox-wrapper input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            margin: 0;
        }

        .upload-slot.deselected {
            opacity: 0.4;
        }

        .upload-slot.deselected img {
            filter: grayscale(100%);
        }

        .prompt-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            min-height: 90px;
            background: #fafafa;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: #1a1a1a;
            background: white;
        }

        .controls-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .control-group {
            flex: 1;
        }

        .control-label {
            font-size: 10px;
            font-weight: 600;
            color: #737373;
            margin-bottom: 6px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e5e5e5;
            border-radius: 5px;
            font-size: 13px;
            font-family: inherit;
            background: #fafafa;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #1a1a1a;
            background: white;
        }

        .generate-btn {
            width: 100%;
            background: #1a1a1a;
            color: white;
            border: none;
            padding: 14px 24px;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.15s ease;
        }

        .generate-btn:hover:not(:disabled) {
            background: #404040;
        }

        .generate-btn:disabled {
            background: #e5e5e5;
            color: #a3a3a3;
            cursor: not-allowed;
        }

        .btn-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .btn-label {
            font-size: 13px;
            font-weight: 500;
        }

        .btn-formula {
            font-size: 10px;
            opacity: 0.8;
            font-weight: 400;
        }

        .results-section {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e5e5e5;
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .results-header h2 {
            font-size: 14px;
            font-weight: 500;
            color: #1a1a1a;
        }

        .results-stats {
            font-size: 11px;
            color: #737373;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .result-item {
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            overflow: hidden;
            background: white;
            transition: all 0.15s ease;
        }

        .result-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
            cursor: pointer;
        }

        .result-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        .result-item .result-info {
            padding: 8px;
            font-size: 9px;
            color: #737373;
            border-top: 1px solid #e5e5e5;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 24px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1a1a1a;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e5e5;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #1a1a1a;
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            font-size: 10px;
            color: #737373;
            margin-top: 6px;
        }

        .error {
            display: none;
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 10px;
            border-radius: 5px;
            color: #991b1b;
            margin-bottom: 16px;
            font-size: 12px;
            text-align: center;
        }

        .error.show {
            display: block;
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .lightbox.show {
            display: flex;
        }

        .lightbox-content {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 90%;
            background: #ffffff;
            gap: 28px;
            padding: 60px 80px;
        }

        .lightbox-image-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            width: 100%;
        }

        .lightbox-image {
            max-width: 85%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            border: 1px solid #1a1a1a;
        }

        .lightbox-info {
            text-align: center;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .lightbox-prompt {
            font-size: 13px;
            color: #1a1a1a;
            line-height: 1.7;
        }

        .lightbox-counter {
            font-size: 10px;
            color: #737373;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .lightbox-download {
            padding: 8px 20px;
            background: #1a1a1a;
            color: #ffffff;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .lightbox-download:hover {
            background: #404040;
        }

        .lightbox-close {
            position: absolute;
            top: 30px;
            right: 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: #1a1a1a;
            line-height: 1;
            transition: color 0.15s;
        }

        .lightbox-close:hover {
            color: #737373;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 36px;
            color: #1a1a1a;
            line-height: 1;
            transition: color 0.15s;
            padding: 10px;
        }

        .lightbox-nav:hover {
            color: #737373;
        }

        .lightbox-nav.prev {
            left: 30px;
        }

        .lightbox-nav.next {
            right: 30px;
        }

        input[type="file"] {
            display: none;
        }

        .prompt-hint {
            font-size: 10px;
            color: #a3a3a3;
            margin-top: 4px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Remix Tool</h1>
        <p class="subtitle">Nano Banana Pro Image Generation</p>

        <div class="error" id="error"></div>

        <!-- Primary Images -->
        <div class="section">
            <div class="section-title">Primary Images (Required)</div>
            <div class="upload-grid" id="primaryGrid" data-type="primary"></div>
            <input type="file" id="primaryInput" accept="image/*" multiple>
        </div>

        <!-- Secondary Images -->
        <div class="section">
            <div class="section-title">Secondary Images (Optional)</div>
            <div class="upload-grid" id="secondaryGrid" data-type="secondary"></div>
            <input type="file" id="secondaryInput" accept="image/*" multiple>
        </div>

        <!-- Prompts -->
        <div class="section">
            <div class="section-title">Prompts</div>
            <textarea
                class="prompt-textarea"
                id="promptTextarea"
                placeholder="Insert prompt here... (one per line)"
            ></textarea>
            <p class="prompt-hint">Each line break creates a new prompt</p>
        </div>

        <!-- Controls -->
        <div class="section">
            <div class="controls-row">
                <div class="control-group">
                    <label class="control-label">Aspect Ratio</label>
                    <select id="aspectRatioSelect">
                        <option value="3:4" selected>3:4 (Portrait)</option>
                        <option value="4:5">4:5 (Portrait)</option>
                        <option value="2:3">2:3 (Portrait)</option>
                        <option value="9:16">9:16 (Vertical)</option>
                        <option value="1:1">1:1 (Square)</option>
                        <option value="16:9">16:9 (Landscape)</option>
                        <option value="4:3">4:3 (Landscape)</option>
                        <option value="21:9">21:9 (Ultrawide)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">Resolution</label>
                    <select id="resolutionSelect">
                        <option value="1K" selected>1K (Standard)</option>
                        <option value="2K">2K (High)</option>
                        <option value="4K">4K (Ultra - 2x cost)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">Seeds per Prompt</label>
                    <select id="seedsSelect">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Generate Button -->
        <button class="generate-btn" id="generateBtn" disabled>
            <div class="btn-content">
                <span class="btn-label">Generate Images</span>
                <span class="btn-formula" id="btnFormula">Select images and add prompts to begin</span>
            </div>
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">Generating images...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p class="progress-text" id="progressText">0 / 0 completed</p>
        </div>

        <!-- Results -->
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>Generated Images</h2>
                <div class="results-stats" id="resultsStats"></div>
            </div>
            <div class="results-grid" id="resultsGrid"></div>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-content">
            <button class="lightbox-close" id="lightboxClose">‚úï</button>
            <button class="lightbox-nav prev" id="lightboxPrev">‚Üê</button>
            <button class="lightbox-nav next" id="lightboxNext">‚Üí</button>
            <div class="lightbox-image-wrapper">
                <img class="lightbox-image" id="lightboxImage" src="" alt="Full size">
            </div>
            <div class="lightbox-info">
                <div class="lightbox-prompt" id="lightboxPrompt"></div>
                <div class="lightbox-counter" id="lightboxCounter"></div>
                <button class="lightbox-download" id="lightboxDownload">Download</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let primaryImages = new Array(10).fill(null);
        let secondaryImages = new Array(10).fill(null);
        let allGeneratedImages = []; // Store all generated images with metadata
        let currentLightboxIndex = 0;

        // Elements
        const primaryGrid = document.getElementById('primaryGrid');
        const secondaryGrid = document.getElementById('secondaryGrid');
        const primaryInput = document.getElementById('primaryInput');
        const secondaryInput = document.getElementById('secondaryInput');
        const promptTextarea = document.getElementById('promptTextarea');
        const aspectRatioSelect = document.getElementById('aspectRatioSelect');
        const resolutionSelect = document.getElementById('resolutionSelect');
        const seedsSelect = document.getElementById('seedsSelect');
        const generateBtn = document.getElementById('generateBtn');
        const btnFormula = document.getElementById('btnFormula');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');
        const resultsStats = document.getElementById('resultsStats');
        const resultsGrid = document.getElementById('resultsGrid');
        const errorDiv = document.getElementById('error');
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightboxImage');
        const lightboxPrompt = document.getElementById('lightboxPrompt');
        const lightboxCounter = document.getElementById('lightboxCounter');
        const lightboxClose = document.getElementById('lightboxClose');
        const lightboxDownload = document.getElementById('lightboxDownload');
        const lightboxPrev = document.getElementById('lightboxPrev');
        const lightboxNext = document.getElementById('lightboxNext');

        // Initialize grids (5x2 = 10 slots)
        function initializeGrids() {
            for (let i = 0; i < 10; i++) {
                const primarySlot = createUploadSlot(i, 'primary');
                primaryGrid.appendChild(primarySlot);

                const secondarySlot = createUploadSlot(i, 'secondary');
                secondaryGrid.appendChild(secondarySlot);
            }
        }

        function createUploadSlot(index, type) {
            const slot = document.createElement('div');
            slot.className = 'upload-slot';
            slot.innerHTML = '+';
            slot.dataset.index = index;
            slot.dataset.type = type;

            slot.addEventListener('click', () => {
                if (type === 'primary') {
                    primaryInput.click();
                    primaryInput.dataset.targetSlot = index;
                } else {
                    secondaryInput.click();
                    secondaryInput.dataset.targetSlot = index;
                }
            });

            return slot;
        }

        // Drag and drop support
        function setupDragAndDrop(grid, type) {
            grid.addEventListener('dragover', (e) => {
                e.preventDefault();
                grid.classList.add('drag-over');
            });

            grid.addEventListener('dragleave', () => {
                grid.classList.remove('drag-over');
            });

            grid.addEventListener('drop', (e) => {
                e.preventDefault();
                grid.classList.remove('drag-over');

                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                if (files.length > 0) {
                    handleFileUpload(files, type, null);
                }
            });
        }

        // File input handlers
        primaryInput.addEventListener('change', (e) => {
            const targetSlot = e.target.dataset.targetSlot ? parseInt(e.target.dataset.targetSlot) : null;
            handleFileUpload(Array.from(e.target.files), 'primary', targetSlot);
            e.target.value = ''; // Reset input
        });

        secondaryInput.addEventListener('change', (e) => {
            const targetSlot = e.target.dataset.targetSlot ? parseInt(e.target.dataset.targetSlot) : null;
            handleFileUpload(Array.from(e.target.files), 'secondary', targetSlot);
            e.target.value = ''; // Reset input
        });

        function handleFileUpload(files, type, startIndex) {
            const images = type === 'primary' ? primaryImages : secondaryImages;
            const gridId = type === 'primary' ? 'primaryGrid' : 'secondaryGrid';
            const grid = document.getElementById(gridId);

            files.forEach((file, i) => {
                let index;
                if (startIndex !== null) {
                    // If clicking on a specific slot, use that slot
                    index = startIndex;
                } else {
                    // Find the next available empty slot starting from the current position
                    let searchStart = 0;
                    for (let j = 0; j < i; j++) {
                        // For each previous file in this batch, skip past it
                        const nextEmpty = images.findIndex((img, idx) => !img && idx >= searchStart);
                        if (nextEmpty !== -1) {
                            searchStart = nextEmpty + 1;
                        }
                    }
                    index = images.findIndex((img, idx) => !img && idx >= searchStart);
                }

                if (index === -1 || index >= 10) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    images[index] = {
                        file: file,
                        url: e.target.result,
                        selected: true
                    };

                    const slot = grid.children[index];
                    slot.classList.add('filled');
                    slot.innerHTML = `
                        <img src="${e.target.result}" alt="Image ${index + 1}">
                        <div class="checkbox-wrapper" onclick="event.stopPropagation()">
                            <input type="checkbox" checked onchange="toggleImage(${index}, '${type}', this.checked)">
                        </div>
                        <button class="remove-btn" onclick="event.stopPropagation(); removeImage(${index}, '${type}')">√ó</button>
                    `;

                    updateCalculator();
                };
                reader.readAsDataURL(file);
            });
        }

        window.toggleImage = function(index, type, checked) {
            const images = type === 'primary' ? primaryImages : secondaryImages;
            const gridId = type === 'primary' ? 'primaryGrid' : 'secondaryGrid';
            const grid = document.getElementById(gridId);

            if (images[index]) {
                images[index].selected = checked;
                const slot = grid.children[index];
                if (checked) {
                    slot.classList.remove('deselected');
                } else {
                    slot.classList.add('deselected');
                }
                updateCalculator();
            }
        };

        window.removeImage = function(index, type) {
            const images = type === 'primary' ? primaryImages : secondaryImages;
            const gridId = type === 'primary' ? 'primaryGrid' : 'secondaryGrid';
            const grid = document.getElementById(gridId);

            // Remove the image and shift all subsequent images down
            images.splice(index, 1);
            images.push(null); // Add null at the end to maintain 10 slots

            // Re-render the entire grid
            for (let i = 0; i < 10; i++) {
                const slot = grid.children[i];
                if (images[i]) {
                    slot.classList.add('filled');
                    if (!images[i].selected) {
                        slot.classList.add('deselected');
                    } else {
                        slot.classList.remove('deselected');
                    }
                    slot.innerHTML = `
                        <img src="${images[i].url}" alt="Image ${i + 1}">
                        <div class="checkbox-wrapper" onclick="event.stopPropagation()">
                            <input type="checkbox" ${images[i].selected ? 'checked' : ''} onchange="toggleImage(${i}, '${type}', this.checked)">
                        </div>
                        <button class="remove-btn" onclick="event.stopPropagation(); removeImage(${i}, '${type}')">√ó</button>
                    `;
                } else {
                    slot.classList.remove('filled', 'deselected');
                    slot.innerHTML = '+';
                }
            }

            updateCalculator();
        };

        // Update calculator and button
        function updateCalculator() {
            const selectedPrimary = primaryImages.filter(img => img && img.selected);
            const selectedSecondary = secondaryImages.filter(img => img && img.selected);
            const prompts = getValidPrompts();
            const seeds = parseInt(seedsSelect.value);
            const resolution = resolutionSelect.value;

            const primaryCount = selectedPrimary.length;
            const secondaryCount = selectedSecondary.length > 0 ? selectedSecondary.length : 1;
            const promptCount = prompts.length;
            const totalImages = primaryCount * secondaryCount * promptCount * seeds;

            // 4K costs 2x ($0.30), others cost $0.15
            const pricePerImage = resolution === '4K' ? 0.30 : 0.15;
            const totalCost = totalImages * pricePerImage;

            if (primaryCount === 0 || promptCount === 0) {
                generateBtn.disabled = true;
                btnFormula.textContent = 'Select images and add prompts to begin';
            } else {
                generateBtn.disabled = false;
                const formula = `${primaryCount} primary √ó ${secondaryCount} ${selectedSecondary.length > 0 ? 'secondary' : '(solo)'} √ó ${promptCount} prompts √ó ${seeds} seeds = ${totalImages} images ($${totalCost.toFixed(2)})`;
                btnFormula.textContent = formula;
            }
        }

        function getValidPrompts() {
            return promptTextarea.value
                .split('\n')
                .map(p => p.trim())
                .filter(p => p.length > 0);
        }

        // Event listeners
        promptTextarea.addEventListener('input', updateCalculator);
        aspectRatioSelect.addEventListener('change', updateCalculator);
        resolutionSelect.addEventListener('change', updateCalculator);
        seedsSelect.addEventListener('change', updateCalculator);

        // Generate button
        generateBtn.addEventListener('click', handleGenerate);

        async function handleGenerate() {
            errorDiv.classList.remove('show');

            const validPrompts = getValidPrompts();
            if (validPrompts.length === 0) {
                showError('Please add at least one prompt.');
                return;
            }

            const selectedPrimary = primaryImages.filter(img => img && img.selected);
            if (selectedPrimary.length === 0) {
                showError('Please select at least one primary image.');
                return;
            }

            const selectedSecondary = secondaryImages.filter(img => img && img.selected);
            const numSeeds = parseInt(seedsSelect.value);
            const aspectRatio = aspectRatioSelect.value;
            const resolution = resolutionSelect.value;

            // Generate all combinations
            const allTasks = [];

            selectedPrimary.forEach((primaryImg, primaryIndex) => {
                const secondaryToUse = selectedSecondary.length > 0 ? selectedSecondary : [null];

                secondaryToUse.forEach((secondaryImg, secondaryIndex) => {
                    const imageUrls = secondaryImg
                        ? [primaryImg.url, secondaryImg.url]
                        : [primaryImg.url];

                    validPrompts.forEach((prompt, promptIndex) => {
                        allTasks.push({
                            prompt: prompt,
                            imageUrls: imageUrls,
                            numImages: numSeeds,
                            aspectRatio: aspectRatio,
                            resolution: resolution,
                            metadata: {
                                primaryIndex,
                                secondaryIndex: secondaryImg ? secondaryIndex : null,
                                promptIndex,
                                prompt
                            }
                        });
                    });
                });
            });

            // Execute tasks
            loading.classList.add('show');
            generateBtn.disabled = true;
            resultsSection.classList.remove('show');

            progressFill.style.width = '0%';
            progressText.textContent = `0 / ${allTasks.length} completed`;

            console.log(`\nüöÄ Starting generation: ${allTasks.length} total tasks`);
            console.log(`‚ö° Running ALL tasks in parallel (unlimited concurrency)`);
            const overallStart = performance.now();

            console.log(`\nüì¶ Starting all ${allTasks.length} tasks simultaneously:`);
            allTasks.forEach((task, idx) => {
                console.log(`   ${idx + 1}. "${task.prompt.substring(0, 50)}${task.prompt.length > 50 ? '...' : ''}"`);
            });

            // Run all tasks in parallel - track progress
            let completedCount = 0;
            const results = await Promise.all(
                allTasks.map(async (task, idx) => {
                    const result = await executeRemixTask(task, idx + 1);
                    completedCount++;
                    const progress = (completedCount / allTasks.length) * 100;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `${completedCount} / ${allTasks.length} completed`;
                    return result;
                })
            );

            const overallTime = ((performance.now() - overallStart) / 1000).toFixed(1);
            console.log(`\nüéâ All ${allTasks.length} tasks complete! Total time: ${overallTime}s`);
            console.log(`   Average: ${(overallTime / allTasks.length).toFixed(1)}s per task`);

            displayResults(results);

            loading.classList.remove('show');
            updateCalculator();
        }

        async function executeRemixTask(task, taskNumber) {
            const taskStart = performance.now();
            try {
                console.log(`   ‚è≥ Task ${taskNumber} started: "${task.prompt.substring(0, 40)}${task.prompt.length > 40 ? '...' : ''}"`);

                const response = await fetch('/api/remix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: task.prompt,
                        image_urls: task.imageUrls,
                        num_images: task.numImages,
                        aspect_ratio: task.aspectRatio,
                        resolution: task.resolution
                    }),
                });

                if (!response.ok) {
                    const taskTime = ((performance.now() - taskStart) / 1000).toFixed(1);
                    const errorData = await response.json();
                    console.error(`   ‚ùå Task ${taskNumber} failed in ${taskTime}s:`, errorData.error);
                    return {
                        success: false,
                        error: errorData.error || 'Generation failed',
                        metadata: task.metadata
                    };
                }

                const data = await response.json();
                const imageUrls = data.images?.map(img => img.url) || [];
                const taskTime = ((performance.now() - taskStart) / 1000).toFixed(1);

                console.log(`   ‚úÖ Task ${taskNumber} complete in ${taskTime}s: ${imageUrls.length} images`);

                return {
                    success: true,
                    urls: imageUrls,
                    metadata: task.metadata
                };
            } catch (error) {
                console.error('Generation error:', error);
                return {
                    success: false,
                    error: 'Network error',
                    metadata: task.metadata
                };
            }
        }

        function displayResults(results) {
            resultsGrid.innerHTML = '';

            // Store all images in state
            allGeneratedImages = results.flatMap(result =>
                result.success ? result.urls.map(url => ({ ...result, url })) : []
            );

            const successCount = results.filter(r => r.success).length;
            const totalTasks = results.length;

            resultsStats.textContent = `${allGeneratedImages.length} images generated from ${totalTasks} tasks (${successCount} successful)`;

            allGeneratedImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `
                    <img src="${image.url}" alt="Generated ${index + 1}">
                `;

                // Add click handler to open lightbox
                item.addEventListener('click', () => openLightbox(index));

                resultsGrid.appendChild(item);
            });

            resultsSection.classList.add('show');
        }

        // Lightbox functions
        function openLightbox(index) {
            if (allGeneratedImages.length === 0) return;
            currentLightboxIndex = index;
            updateLightboxDisplay();
            lightbox.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function updateLightboxDisplay() {
            if (allGeneratedImages.length === 0) return;

            const currentImage = allGeneratedImages[currentLightboxIndex];
            lightboxImage.src = currentImage.url;
            lightboxPrompt.textContent = currentImage.metadata.prompt;
            lightboxCounter.textContent = `${currentLightboxIndex + 1} / ${allGeneratedImages.length}`;
        }

        function closeLightbox() {
            lightbox.classList.remove('show');
            document.body.style.overflow = '';
        }

        function navigateLightbox(direction) {
            if (allGeneratedImages.length === 0) return;

            if (direction === 'next') {
                currentLightboxIndex = (currentLightboxIndex + 1) % allGeneratedImages.length;
            } else if (direction === 'prev') {
                currentLightboxIndex = (currentLightboxIndex - 1 + allGeneratedImages.length) % allGeneratedImages.length;
            }

            updateLightboxDisplay();
        }

        async function downloadImage() {
            const imageUrl = lightboxImage.src;
            if (!imageUrl) return;

            try {
                // Generate filename with timestamp
                const now = new Date();
                const year = now.getFullYear().toString().slice(-2);
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                const filename = `Setset_Remix_${year}${month}${day}_${hours}${minutes}${seconds}.png`;

                // Fetch the image and download it
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Download failed:', error);
                alert('Failed to download image');
            }
        }

        // Lightbox event listeners
        lightboxClose.addEventListener('click', closeLightbox);
        lightboxDownload.addEventListener('click', downloadImage);
        lightboxPrev.addEventListener('click', () => navigateLightbox('prev'));
        lightboxNext.addEventListener('click', () => navigateLightbox('next'));

        // Close on background click
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) {
                closeLightbox();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('show')) return;

            if (e.key === 'Escape') {
                closeLightbox();
            } else if (e.key === 'ArrowLeft') {
                navigateLightbox('prev');
            } else if (e.key === 'ArrowRight') {
                navigateLightbox('next');
            }
        });

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        // Initialize
        initializeGrids();
        setupDragAndDrop(primaryGrid, 'primary');
        setupDragAndDrop(secondaryGrid, 'secondary');
        updateCalculator();
    </script>
</body>
</html>
