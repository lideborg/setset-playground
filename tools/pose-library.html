<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pose Library</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßç</text></svg>">
    <link rel="stylesheet" href="/shared/css/tokens.css">
    <link rel="stylesheet" href="/shared/css/base.css">
    <link rel="stylesheet" href="/shared/css/components.css">
    <style>
        .container {
            max-width: 1400px;
        }

        /* Filter bar */
        .filter-bar {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .filter-label {
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            color: var(--slate);
        }

        .filter-buttons {
            display: flex;
            gap: 4px;
        }

        .filter-btn {
            padding: 6px 12px;
            font-size: var(--text-xs);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            background: var(--off-white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .filter-btn:hover {
            border-color: var(--ash-grey);
        }

        .filter-btn.active {
            background: var(--jet);
            color: var(--white);
            border-color: var(--jet);
        }

        .stats {
            margin-left: auto;
            font-size: var(--text-sm);
            color: var(--slate);
        }

        /* Upload section */
        .upload-section {
            background: var(--white);
            border: 2px dashed var(--gainsboro);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .upload-section:hover {
            border-color: var(--jet);
            background: var(--off-white);
        }

        .upload-section.drag-over {
            border-color: var(--jet);
            background: rgba(0, 0, 0, 0.05);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: var(--space-sm);
        }

        .upload-text {
            font-size: var(--text-md);
            color: var(--slate);
            margin-bottom: var(--space-xs);
        }

        .upload-hint {
            font-size: var(--text-xs);
            color: var(--ash-grey);
        }

        /* Pose grid */
        .pose-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        @media (min-width: 900px) {
            .pose-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        .pose-card {
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: all var(--transition-fast);
        }

        .pose-card:hover {
            border-color: var(--ash-grey);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .pose-image {
            aspect-ratio: 3/4;
            width: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .pose-info {
            padding: var(--space-sm);
        }

        .pose-gender {
            display: inline-block;
            padding: 2px 8px;
            font-size: var(--text-2xs);
            font-weight: 600;
            text-transform: uppercase;
            border-radius: var(--radius-xs);
            margin-bottom: var(--space-xs);
        }

        .pose-gender.male {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .pose-gender.female {
            background: #fce7f3;
            color: #be185d;
        }

        .pose-gender.unisex {
            background: #e5e7eb;
            color: #374151;
        }

        .pose-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: var(--space-xs);
        }

        .pose-category {
            padding: 2px 6px;
            font-size: 9px;
            background: var(--off-white);
            border-radius: var(--radius-xs);
            color: var(--slate);
        }

        .pose-description {
            font-size: var(--text-xs);
            color: var(--slate);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .pose-actions {
            display: flex;
            gap: 4px;
            margin-top: var(--space-xs);
            padding-top: var(--space-xs);
            border-top: 1px solid var(--gainsboro);
        }

        .pose-action-btn {
            flex: 1;
            padding: 4px 8px;
            font-size: var(--text-2xs);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-xs);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .pose-action-btn:hover {
            background: var(--off-white);
        }

        .pose-action-btn.delete:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        /* Analyze modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
        }

        .modal.visible {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius-md);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--gainsboro);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: var(--text-md);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--slate);
        }

        .modal-body {
            padding: var(--space-md);
        }

        .modal-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            background: var(--off-white);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-md);
        }

        .form-group {
            margin-bottom: var(--space-md);
        }

        .form-label {
            display: block;
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            color: var(--slate);
            margin-bottom: var(--space-xs);
        }

        .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            font-size: var(--text-sm);
            font-family: inherit;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .category-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
        }

        .category-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--off-white);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--text-xs);
            transition: all var(--transition-fast);
        }

        .category-checkbox:hover {
            background: var(--gainsboro);
        }

        .category-checkbox.selected {
            background: var(--jet);
            color: var(--white);
        }

        .category-checkbox input {
            display: none;
        }

        /* Tag groups in modal */
        .tag-group {
            margin-bottom: var(--space-md);
        }

        .tag-group-label {
            font-size: var(--text-2xs);
            font-weight: 600;
            text-transform: uppercase;
            color: var(--ash-grey);
            margin-bottom: var(--space-xs);
            display: block;
        }

        .tag-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .tag-btn {
            padding: 4px 10px;
            font-size: var(--text-xs);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            background: var(--off-white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .tag-btn:hover {
            border-color: var(--ash-grey);
        }

        .tag-btn.selected {
            background: var(--jet);
            color: var(--white);
            border-color: var(--jet);
        }

        /* Active tag filters */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .active-filter {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--jet);
            color: var(--white);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
        }

        .active-filter .remove {
            cursor: pointer;
            opacity: 0.7;
        }

        .active-filter .remove:hover {
            opacity: 1;
        }

        .clear-filters {
            font-size: var(--text-xs);
            color: var(--slate);
            cursor: pointer;
            text-decoration: underline;
        }

        .clear-filters:hover {
            color: var(--carbon);
        }

        .modal-footer {
            padding: var(--space-md);
            border-top: 1px solid var(--gainsboro);
            display: flex;
            gap: var(--space-sm);
            justify-content: flex-end;
        }

        /* Loading state */
        .analyzing {
            text-align: center;
            padding: var(--space-lg);
        }

        .analyzing-text {
            font-size: var(--text-sm);
            color: var(--slate);
            margin-top: var(--space-sm);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gainsboro);
            border-top-color: var(--jet);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--slate);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--space-sm);
            opacity: 0.5;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <h1>Pose Library</h1>
            <p class="hero-subtitle">Collect, categorize, and browse reference poses</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section" id="upload-section">
            <div class="upload-icon">üì∏</div>
            <div class="upload-text">Drop pose images here or click to upload</div>
            <div class="upload-hint">Images will be analyzed and categorized automatically</div>
        </div>
        <input type="file" id="file-input" accept="image/*" multiple>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group">
                <span class="filter-label">Gender</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="male">Male</button>
                    <button class="filter-btn" data-filter="female">Female</button>
                    <button class="filter-btn" data-filter="unisex">Unisex</button>
                </div>
            </div>
            <div class="filter-group">
                <span class="filter-label">Tags</span>
                <select class="form-select" id="tag-filter" style="width: auto; padding: 6px 12px;">
                    <option value="">+ Add filter</option>
                </select>
            </div>
            <div class="active-filters" id="active-filters"></div>
            <div class="stats" id="stats">0 poses</div>
        </div>

        <!-- Pose Grid -->
        <div class="pose-grid" id="pose-grid">
            <div class="empty-state">
                <div class="empty-state-icon">üßç</div>
                <p>No poses yet. Upload some images to get started!</p>
            </div>
        </div>
    </div>

    <!-- Analyze/Edit Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modal-title">Analyze Pose</span>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <img src="" alt="" class="modal-image" id="modal-image">

                <div id="analyzing-state" class="analyzing" style="display: none;">
                    <div class="spinner"></div>
                    <div class="analyzing-text">Analyzing pose...</div>
                </div>

                <div id="form-state">
                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        <div class="filter-buttons">
                            <button class="filter-btn" data-gender="male">Male</button>
                            <button class="filter-btn" data-gender="female">Female</button>
                            <button class="filter-btn" data-gender="unisex">Unisex</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tags</label>
                        <div id="tag-groups"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="pose-description" placeholder="Describe the pose for prompt generation..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="modal-cancel">Cancel</button>
                <button class="btn btn--primary" id="modal-save">Save Pose</button>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-content" style="max-width: 800px;">
            <button class="lightbox-close" id="lightbox-close">&times;</button>
            <div class="lightbox-left">
                <img src="" alt="" class="lightbox-image" id="lightbox-image">
            </div>
            <div class="lightbox-right">
                <div class="lightbox-section">
                    <h3 class="lightbox-section-title">Gender</h3>
                    <p id="lightbox-gender"></p>
                </div>
                <div class="lightbox-section">
                    <h3 class="lightbox-section-title">Categories</h3>
                    <p id="lightbox-categories"></p>
                </div>
                <div class="lightbox-section">
                    <h3 class="lightbox-section-title">Description</h3>
                    <p id="lightbox-description"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="/shared/js/utils.js"></script>
    <script src="/shared/js/api.js"></script>
    <script>
        // Tag system organized by groups
        const TAG_GROUPS = {
            'Framing': ['full-body', 'three-quarter', 'half-body', 'close-up'],
            'Orientation': ['frontal', '3/4-angle', 'profile', 'back-view', 'over-shoulder'],
            'Stance': ['standing', 'sitting', 'walking', 'leaning', 'floor', 'crouching'],
            'Arms': ['arms-at-sides', 'hands-in-pockets', 'hands-on-hips', 'arms-crossed', 'arms-raised', 'touching-face', 'holding-garment', 'hands-clasped'],
            'Legs': ['feet-together', 'weight-shifted', 'wide-stance', 'legs-crossed', 'one-knee-bent'],
            'Mood': ['confident', 'relaxed', 'editorial', 'dynamic', 'candid'],
            'Use Case': ['e-commerce', 'lookbook', 'campaign', 'social'],
            'Props': ['with-chair', 'with-stool', 'against-wall', 'with-bag']
        };

        // Flatten all tags for easy lookup
        const ALL_TAGS = Object.values(TAG_GROUPS).flat();

        // State
        const state = {
            poses: [],
            filterGender: 'all',
            filterTags: [],  // Array of active tag filters
            currentPose: null,
            currentImageData: null,
            selectedTags: []  // Tags selected in modal
        };

        // DOM Elements
        const elements = {
            uploadSection: document.getElementById('upload-section'),
            fileInput: document.getElementById('file-input'),
            poseGrid: document.getElementById('pose-grid'),
            stats: document.getElementById('stats'),
            tagFilter: document.getElementById('tag-filter'),
            activeFilters: document.getElementById('active-filters'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalImage: document.getElementById('modal-image'),
            modalBody: document.getElementById('modal-body'),
            analyzingState: document.getElementById('analyzing-state'),
            formState: document.getElementById('form-state'),
            tagGroups: document.getElementById('tag-groups'),
            poseDescription: document.getElementById('pose-description'),
            lightbox: document.getElementById('lightbox'),
            lightboxImage: document.getElementById('lightbox-image'),
            lightboxGender: document.getElementById('lightbox-gender'),
            lightboxCategories: document.getElementById('lightbox-categories'),
            lightboxDescription: document.getElementById('lightbox-description')
        };

        // Initialize
        async function init() {
            await loadPoses();
            setupEventListeners();
            populateTagFilter();
            renderTagGroups();
            renderPoses();
        }

        // Load poses from JSON file (with localStorage override for custom additions)
        async function loadPoses() {
            try {
                // First load from JSON file
                const response = await fetch('/shared/data/pose-library.json');
                const data = await response.json();
                state.poses = data.poses || [];

                // Then merge any localStorage additions
                const localSaved = localStorage.getItem('poseLibrary_custom');
                if (localSaved) {
                    const customPoses = JSON.parse(localSaved);
                    // Add custom poses that aren't already in the library
                    customPoses.forEach(cp => {
                        if (!state.poses.find(p => p.id === cp.id)) {
                            state.poses.push(cp);
                        }
                    });
                }
            } catch (e) {
                console.error('Failed to load pose library:', e);
                // Fallback to localStorage only
                const saved = localStorage.getItem('poseLibrary_custom');
                if (saved) {
                    state.poses = JSON.parse(saved);
                }
            }
        }

        // Save custom poses to localStorage (file-based poses are read-only)
        function savePoses() {
            // Only save custom poses (those without imagePath starting with /assets/)
            const customPoses = state.poses.filter(p => !p.imagePath?.startsWith('/assets/'));
            localStorage.setItem('poseLibrary_custom', JSON.stringify(customPoses));
        }

        // Setup event listeners
        function setupEventListeners() {
            // Upload
            elements.uploadSection.addEventListener('click', () => elements.fileInput.click());
            elements.uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.uploadSection.classList.add('drag-over');
            });
            elements.uploadSection.addEventListener('dragleave', () => {
                elements.uploadSection.classList.remove('drag-over');
            });
            elements.uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadSection.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                handleFiles(files);
            });
            elements.fileInput.addEventListener('change', (e) => {
                handleFiles(Array.from(e.target.files));
                e.target.value = '';
            });

            // Filters
            document.querySelectorAll('.filter-bar .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-bar .filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.filterGender = btn.dataset.filter;
                    renderPoses();
                });
            });

            // Tag filter dropdown
            elements.tagFilter.addEventListener('change', () => {
                const tag = elements.tagFilter.value;
                if (tag && !state.filterTags.includes(tag)) {
                    state.filterTags.push(tag);
                    renderActiveFilters();
                    renderPoses();
                }
                elements.tagFilter.value = '';
            });

            // Modal
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('modal-cancel').addEventListener('click', closeModal);
            document.getElementById('modal-save').addEventListener('click', savePose);

            // Gender buttons in modal
            document.querySelectorAll('[data-gender]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-gender]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Lightbox
            document.getElementById('lightbox-close').addEventListener('click', () => {
                elements.lightbox.classList.remove('visible');
            });
            elements.lightbox.addEventListener('click', (e) => {
                if (e.target === elements.lightbox) {
                    elements.lightbox.classList.remove('visible');
                }
            });
        }

        // Populate tag filter dropdown (grouped)
        function populateTagFilter() {
            Object.entries(TAG_GROUPS).forEach(([group, tags]) => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group;
                tags.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag;
                    option.textContent = formatTag(tag);
                    optgroup.appendChild(option);
                });
                elements.tagFilter.appendChild(optgroup);
            });
        }

        // Format tag for display
        function formatTag(tag) {
            return tag.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        // Render active filter tags
        function renderActiveFilters() {
            if (state.filterTags.length === 0) {
                elements.activeFilters.innerHTML = '';
                return;
            }

            elements.activeFilters.innerHTML = state.filterTags.map(tag => `
                <span class="active-filter">
                    ${formatTag(tag)}
                    <span class="remove" onclick="removeFilter('${tag}')">&times;</span>
                </span>
            `).join('') + `<span class="clear-filters" onclick="clearFilters()">Clear all</span>`;
        }

        // Remove a filter tag
        function removeFilter(tag) {
            state.filterTags = state.filterTags.filter(t => t !== tag);
            renderActiveFilters();
            renderPoses();
        }
        window.removeFilter = removeFilter;

        // Clear all filters
        function clearFilters() {
            state.filterTags = [];
            renderActiveFilters();
            renderPoses();
        }
        window.clearFilters = clearFilters;

        // Render tag groups in modal
        function renderTagGroups() {
            elements.tagGroups.innerHTML = Object.entries(TAG_GROUPS).map(([group, tags]) => `
                <div class="tag-group">
                    <span class="tag-group-label">${group}</span>
                    <div class="tag-buttons">
                        ${tags.map(tag => `
                            <button type="button" class="tag-btn" data-tag="${tag}">${formatTag(tag)}</button>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Add click handlers
            elements.tagGroups.querySelectorAll('.tag-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('selected');
                    const tag = btn.dataset.tag;
                    if (btn.classList.contains('selected')) {
                        if (!state.selectedTags.includes(tag)) {
                            state.selectedTags.push(tag);
                        }
                    } else {
                        state.selectedTags = state.selectedTags.filter(t => t !== tag);
                    }
                });
            });
        }

        // Handle file uploads
        async function handleFiles(files) {
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    state.currentImageData = e.target.result;
                    state.currentPose = null;
                    openModal(true);
                    await analyzePose(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        // Analyze pose with AI
        async function analyzePose(imageData) {
            elements.analyzingState.style.display = 'block';
            elements.formState.style.display = 'none';

            try {
                // Upload image
                const uploadResult = await api.uploadBase64(imageData);

                // Build tag list for AI
                const tagList = ALL_TAGS.join(', ');

                // Analyze with Claude
                const analysisPrompt = `Analyze this pose image for a fashion photography pose library. Select ALL applicable tags from the list below.

Available tags: ${tagList}

Respond in JSON format only:

{
    "gender": "male" | "female" | "unisex",
    "tags": ["array of applicable tags from the list above - select all that apply"],
    "description": "A detailed description of the pose for image generation prompts. Include body position, arm placement, head direction, weight distribution, and overall mood/energy."
}`;

                const result = await api.analyzeImages([uploadResult.url], analysisPrompt);

                if (result.content) {
                    // Try to parse JSON from response
                    let analysis;
                    try {
                        // Find JSON in the response
                        const jsonMatch = result.content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            analysis = JSON.parse(jsonMatch[0]);
                        }
                    } catch (e) {
                        console.error('Failed to parse analysis:', e);
                    }

                    if (analysis) {
                        // Set gender
                        document.querySelectorAll('[data-gender]').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.gender === analysis.gender);
                        });

                        // Set tags (support both 'tags' and legacy 'categories')
                        const tags = analysis.tags || analysis.categories || [];
                        state.selectedTags = tags.filter(t => ALL_TAGS.includes(t));
                        elements.tagGroups.querySelectorAll('.tag-btn').forEach(btn => {
                            const isSelected = state.selectedTags.includes(btn.dataset.tag);
                            btn.classList.toggle('selected', isSelected);
                        });

                        // Set description
                        elements.poseDescription.value = analysis.description || '';
                    }
                }
            } catch (error) {
                console.error('Analysis error:', error);
            } finally {
                elements.analyzingState.style.display = 'none';
                elements.formState.style.display = 'block';
            }
        }

        // Open modal
        function openModal(isNew = false) {
            elements.modalTitle.textContent = isNew ? 'Analyze Pose' : 'Edit Pose';
            const imageSrc = state.currentImageData || state.currentPose?.imagePath || state.currentPose?.image || '';
            elements.modalImage.src = imageSrc;
            elements.modal.classList.add('visible');

            if (!isNew && state.currentPose) {
                // Populate form with existing data
                document.querySelectorAll('[data-gender]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.gender === state.currentPose.gender);
                });

                // Set tags (support both 'tags' and legacy 'categories')
                const tags = state.currentPose.tags || state.currentPose.categories || [];
                state.selectedTags = [...tags];
                elements.tagGroups.querySelectorAll('.tag-btn').forEach(btn => {
                    const isSelected = state.selectedTags.includes(btn.dataset.tag);
                    btn.classList.toggle('selected', isSelected);
                });

                elements.poseDescription.value = state.currentPose.description || '';
            } else {
                state.selectedTags = [];
            }
        }

        // Close modal
        function closeModal() {
            elements.modal.classList.remove('visible');
            state.currentPose = null;
            state.currentImageData = null;
            state.selectedTags = [];

            // Reset form
            document.querySelectorAll('[data-gender]').forEach(btn => btn.classList.remove('active'));
            elements.tagGroups.querySelectorAll('.tag-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            elements.poseDescription.value = '';
        }

        // Save pose
        function savePose() {
            const gender = document.querySelector('[data-gender].active')?.dataset.gender || 'unisex';
            const tags = [...state.selectedTags];
            const description = elements.poseDescription.value.trim();

            if (state.currentPose) {
                // Update existing
                state.currentPose.gender = gender;
                state.currentPose.tags = tags;
                delete state.currentPose.categories; // Migrate from old format
                state.currentPose.description = description;
            } else {
                // Add new
                const newPose = {
                    id: Date.now().toString(),
                    image: state.currentImageData,
                    gender,
                    tags,
                    description,
                    createdAt: new Date().toISOString()
                };
                state.poses.push(newPose);
            }

            savePoses();
            renderPoses();
            closeModal();
        }

        // Delete pose
        function deletePose(id) {
            if (confirm('Delete this pose?')) {
                state.poses = state.poses.filter(p => p.id !== id);
                savePoses();
                renderPoses();
            }
        }

        // Edit pose
        function editPose(id) {
            state.currentPose = state.poses.find(p => p.id === id);
            state.currentImageData = null;
            openModal(false);
        }

        // View pose in lightbox
        function viewPose(id) {
            const pose = state.poses.find(p => p.id === id);
            if (!pose) return;

            const tags = getPoseTags(pose);
            const imageSrc = pose.imagePath || pose.image;
            elements.lightboxImage.src = imageSrc;
            elements.lightboxGender.textContent = pose.gender.charAt(0).toUpperCase() + pose.gender.slice(1);
            elements.lightboxCategories.textContent = tags.map(t => formatTag(t)).join(', ') || 'None';
            elements.lightboxDescription.textContent = pose.description || 'No description';
            elements.lightbox.classList.add('visible');
        }

        // Get pose tags (support both new 'tags' and legacy 'categories')
        function getPoseTags(pose) {
            return pose.tags || pose.categories || [];
        }

        // Render poses
        function renderPoses() {
            let filtered = state.poses;

            // Filter by gender
            if (state.filterGender !== 'all') {
                filtered = filtered.filter(p => p.gender === state.filterGender);
            }

            // Filter by tags (must have ALL selected tags)
            if (state.filterTags.length > 0) {
                filtered = filtered.filter(p => {
                    const poseTags = getPoseTags(p);
                    return state.filterTags.every(tag => poseTags.includes(tag));
                });
            }

            // Update stats
            elements.stats.textContent = `${filtered.length} pose${filtered.length !== 1 ? 's' : ''}`;

            if (filtered.length === 0) {
                elements.poseGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üßç</div>
                        <p>${state.poses.length === 0 ? 'No poses yet. Upload some images to get started!' : 'No poses match the current filters.'}</p>
                    </div>
                `;
                return;
            }

            elements.poseGrid.innerHTML = filtered.map(pose => {
                const tags = getPoseTags(pose);
                const imageSrc = pose.imagePath || pose.image;
                const isFileBased = pose.imagePath?.startsWith('/assets/');
                return `
                <div class="pose-card">
                    <img src="${imageSrc}" alt="Pose" class="pose-image" onclick="viewPose('${pose.id}')">
                    <div class="pose-info">
                        <span class="pose-gender ${pose.gender}">${pose.gender}</span>
                        <div class="pose-categories">
                            ${tags.slice(0, 4).map(tag => `<span class="pose-category">${formatTag(tag)}</span>`).join('')}
                            ${tags.length > 4 ? `<span class="pose-category">+${tags.length - 4}</span>` : ''}
                        </div>
                        <div class="pose-description">${pose.description || 'No description'}</div>
                        <div class="pose-actions">
                            <button class="pose-action-btn" onclick="editPose('${pose.id}')">Edit</button>
                            ${!isFileBased ? `<button class="pose-action-btn delete" onclick="deletePose('${pose.id}')">Delete</button>` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Make functions global for onclick handlers
        window.viewPose = viewPose;
        window.editPose = editPose;
        window.deletePose = deletePose;

        // Initialize
        init();
    </script>
</body>
</html>
