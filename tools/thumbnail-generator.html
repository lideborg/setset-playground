<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light">
    <title>Thumbnail Generator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¬</text></svg>">
    <link rel="stylesheet" href="/shared/css/tokens.css">
    <link rel="stylesheet" href="/shared/css/base.css">
    <link rel="stylesheet" href="/shared/css/components.css">
    <style>
        :root {
            color-scheme: light only;
        }

        .container {
            max-width: 1400px;
        }

        /* Talent Grid */
        .talent-section {
            margin-bottom: var(--space-lg);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .section-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--carbon);
        }

        .selection-controls {
            display: flex;
            gap: var(--space-sm);
        }

        .talent-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: var(--space-sm);
        }

        .talent-card {
            position: relative;
            aspect-ratio: 3/4;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all var(--transition-fast);
        }

        .talent-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .talent-card:hover {
            border-color: var(--ash-grey);
        }

        .talent-card.selected {
            border-color: var(--jet);
        }

        .talent-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: var(--jet);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .talent-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 6px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            font-size: 11px;
            font-weight: 500;
            text-align: center;
        }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .setting-section {
            background: var(--off-white);
            padding: var(--space-md);
            border-radius: var(--radius-md);
        }

        .setting-title {
            font-size: var(--text-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--carbon);
            margin-bottom: var(--space-sm);
        }

        .setting-toggle {
            display: flex;
            gap: var(--space-xs);
            flex-wrap: wrap;
        }

        .setting-toggle .btn {
            flex: 1;
            min-width: 80px;
        }

        .framing-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-xs);
        }

        .framing-grid .btn {
            font-size: 12px;
            padding: 10px 8px;
        }

        /* Generate Section */
        .generate-section {
            text-align: center;
            margin-bottom: var(--space-lg);
        }

        .calc-display {
            font-size: var(--text-md);
            color: var(--carbon);
            margin-bottom: var(--space-sm);
        }

        /* Progress */
        .progress-section {
            display: none;
            margin-bottom: var(--space-lg);
            padding: var(--space-lg);
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gainsboro);
        }

        .progress-section.visible {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .progress-title {
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--slate);
        }

        .progress-count {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--jet);
        }

        .progress-bar-container {
            height: 8px;
            background: var(--off-white);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--jet);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Results */
        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-md);
        }

        .result-card {
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--gainsboro);
            transition: all var(--transition-fast);
        }

        .result-card:hover {
            border-color: var(--jet);
        }

        .result-card img {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            display: block;
        }

        .result-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: var(--space-sm);
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .result-card:hover .result-overlay {
            opacity: 1;
        }

        .result-info {
            color: white;
            font-size: 11px;
            margin-bottom: 6px;
        }

        .result-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .result-btn {
            flex: 1;
            padding: 6px 10px;
            background: var(--white);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .result-btn:hover {
            background: var(--jet);
            color: var(--white);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <h1>Thumbnail Generator</h1>
            <p class="hero-subtitle">Generate campaign-style editorial images from your model portraits for thumbnails and videos</p>
        </div>

        <!-- Talent Selection -->
        <div class="talent-section">
            <div class="section-header">
                <div class="section-title">Select Models (<span id="selected-count">0</span>/32)</div>
                <div class="selection-controls">
                    <button class="btn btn--sm" onclick="selectAll()">Select All</button>
                    <button class="btn btn--sm" onclick="selectNone()">Clear</button>
                </div>
            </div>
            <div class="talent-grid" id="talent-grid"></div>
        </div>

        <!-- Settings -->
        <div class="settings-grid">
            <div class="setting-section">
                <div class="setting-title">Framing</div>
                <div class="framing-grid">
                    <button class="btn btn--toggle" data-framing="extreme-closeup">Extreme Close-Up</button>
                    <button class="btn btn--toggle" data-framing="closeup">Close-Up</button>
                    <button class="btn btn--toggle active" data-framing="headshot">Headshot</button>
                    <button class="btn btn--toggle" data-framing="half-body">Half Body</button>
                    <button class="btn btn--toggle" data-framing="three-quarter">Three Quarter</button>
                    <button class="btn btn--toggle" data-framing="full-body">Full Body</button>
                </div>
            </div>

            <div class="setting-section">
                <div class="setting-title">Mood Selection</div>
                <div class="setting-toggle">
                    <button class="btn btn--toggle active" data-mood-mode="random">Random (Variety)</button>
                    <button class="btn btn--toggle" data-mood-mode="single">Single Mood</button>
                </div>
                <div id="mood-selector" style="display: none; margin-top: 12px;">
                    <select id="mood-select" style="width:100%; padding:10px; border-radius:4px; border:1px solid var(--gainsboro);">
                    </select>
                </div>
            </div>

            <div class="setting-section">
                <div class="setting-title">Images Per Model</div>
                <div class="setting-toggle">
                    <button class="btn btn--toggle active" data-count="1">1</button>
                    <button class="btn btn--toggle" data-count="2">2</button>
                    <button class="btn btn--toggle" data-count="3">3</button>
                    <button class="btn btn--toggle" data-count="5">5</button>
                </div>
            </div>

            <div class="setting-section">
                <div class="setting-title">Resolution</div>
                <div class="setting-toggle">
                    <button class="btn btn--toggle" data-resolution="1K">1K</button>
                    <button class="btn btn--toggle active" data-resolution="2K">2K</button>
                </div>
            </div>

            <div class="setting-section">
                <div class="setting-title">Aspect Ratio</div>
                <div class="setting-toggle">
                    <button class="btn btn--toggle" data-aspect="1:1">1:1</button>
                    <button class="btn btn--toggle active" data-aspect="3:4">3:4</button>
                    <button class="btn btn--toggle" data-aspect="4:3">4:3</button>
                    <button class="btn btn--toggle" data-aspect="9:16">9:16</button>
                </div>
            </div>
        </div>

        <!-- Generate -->
        <div class="generate-section">
            <div class="calc-display" id="calc-display">Select models to generate thumbnails</div>
            <button class="btn btn--primary btn--lg" id="generate-btn" disabled>Generate Thumbnails</button>
        </div>

        <!-- Progress -->
        <div class="progress-section" id="progress-section">
            <div class="progress-header">
                <span class="progress-title">Generating</span>
                <span class="progress-count" id="progress-count">0 / 0</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <!-- Results -->
        <div class="results-section" id="results-section">
            <div class="results-header">
                <h2>Generated Thumbnails</h2>
                <button class="btn" onclick="downloadAll()">Download All</button>
            </div>
            <div class="results-grid" id="results-grid"></div>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-content">
            <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
            <div class="lightbox-left">
                <img src="" alt="" class="lightbox-image" id="lightbox-image">
            </div>
            <div class="lightbox-right">
                <div class="lightbox-section">
                    <h3 class="lightbox-section-title">Model</h3>
                    <p id="lightbox-model"></p>
                </div>
                <div class="lightbox-section">
                    <h3 class="lightbox-section-title">Mood</h3>
                    <p id="lightbox-mood"></p>
                </div>
                <div class="lightbox-section">
                    <h3 class="lightbox-section-title">Prompt</h3>
                    <p class="lightbox-prompt-text" id="lightbox-prompt"></p>
                </div>
                <button class="lightbox-download" id="lightbox-download">Download Image</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/shared/js/models.js"></script>
    <script src="/shared/js/utils.js"></script>
    <script src="/shared/js/api.js"></script>
    <script src="/shared/data/editorial-moods.js"></script>
    <script>
        // Talent data - all 32 models
        const TALENT = [
            { id: 1, name: 'James Wilson', gender: 'male' },
            { id: 2, name: 'Maya Johnson', gender: 'female' },
            { id: 3, name: 'River Blake', gender: 'male' },
            { id: 4, name: 'Emma Sullivan', gender: 'female' },
            { id: 5, name: 'Marcus Brown', gender: 'male' },
            { id: 6, name: 'Zara Mitchell', gender: 'female' },
            { id: 7, name: 'Sophia Anderson', gender: 'female' },
            { id: 8, name: 'Liam Garcia', gender: 'male' },
            { id: 9, name: 'Nina Davis', gender: 'female' },
            { id: 10, name: 'Ava Martinez', gender: 'female' },
            { id: 11, name: 'Luna Park', gender: 'female' },
            { id: 12, name: 'Noah Chen', gender: 'male' },
            { id: 13, name: 'Mia Parker', gender: 'female' },
            { id: 14, name: 'Riley Morgan', gender: 'female' },
            { id: 15, name: 'Jordan Lee', gender: 'male' },
            { id: 16, name: 'Isabella Rodriguez', gender: 'female' },
            { id: 17, name: 'Quinn Santos', gender: 'female' },
            { id: 18, name: 'Casey White', gender: 'male' },
            { id: 19, name: 'Sam Wilson', gender: 'male' },
            { id: 20, name: 'Drew Martinez', gender: 'male' },
            { id: 21, name: 'Avery Taylor', gender: 'female' },
            { id: 22, name: 'Parker Miller', gender: 'male' },
            { id: 23, name: 'Morgan Kim', gender: 'female' },
            { id: 24, name: 'Andre Jackson', gender: 'male' },
            { id: 25, name: 'Damon Carter', gender: 'male' },
            { id: 26, name: 'Nikolai Volkov', gender: 'male' },
            { id: 27, name: 'Sofia Rodriguez', gender: 'female' },
            { id: 28, name: 'Finn O\'Connor', gender: 'male' },
            { id: 29, name: 'Clara Devereaux', gender: 'female' },
            { id: 30, name: 'Zoe Washington', gender: 'female' },
            { id: 31, name: 'Emily Hart', gender: 'female' },
            { id: 32, name: 'Alex Stone', gender: 'male' }
        ];

        // State
        const state = {
            selectedTalent: [],
            framing: 'headshot',
            moodMode: 'random',
            selectedMood: null,
            imagesPerModel: 1,
            resolution: '2K',
            aspectRatio: '3:4',
            results: [],
            lightboxIndex: 0
        };

        // Elements
        const elements = {
            talentGrid: document.getElementById('talent-grid'),
            selectedCount: document.getElementById('selected-count'),
            calcDisplay: document.getElementById('calc-display'),
            generateBtn: document.getElementById('generate-btn'),
            moodSelector: document.getElementById('mood-selector'),
            moodSelect: document.getElementById('mood-select'),
            progressSection: document.getElementById('progress-section'),
            progressCount: document.getElementById('progress-count'),
            progressBar: document.getElementById('progress-bar'),
            resultsSection: document.getElementById('results-section'),
            resultsGrid: document.getElementById('results-grid'),
            lightbox: document.getElementById('lightbox'),
            lightboxImage: document.getElementById('lightbox-image'),
            lightboxModel: document.getElementById('lightbox-model'),
            lightboxMood: document.getElementById('lightbox-mood'),
            lightboxPrompt: document.getElementById('lightbox-prompt'),
            lightboxDownload: document.getElementById('lightbox-download')
        };

        // Initialize
        function init() {
            renderTalentGrid();
            populateMoodSelect();

            // Framing toggle
            document.querySelectorAll('[data-framing]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-framing]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.framing = btn.dataset.framing;
                });
            });

            // Mood mode toggle
            document.querySelectorAll('[data-mood-mode]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-mood-mode]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.moodMode = btn.dataset.moodMode;
                    elements.moodSelector.style.display = state.moodMode === 'single' ? 'block' : 'none';
                });
            });

            // Mood select
            elements.moodSelect.addEventListener('change', () => {
                state.selectedMood = elements.moodSelect.value;
            });

            // Images per model toggle
            document.querySelectorAll('[data-count]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-count]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.imagesPerModel = parseInt(btn.dataset.count);
                    updateCalc();
                });
            });

            // Resolution toggle
            document.querySelectorAll('[data-resolution]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-resolution]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.resolution = btn.dataset.resolution;
                });
            });

            // Aspect ratio toggle
            document.querySelectorAll('[data-aspect]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-aspect]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.aspectRatio = btn.dataset.aspect;
                });
            });

            // Generate button
            elements.generateBtn.addEventListener('click', generate);

            // Lightbox keyboard nav
            document.addEventListener('keydown', (e) => {
                if (!elements.lightbox.classList.contains('visible')) return;
                if (e.key === 'Escape') closeLightbox();
                else if (e.key === 'ArrowLeft') navigateLightbox(-1);
                else if (e.key === 'ArrowRight') navigateLightbox(1);
            });
        }

        function getTalentImagePath(talent, highRes = false) {
            const imgNum = String(talent.id).padStart(2, '0');
            const imgName = talent.filename || talent.name.replace(/['\s]/g, '');
            if (highRes) {
                return `/shared/images/talent/talent-${imgNum}_${imgName}.png`;
            }
            return `/shared/images/talent/fallback/talent-${imgNum}_${imgName}.jpg`;
        }

        function renderTalentGrid() {
            elements.talentGrid.innerHTML = TALENT.map(talent => {
                const imgPath = getTalentImagePath(talent);

                return `
                    <div class="talent-card" data-talent-id="${talent.id}" onclick="toggleTalent(${talent.id})">
                        <img src="${imgPath}" alt="${talent.name}" onerror="this.src='/shared/images/talent/placeholder.png'">
                        <div class="talent-name">${talent.name}</div>
                    </div>
                `;
            }).join('');
        }

        function populateMoodSelect() {
            // Combine all moods for the dropdown
            const allMoods = [
                ...EDITORIAL_MOODS_FEMALE.map(m => ({ ...m, gender: 'female' })),
                ...EDITORIAL_MOODS_MALE.map(m => ({ ...m, gender: 'male' }))
            ];

            // Remove duplicates by id (keep female version)
            const uniqueMoods = [];
            const seen = new Set();
            allMoods.forEach(mood => {
                if (!seen.has(mood.id)) {
                    seen.add(mood.id);
                    uniqueMoods.push(mood);
                }
            });

            elements.moodSelect.innerHTML = uniqueMoods.map(mood =>
                `<option value="${mood.id}">${mood.name}</option>`
            ).join('');

            state.selectedMood = uniqueMoods[0]?.id;
        }

        function toggleTalent(id) {
            const card = document.querySelector(`[data-talent-id="${id}"]`);
            const idx = state.selectedTalent.indexOf(id);

            if (idx === -1) {
                state.selectedTalent.push(id);
                card.classList.add('selected');
            } else {
                state.selectedTalent.splice(idx, 1);
                card.classList.remove('selected');
            }

            updateCalc();
        }

        function selectAll() {
            state.selectedTalent = TALENT.map(t => t.id);
            document.querySelectorAll('.talent-card').forEach(card => card.classList.add('selected'));
            updateCalc();
        }

        function selectNone() {
            state.selectedTalent = [];
            document.querySelectorAll('.talent-card').forEach(card => card.classList.remove('selected'));
            updateCalc();
        }

        function updateCalc() {
            const count = state.selectedTalent.length;
            const totalImages = count * state.imagesPerModel;
            elements.selectedCount.textContent = count;

            if (count === 0) {
                elements.calcDisplay.textContent = 'Select models to generate thumbnails';
                elements.generateBtn.disabled = true;
            } else {
                const cost = (totalImages * 0.15).toFixed(2);
                elements.calcDisplay.textContent = `${count} models Ã— ${state.imagesPerModel} = ${totalImages} images @ $0.15 each = $${cost}`;
                elements.generateBtn.disabled = false;
            }
        }

        function getMoodForTalent(talent) {
            const pool = talent.gender === 'male' ? EDITORIAL_MOODS_MALE : EDITORIAL_MOODS_FEMALE;

            if (state.moodMode === 'random') {
                return pool[Math.floor(Math.random() * pool.length)];
            } else {
                // Find the mood by id in the gender-appropriate pool
                return pool.find(m => m.id === state.selectedMood) || pool[0];
            }
        }

        function getFramingPrompt() {
            const framings = {
                'extreme-closeup': 'extreme close-up filling frame with face, eyes and partial features only',
                'closeup': 'close-up portrait head and shoulders tightly framed',
                'headshot': 'classic headshot portrait from chest up',
                'half-body': 'half-body portrait from waist up showing torso and arms',
                'three-quarter': 'three-quarter body shot from thighs up',
                'full-body': 'full body portrait showing complete figure head to toe'
            };
            return framings[state.framing] || framings['headshot'];
        }

        function buildPrompt(talent, mood) {
            const framing = getFramingPrompt();
            return `Editorial fashion portrait of this exact person. ${framing}. ${mood.prompt}. High-end fashion photography, professional studio quality.`;
        }

        async function generate() {
            const totalImages = state.selectedTalent.length * state.imagesPerModel;

            console.log('\nðŸŽ¬ Starting thumbnail generation...');
            console.log(`   Models: ${state.selectedTalent.length}`);
            console.log(`   Images per model: ${state.imagesPerModel}`);
            console.log(`   Total: ${totalImages}`);
            console.log(`   Mood mode: ${state.moodMode}`);
            console.log(`   Framing: ${state.framing}`);
            console.log(`   Resolution: ${state.resolution}`);
            console.log(`   Aspect Ratio: ${state.aspectRatio}`);

            state.results = [];
            elements.resultsGrid.innerHTML = '';

            // Show progress
            elements.progressSection.classList.add('visible');
            elements.progressCount.textContent = `0 / ${totalImages}`;
            elements.progressBar.style.width = '0%';

            let completed = 0;
            const allPromises = [];

            // Build all tasks
            for (const talentId of state.selectedTalent) {
                const talent = TALENT.find(t => t.id === talentId);
                const imgPath = getTalentImagePath(talent, true); // Use high-res PNG for API

                for (let i = 0; i < state.imagesPerModel; i++) {
                    const mood = getMoodForTalent(talent);
                    const prompt = buildPrompt(talent, mood);

                    const promise = (async () => {
                        const start = performance.now();
                        try {
                            // Fetch the image and convert to base64
                            const imgResponse = await fetch(imgPath);
                            const imgBlob = await imgResponse.blob();
                            const base64 = await blobToBase64(imgBlob);

                            // Upload to get a hosted URL
                            const uploadResult = await api.uploadBase64(base64);
                            const imageUrl = uploadResult.url;

                            // Get dimensions from ASPECT_SIZES
                            const imageSize = getAspectSize(state.aspectRatio, state.resolution);

                            const params = {
                                prompt: prompt,
                                image_urls: [imageUrl],
                                num_images: 1,
                                image_size: imageSize,
                                output_format: 'png'
                            };

                            const data = await api.remixImage('nanobanana-pro-edit', params);
                            const elapsed = ((performance.now() - start) / 1000).toFixed(2);

                            if (data.images && data.images.length > 0) {
                                console.log(`   [${elapsed}s] âœ… ${talent.name} - ${mood.name}`);
                                state.results.push({
                                    url: data.images[0].url,
                                    prompt: prompt,
                                    talent: talent,
                                    mood: mood,
                                    index: i + 1
                                });
                                renderResults();
                            }
                        } catch (error) {
                            console.error(`   âŒ ${talent.name}: ${error.message}`);
                        }

                        completed++;
                        elements.progressCount.textContent = `${completed} / ${totalImages}`;
                        elements.progressBar.style.width = `${(completed / totalImages) * 100}%`;
                    })();

                    allPromises.push(promise);
                }
            }

            // Execute with concurrency limit
            const MAX_CONCURRENT = 5;
            const executing = new Set();

            for (const promise of allPromises) {
                const wrapped = promise.then(() => executing.delete(wrapped));
                executing.add(wrapped);

                if (executing.size >= MAX_CONCURRENT) {
                    await Promise.race(executing);
                }
            }

            await Promise.all(allPromises);

            console.log(`\nâœ… Generation complete! ${state.results.length}/${totalImages} images created.`);

            // Hide progress, show results
            elements.progressSection.classList.remove('visible');
            elements.resultsSection.classList.add('visible');
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function renderResults() {
            elements.resultsGrid.innerHTML = state.results.map((result, idx) => `
                <div class="result-card" onclick="openLightbox(${idx})">
                    <img src="${result.url}" alt="${result.talent.name}">
                    <div class="result-overlay">
                        <div class="result-info">${result.talent.name} - ${result.mood.name}</div>
                        <div class="result-actions">
                            <button class="result-btn" onclick="event.stopPropagation(); downloadImage(${idx})">Download</button>
                        </div>
                    </div>
                </div>
            `).join('');

            elements.resultsSection.classList.add('visible');
        }

        function openLightbox(idx) {
            state.lightboxIndex = idx;
            updateLightboxContent();
            elements.lightbox.classList.add('visible');
        }

        function closeLightbox() {
            elements.lightbox.classList.remove('visible');
        }

        function navigateLightbox(direction) {
            const newIndex = state.lightboxIndex + direction;
            if (newIndex >= 0 && newIndex < state.results.length) {
                state.lightboxIndex = newIndex;
                updateLightboxContent();
            }
        }

        function updateLightboxContent() {
            const result = state.results[state.lightboxIndex];
            elements.lightboxImage.src = result.url;
            elements.lightboxModel.textContent = result.talent.name;
            elements.lightboxMood.textContent = result.mood.name;
            elements.lightboxPrompt.textContent = result.prompt;
            elements.lightboxDownload.onclick = () => downloadImage(state.lightboxIndex);
        }

        function buildFilename(result, idx) {
            const name = result.talent.name.replace(/\s+/g, '');
            const now = new Date();
            const timestamp = now.toISOString().slice(2, 10).replace(/-/g, '') + '_' +
                             now.toTimeString().slice(0, 5).replace(':', '');
            const num = String(idx + 1).padStart(2, '0');
            return `Setset_thumbnail_${name}_${timestamp}_${num}.png`;
        }

        function downloadImage(idx) {
            const result = state.results[idx];
            downloadFile(result.url, buildFilename(result, idx));
        }

        function downloadAll() {
            state.results.forEach((result, idx) => {
                setTimeout(() => {
                    downloadFile(result.url, buildFilename(result, idx));
                }, idx * 500);
            });
        }

        // Initialize
        init();
    </script>
</body>
</html>
