<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video - Image to Video</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    <link rel="stylesheet" href="/shared/css/tokens.css">
    <link rel="stylesheet" href="/shared/css/base.css">
    <link rel="stylesheet" href="/shared/css/components.css">
    <style>
        .container {
            max-width: 900px;
        }

        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        @media (max-width: 700px) {
            .input-section {
                grid-template-columns: 1fr;
            }
        }

        /* Image upload slots */
        .frame-slot {
            aspect-ratio: 16/9;
            border: 2px dashed var(--gainsboro);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: var(--off-white);
            transition: all var(--transition-fast);
        }

        .frame-slot:hover {
            border-color: var(--ash-grey);
            background: var(--white);
        }

        .frame-slot.filled {
            border-style: solid;
            border-color: var(--jet);
        }

        .frame-slot.filled img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .frame-slot .placeholder {
            text-align: center;
            color: var(--ash-grey);
        }

        .frame-slot .placeholder-icon {
            font-size: 32px;
            margin-bottom: var(--space-xs);
        }

        .frame-slot .placeholder-text {
            font-size: var(--text-sm);
            font-weight: 500;
        }

        .frame-slot .placeholder-hint {
            font-size: var(--text-xs);
            margin-top: 4px;
        }

        .frame-slot .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(0,0,0,0.7);
            color: var(--white);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .frame-slot.filled:hover .remove-btn {
            display: flex;
        }

        .frame-slot.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .frame-label {
            font-size: var(--text-sm);
            font-weight: 600;
            margin-bottom: var(--space-xs);
            color: var(--carbon);
        }

        .frame-label .badge {
            font-size: var(--text-2xs);
            font-weight: 500;
            padding: 2px 6px;
            border-radius: var(--radius-xs);
            margin-left: 6px;
        }

        .frame-label .badge.required {
            background: var(--jet);
            color: var(--white);
        }

        .frame-label .badge.optional {
            background: var(--off-white);
            color: var(--slate);
        }

        /* Settings row */
        .settings-section {
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .setting-row {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            flex-wrap: wrap;
            margin-bottom: var(--space-md);
        }

        .setting-row:last-child {
            margin-bottom: 0;
        }

        .setting-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .setting-label {
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--slate);
            min-width: 60px;
        }

        /* Model tabs */
        .model-tabs {
            display: flex;
            gap: var(--space-xs);
        }

        .model-tab {
            padding: 8px 16px;
            font-size: var(--text-sm);
            font-weight: 500;
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            background: var(--off-white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .model-tab:hover {
            border-color: var(--ash-grey);
        }

        .model-tab.active {
            background: var(--jet);
            color: var(--white);
            border-color: var(--jet);
        }

        .model-tab .model-badge {
            font-size: var(--text-2xs);
            opacity: 0.7;
            margin-left: 4px;
        }

        /* Toggle buttons */
        .toggle-buttons {
            display: flex;
            gap: 4px;
        }

        .toggle-btn {
            padding: 6px 12px;
            font-size: var(--text-xs);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            background: var(--off-white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .toggle-btn:hover {
            border-color: var(--ash-grey);
        }

        .toggle-btn.active {
            background: var(--jet);
            color: var(--white);
            border-color: var(--jet);
        }

        /* Checkbox toggle */
        .checkbox-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-toggle input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-toggle span {
            font-size: var(--text-sm);
            color: var(--slate);
        }

        /* Prompt */
        .prompt-section {
            margin-bottom: var(--space-lg);
        }

        .prompt-textarea {
            width: 100%;
            min-height: 100px;
            padding: var(--space-sm);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            font-family: var(--font-sans);
            font-size: var(--text-sm);
            resize: vertical;
            transition: border-color var(--transition-fast);
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--jet);
        }

        .prompt-hint {
            font-size: var(--text-xs);
            color: var(--ash-grey);
            margin-top: var(--space-xs);
        }

        /* Generate button */
        .generate-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-lg);
        }

        .generate-btn {
            padding: 14px 32px;
            font-size: 15px;
            min-width: 180px;
        }

        .generate-info {
            font-size: var(--text-sm);
            color: var(--slate);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results */
        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .results-header h2 {
            font-size: var(--text-lg);
            font-weight: 600;
        }

        .videos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--space-md);
        }

        .video-card {
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .video-card video {
            width: 100%;
            display: block;
            background: var(--carbon);
        }

        .video-card-footer {
            padding: var(--space-sm);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-sm);
        }

        .video-card-prompt {
            font-size: var(--text-xs);
            color: var(--slate);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .video-card-cost {
            font-size: var(--text-xs);
            color: var(--ash-grey);
            margin-left: var(--space-xs);
        }

        .video-card.generating {
            position: relative;
        }

        .video-card.generating::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--off-white);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .video-card .generating-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--off-white);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .video-card .generating-spinner {
            width: 32px;
            height: 32px;
            border: 2px solid var(--gainsboro);
            border-top-color: var(--jet);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-xs);
        }

        .video-card .generating-text {
            font-size: var(--text-sm);
            color: var(--slate);
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <h1>Image to Video</h1>
            <p class="hero-subtitle">Transform images into video using Kling AI</p>
        </div>

        <!-- Model Selection -->
        <div class="settings-section">
            <div class="setting-row">
                <div class="setting-group">
                    <span class="setting-label">Model</span>
                    <div class="model-tabs">
                        <button class="model-tab active" data-model="v1.6">v1.6 Pro <span class="model-badge">First+Last Frame</span></button>
                        <button class="model-tab" data-model="v2.6">v2.6 Pro <span class="model-badge">Better Quality + Audio</span></button>
                    </div>
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-group">
                    <span class="setting-label">Duration</span>
                    <div class="toggle-buttons" id="duration-buttons">
                        <button class="toggle-btn active" data-value="5">5 sec</button>
                        <button class="toggle-btn" data-value="10">10 sec</button>
                    </div>
                </div>

                <div class="setting-group" id="aspect-ratio-group">
                    <span class="setting-label">Aspect</span>
                    <div class="toggle-buttons" id="aspect-buttons">
                        <button class="toggle-btn active" data-value="16:9">16:9</button>
                        <button class="toggle-btn" data-value="9:16">9:16</button>
                        <button class="toggle-btn" data-value="1:1">1:1</button>
                    </div>
                </div>

                <div class="setting-group" id="audio-group" style="display: none;">
                    <label class="checkbox-toggle">
                        <input type="checkbox" id="generate-audio" checked>
                        <span>Generate Audio</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Image Inputs -->
        <div class="input-section">
            <div class="frame-upload">
                <div class="frame-label">
                    First Frame <span class="badge required">Required</span>
                </div>
                <div class="frame-slot" id="first-frame-slot">
                    <div class="placeholder">
                        <div class="placeholder-icon">üñºÔ∏è</div>
                        <div class="placeholder-text">Click or drop image</div>
                        <div class="placeholder-hint">Starting frame of video</div>
                    </div>
                    <button class="remove-btn">&times;</button>
                </div>
                <input type="file" id="first-frame-input" accept="image/*">
            </div>

            <div class="frame-upload" id="last-frame-container">
                <div class="frame-label">
                    Last Frame <span class="badge optional">Optional</span>
                </div>
                <div class="frame-slot" id="last-frame-slot">
                    <div class="placeholder">
                        <div class="placeholder-icon">üé¨</div>
                        <div class="placeholder-text">Click or drop image</div>
                        <div class="placeholder-hint">Ending frame (v1.6 only)</div>
                    </div>
                    <button class="remove-btn">&times;</button>
                </div>
                <input type="file" id="last-frame-input" accept="image/*">
            </div>
        </div>

        <!-- Prompt -->
        <div class="prompt-section">
            <textarea class="prompt-textarea" id="prompt" placeholder="One prompt per line = one video&#10;&#10;The person slowly turns their head and smiles&#10;Hair blows gently in the wind&#10;Camera slowly zooms in on face"></textarea>
            <p class="prompt-hint">Each line creates a separate video. Describe motion, actions, and camera movement.</p>
        </div>

        <!-- Generate -->
        <div class="generate-section">
            <div class="generate-info" id="generate-info">
                Upload an image to generate video
            </div>
            <button class="btn btn--primary generate-btn" id="generate-btn" disabled>
                Generate Video
            </button>
        </div>

        <!-- Results -->
        <div class="results-section" id="results-section">
            <div class="results-header">
                <h2>Results</h2>
            </div>
            <div class="videos-grid" id="videos-grid"></div>
        </div>
    </div>

    <script src="/shared/js/utils.js"></script>
    <script src="/shared/js/api.js"></script>
    <script>
        // State
        const state = {
            model: 'v1.6',
            duration: '5',
            aspectRatio: '16:9',
            generateAudio: true,
            firstFrame: null,
            lastFrame: null,
            results: [] // Array of { url, prompt }
        };

        // Kling pricing (approximate from fal.ai)
        // v1.6 Pro: ~$0.50 for 5s, ~$1.00 for 10s
        // v2.6 Pro: ~$0.65 for 5s, ~$1.30 for 10s (higher quality + audio)
        function calculateVideoCost() {
            const duration = parseInt(state.duration);
            if (state.model === 'v2.6') {
                return duration === 5 ? 0.65 : 1.30;
            } else {
                return duration === 5 ? 0.50 : 1.00;
            }
        }

        // DOM Elements
        const elements = {
            modelTabs: document.querySelectorAll('.model-tab'),
            durationButtons: document.querySelectorAll('#duration-buttons .toggle-btn'),
            aspectButtons: document.querySelectorAll('#aspect-buttons .toggle-btn'),
            aspectGroup: document.getElementById('aspect-ratio-group'),
            audioGroup: document.getElementById('audio-group'),
            generateAudio: document.getElementById('generate-audio'),
            firstFrameSlot: document.getElementById('first-frame-slot'),
            firstFrameInput: document.getElementById('first-frame-input'),
            lastFrameContainer: document.getElementById('last-frame-container'),
            lastFrameSlot: document.getElementById('last-frame-slot'),
            lastFrameInput: document.getElementById('last-frame-input'),
            prompt: document.getElementById('prompt'),
            generateBtn: document.getElementById('generate-btn'),
            generateInfo: document.getElementById('generate-info'),
            resultsSection: document.getElementById('results-section'),
            videosGrid: document.getElementById('videos-grid')
        };

        // Initialize
        function init() {
            setupEventListeners();
            updateUI();
        }

        function setupEventListeners() {
            // Model tabs
            elements.modelTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    elements.modelTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.model = tab.dataset.model;
                    updateUI();
                });
            });

            // Duration buttons
            elements.durationButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.durationButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.duration = btn.dataset.value;
                });
            });

            // Aspect ratio buttons
            elements.aspectButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.aspectButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.aspectRatio = btn.dataset.value;
                });
            });

            // Audio toggle
            elements.generateAudio.addEventListener('change', () => {
                state.generateAudio = elements.generateAudio.checked;
            });

            // First frame upload
            elements.firstFrameSlot.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    state.firstFrame = null;
                    renderFrameSlot('first');
                    updateUI();
                } else if (!state.firstFrame) {
                    elements.firstFrameInput.click();
                }
            });

            elements.firstFrameInput.addEventListener('change', (e) => {
                handleFileUpload(e.target.files[0], 'first');
                e.target.value = '';
            });

            // Last frame upload
            elements.lastFrameSlot.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    state.lastFrame = null;
                    renderFrameSlot('last');
                    updateUI();
                } else if (!state.lastFrame) {
                    elements.lastFrameInput.click();
                }
            });

            elements.lastFrameInput.addEventListener('change', (e) => {
                handleFileUpload(e.target.files[0], 'last');
                e.target.value = '';
            });

            // Drag and drop
            [elements.firstFrameSlot, elements.lastFrameSlot].forEach((slot, i) => {
                const type = i === 0 ? 'first' : 'last';
                slot.addEventListener('dragover', (e) => e.preventDefault());
                slot.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        handleFileUpload(file, type);
                    }
                });
            });

            // Clipboard paste - global listener
            document.addEventListener('paste', (e) => {
                const items = e.clipboardData?.items;
                if (!items) return;

                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (file) {
                            // Paste to first frame if empty, otherwise to last frame
                            const targetType = !state.firstFrame ? 'first' :
                                              (state.model === 'v1.6' && !state.lastFrame ? 'last' : 'first');
                            handleFileUpload(file, targetType);
                            console.log(`üìã Pasted image to ${targetType} frame`);
                        }
                        break;
                    }
                }
            });

            // Generate button
            elements.generateBtn.addEventListener('click', handleGenerate);
        }

        // Compress image to fit within size limit (10MB for Kling)
        async function compressImage(dataUrl, maxSizeBytes = 9 * 1024 * 1024) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Scale down if very large
                    const maxDimension = 2048;
                    if (width > maxDimension || height > maxDimension) {
                        const scale = maxDimension / Math.max(width, height);
                        width = Math.round(width * scale);
                        height = Math.round(height * scale);
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Try different quality levels until under size limit
                    let quality = 0.92;
                    let result = canvas.toDataURL('image/jpeg', quality);

                    while (result.length > maxSizeBytes * 1.37 && quality > 0.3) { // base64 is ~37% larger
                        quality -= 0.1;
                        result = canvas.toDataURL('image/jpeg', quality);
                    }

                    console.log(`üì¶ Compressed image: ${(result.length / 1024 / 1024).toFixed(2)}MB at quality ${quality.toFixed(1)}`);
                    resolve(result);
                };
                img.src = dataUrl;
            });
        }

        async function handleFileUpload(file, type) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                let dataUrl = e.target.result;

                // Compress if over 8MB
                if (dataUrl.length > 8 * 1024 * 1024) {
                    console.log(`üîÑ Image too large (${(dataUrl.length / 1024 / 1024).toFixed(2)}MB), compressing...`);
                    dataUrl = await compressImage(dataUrl);
                }

                if (type === 'first') {
                    state.firstFrame = { file, url: dataUrl };
                } else {
                    state.lastFrame = { file, url: dataUrl };
                }
                renderFrameSlot(type);
                updateUI();
            };
            reader.readAsDataURL(file);
        }

        function renderFrameSlot(type) {
            const slot = type === 'first' ? elements.firstFrameSlot : elements.lastFrameSlot;
            const frame = type === 'first' ? state.firstFrame : state.lastFrame;

            if (frame) {
                slot.classList.add('filled');
                slot.innerHTML = `
                    <img src="${frame.url}" alt="${type} frame">
                    <button class="remove-btn">&times;</button>
                `;
            } else {
                slot.classList.remove('filled');
                const icon = type === 'first' ? 'üñºÔ∏è' : 'üé¨';
                const hint = type === 'first' ? 'Starting frame of video' : 'Ending frame (v1.6 only)';
                slot.innerHTML = `
                    <div class="placeholder">
                        <div class="placeholder-icon">${icon}</div>
                        <div class="placeholder-text">Click or drop image</div>
                        <div class="placeholder-hint">${hint}</div>
                    </div>
                    <button class="remove-btn">&times;</button>
                `;
            }
        }

        function updateUI() {
            const isV16 = state.model === 'v1.6';

            // Show/hide model-specific options
            elements.aspectGroup.style.display = isV16 ? 'flex' : 'none';
            elements.audioGroup.style.display = isV16 ? 'none' : 'flex';

            // Enable/disable last frame based on model
            if (isV16) {
                elements.lastFrameContainer.style.opacity = '1';
                elements.lastFrameSlot.classList.remove('disabled');
            } else {
                elements.lastFrameContainer.style.opacity = '0.4';
                elements.lastFrameSlot.classList.add('disabled');
                state.lastFrame = null;
                renderFrameSlot('last');
            }

            // Count prompts (one per line)
            const prompts = elements.prompt.value.split('\n').filter(line => line.trim());
            const promptCount = prompts.length;

            // Update generate button and info
            const hasFirstFrame = !!state.firstFrame;

            elements.generateBtn.disabled = !hasFirstFrame;

            if (!hasFirstFrame) {
                elements.generateInfo.textContent = 'Upload an image to generate video';
            } else {
                const modelInfo = isV16 ? 'Kling v1.6 Pro' : 'Kling v2.6 Pro';
                const frameInfo = state.lastFrame ? ' (first + last frame)' : '';
                const videoCount = promptCount > 0 ? promptCount : 1;
                const costPerVideo = calculateVideoCost();
                const totalCost = (costPerVideo * videoCount).toFixed(2);
                elements.generateInfo.textContent = `${modelInfo} ‚Ä¢ ${state.duration}s${frameInfo} ‚Ä¢ ${videoCount} video${videoCount > 1 ? 's' : ''} ‚Ä¢ $${costPerVideo.toFixed(2)}/video ‚Ä¢ $${totalCost} total`;
            }
        }

        async function handleGenerate() {
            if (!state.firstFrame) return;

            // Parse prompts - one per line
            const promptText = elements.prompt.value.trim();
            const prompts = promptText ? promptText.split('\n').filter(line => line.trim()) : ['Subtle natural movement and gentle motion'];

            // Reset results
            state.results = [];
            elements.generateBtn.disabled = true;

            // Calculate cost for display
            const costPerVideo = calculateVideoCost();

            // Show results section with placeholders
            elements.resultsSection.classList.add('visible');
            elements.videosGrid.innerHTML = prompts.map((prompt, i) => `
                <div class="video-card generating" id="video-card-${i}">
                    <div class="generating-overlay">
                        <div class="generating-spinner"></div>
                        <div class="generating-text">Generating...</div>
                    </div>
                    <video style="aspect-ratio: 16/9;"></video>
                    <div class="video-card-footer">
                        <span class="video-card-prompt" title="${prompt}">${prompt}</span>
                        <span class="video-card-cost">$${costPerVideo.toFixed(2)}</span>
                        <button class="btn btn--sm" disabled>Download</button>
                    </div>
                </div>
            `).join('');

            try {
                // Upload first frame
                const firstFrameResult = await api.uploadBase64(state.firstFrame.url);
                const imageUrl = firstFrameResult.url;

                // Upload last frame if present (v1.6 only)
                let tailImageUrl = null;
                if (state.model === 'v1.6' && state.lastFrame) {
                    const lastFrameResult = await api.uploadBase64(state.lastFrame.url);
                    tailImageUrl = lastFrameResult.url;
                }

                // Generate all videos in parallel
                const generatePromises = prompts.map(async (prompt, index) => {
                    try {
                        // Build request
                        const params = {
                            model: state.model,
                            image_url: imageUrl,
                            prompt: prompt.trim(),
                            duration: state.duration,
                            falKey: api.getFalKey()
                        };

                        if (state.model === 'v1.6') {
                            if (tailImageUrl) params.tail_image_url = tailImageUrl;
                            params.aspect_ratio = state.aspectRatio;
                        } else {
                            params.generate_audio = state.generateAudio;
                        }

                        // Call API
                        const response = await fetch('/api/video', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(params)
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || 'Video generation failed');
                        }

                        const videoUrl = data.video?.url || data.url;
                        if (videoUrl) {
                            // Update the card with the video
                            const card = document.getElementById(`video-card-${index}`);
                            if (card) {
                                card.classList.remove('generating');
                                const overlay = card.querySelector('.generating-overlay');
                                if (overlay) overlay.remove();

                                const video = card.querySelector('video');
                                video.src = videoUrl;
                                video.controls = true;
                                video.loop = true;

                                const downloadBtn = card.querySelector('.btn');
                                downloadBtn.disabled = false;
                                downloadBtn.onclick = () => {
                                    const now = new Date();
                                    const timestamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
                                    downloadFile(videoUrl, `Setset_Video_${timestamp}_${index + 1}.mp4`);
                                };
                            }

                            state.results.push({ url: videoUrl, prompt: prompt.trim() });
                        }
                    } catch (error) {
                        console.error(`Generate error for prompt ${index}:`, error);
                        const card = document.getElementById(`video-card-${index}`);
                        if (card) {
                            card.classList.remove('generating');
                            const overlay = card.querySelector('.generating-overlay');
                            if (overlay) {
                                overlay.innerHTML = `<div class="generating-text" style="color: #dc2626;">Failed: ${error.message}</div>`;
                            }
                        }
                    }
                });

                await Promise.all(generatePromises);

            } catch (error) {
                console.error('Generate error:', error);
                alert('Failed to generate videos: ' + error.message);
            } finally {
                elements.generateBtn.disabled = false;
            }
        }

        // Prompt input triggers UI update
        elements.prompt.addEventListener('input', updateUI);

        // Initialize
        init();
    </script>
</body>
</html>
