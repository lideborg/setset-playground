<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ron Dorff - Fearless Summer</title>
    <link rel="stylesheet" href="/shared/css/tokens.css">
    <link rel="stylesheet" href="/shared/css/base.css">
    <link rel="stylesheet" href="/shared/css/components.css">
    <style>
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: var(--space-md);
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--gainsboro);
        }

        .page-title {
            font-size: var(--text-lg);
            font-weight: 600;
        }

        .page-subtitle {
            font-size: var(--text-sm);
            color: var(--slate);
            font-weight: 400;
            margin-left: var(--space-sm);
        }

        /* Settings Bar */
        .settings-bar {
            display: flex;
            gap: var(--space-md);
            padding: var(--space-sm);
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            align-items: center;
            flex-wrap: wrap;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: var(--space-2xs);
        }

        .setting-item label {
            font-size: var(--text-xs);
            color: var(--slate);
            white-space: nowrap;
        }

        .styling-controls {
            padding: var(--space-sm);
            margin-bottom: var(--space-sm);
            background: var(--subtle);
            border-radius: var(--radius-sm);
        }

        .btn-group-compact {
            display: flex;
            gap: 2px;
        }

        .btn-group-compact button {
            padding: 4px 8px;
            font-size: var(--text-2xs);
            font-weight: 500;
            border: 1px solid var(--gainsboro);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-group-compact button:first-child {
            border-radius: var(--radius-xs) 0 0 var(--radius-xs);
        }

        .btn-group-compact button:last-child {
            border-radius: 0 var(--radius-xs) var(--radius-xs) 0;
        }

        .btn-group-compact button.active {
            background: var(--jet);
            border-color: var(--jet);
            color: var(--white);
        }

        /* Sliders */
        .slider-container {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .slider-container input[type="range"] {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            background: var(--gainsboro);
            border-radius: 2px;
            outline: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--jet);
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-value {
            font-size: var(--text-xs);
            color: var(--jet);
            font-weight: 600;
            min-width: 32px;
        }

        /* Sections */
        .section {
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-sm);
        }

        .section-title {
            font-size: var(--text-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-subtitle {
            font-size: var(--text-xs);
            color: var(--french-gray);
        }

        /* Section Tabs */
        .section-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: var(--space-sm);
        }

        .section-tab {
            padding: 6px 16px;
            font-size: var(--text-xs);
            font-weight: 500;
            border: 1px solid var(--gainsboro);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .section-tab:first-child {
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        }

        .section-tab:last-child {
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .section-tab.active {
            background: var(--jet);
            border-color: var(--jet);
            color: var(--white);
        }

        .section-tab:hover:not(.active) {
            border-color: var(--slate);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Model Selection */
        .model-grid {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        .model-grid.setset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: var(--space-sm);
        }

        .model-card {
            position: relative;
            width: 120px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .setset-grid .model-card {
            width: auto;
        }

        .model-card img {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            border-radius: var(--radius-sm);
            border: 3px solid transparent;
            transition: all var(--transition-fast);
        }

        .model-card:hover img {
            border-color: var(--slate);
        }

        .model-card.selected img {
            border-color: var(--jet);
        }

        .model-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: var(--jet);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .setset-grid .model-card.selected::after {
            width: 18px;
            height: 18px;
            font-size: 10px;
            top: 4px;
            right: 4px;
        }

        .model-name {
            text-align: center;
            font-size: var(--text-xs);
            margin-top: var(--space-2xs);
            color: var(--slate);
        }

        .setset-grid .model-name {
            font-size: 9px;
        }

        /* Product Grid - New Layout */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--space-sm);
        }

        /* Custom Product Upload Grid - variable columns via CSS var */
        .custom-product-grid {
            display: grid;
            grid-template-columns: repeat(var(--grid-cols, 4), 1fr);
            gap: var(--space-sm);
            max-height: 60vh;
            overflow-y: auto;
            padding-right: var(--space-xs);
        }

        .custom-product-slot {
            aspect-ratio: 3/4;
            border: 2px dashed var(--gainsboro);
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: var(--off-white);
            transition: all var(--transition-fast);
        }

        .custom-product-slot:hover {
            border-color: var(--slate);
        }

        .custom-product-slot.filled {
            border-style: solid;
            border-color: var(--gainsboro);
        }

        .custom-product-slot.filled.has-group {
            border-color: var(--jet);
        }

        .custom-product-slot.paste-ready {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }

        .custom-product-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .custom-product-slot .placeholder {
            text-align: center;
            color: var(--french-gray);
            font-size: var(--text-xs);
        }

        .custom-product-slot .placeholder-hint {
            font-size: var(--text-2xs);
            margin-top: 2px;
            opacity: 0.7;
        }

        .custom-product-slot .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 18px;
            height: 18px;
            background: rgba(0,0,0,0.7);
            color: var(--white);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .custom-product-slot.filled:hover .remove-btn {
            display: flex;
        }

        .custom-product-slot .group-buttons {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 2px;
        }

        .custom-product-slot.filled .group-buttons {
            display: flex;
        }

        .custom-product-slot .group-btn {
            width: 18px;
            height: 18px;
            border: none;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--white);
            opacity: 0.4;
        }

        .custom-product-slot .group-btn:hover {
            opacity: 0.7;
        }

        .custom-product-slot .group-btn.active {
            opacity: 1;
        }

        .custom-product-slot .group-btn.g1 { background: #e74c3c; }
        .custom-product-slot .group-btn.g2 { background: #3498db; }
        .custom-product-slot .group-btn.g3 { background: #2ecc71; }
        .custom-product-slot .group-btn.g4 { background: #9b59b6; }

        .product-card {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .product-card .product-name {
            font-size: var(--text-2xs);
            color: var(--jet);
            text-align: center;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .product-card .product-image {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            border-radius: var(--radius-sm);
            border: 2px solid var(--gainsboro);
            transition: all var(--transition-fast);
        }

        .product-card.has-group .product-image {
            border-color: var(--jet);
        }

        .product-card .group-buttons {
            display: flex;
            gap: 2px;
            margin-top: 4px;
        }

        .product-card .group-btn {
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--white);
            opacity: 0.3;
        }

        .product-card .group-btn:hover {
            opacity: 0.7;
        }

        .product-card .group-btn.active {
            opacity: 1;
        }

        .product-card .group-btn.g1 { background: #e74c3c; }
        .product-card .group-btn.g2 { background: #3498db; }
        .product-card .group-btn.g3 { background: #2ecc71; }
        .product-card .group-btn.g4 { background: #9b59b6; }

        /* Group Notes Section */
        .group-notes-section {
            margin-top: 16px;
            padding: 12px;
            background: var(--off-white);
            border: 1px solid var(--gainsboro);
            border-radius: 4px;
        }
        .group-notes-section h4 {
            margin: 0 0 10px 0;
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--jet);
        }
        .group-notes-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .group-note-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .group-note-item.inactive {
            opacity: 0.4;
        }
        .group-note-label {
            font-size: var(--text-xs);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .group-note-label .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .group-note-label .dot.g1 { background: #e74c3c; }
        .group-note-label .dot.g2 { background: #3498db; }
        .group-note-label .dot.g3 { background: #2ecc71; }
        .group-note-label .dot.g4 { background: #9b59b6; }
        .group-note-input {
            width: 100%;
            padding: 6px 8px;
            font-size: var(--text-xs);
            border: 1px solid var(--gainsboro);
            border-radius: 2px;
            resize: none;
            min-height: 50px;
            font-family: inherit;
        }
        .group-note-input:focus {
            outline: none;
            border-color: var(--slate);
        }
        .group-note-item.inactive .group-note-input {
            background: var(--gainsboro);
        }

        /* Outfit Grid (Styling tab) */
        .outfit-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-sm);
        }

        .outfit-card {
            background: var(--off-white);
            border-radius: var(--radius-sm);
            padding: var(--space-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid transparent;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .outfit-card:hover {
            border-color: var(--gainsboro);
        }

        .outfit-card.selected {
            border-color: var(--jet);
            background: var(--white);
        }

        .outfit-number {
            font-size: var(--text-2xs);
            color: var(--slate);
            margin-bottom: 2px;
        }

        .outfit-name {
            font-size: var(--text-2xs);
            font-weight: 500;
            color: var(--jet);
            margin-bottom: var(--space-xs);
            text-align: center;
            line-height: 1.2;
        }

        .outfit-thumbs {
            display: flex;
            gap: 4px;
            width: 100%;
            justify-content: center;
        }

        .outfit-thumb {
            width: 40px;
            height: 54px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--gainsboro);
        }

        .outfit-thumb.placeholder {
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: #999;
            border: 1px dashed #ccc;
        }

        /* Prompts Panel */
        .prompts-section {
            padding: var(--space-md);
        }

        .prompts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .prompts-code-box {
            background: var(--off-white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: monospace;
            font-size: var(--text-xs);
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .prompts-code-box:hover {
            border-color: var(--jet);
            background: var(--white);
        }

        .prompts-code-box:active {
            transform: scale(0.99);
        }

        .prompt-label {
            font-weight: 600;
            font-size: var(--text-sm);
            margin-bottom: 4px;
            color: var(--jet);
        }

        .prompt-text {
            font-size: var(--text-xs);
            color: var(--slate);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .copy-feedback {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--jet);
            color: var(--white);
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: var(--text-sm);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .copy-feedback.visible {
            opacity: 1;
        }

        /* Environment Upload */
        .environment-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-sm);
        }

        .env-slot {
            aspect-ratio: 4/3;
            border: 2px dashed var(--gainsboro);
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: var(--off-white);
            transition: all var(--transition-fast);
        }

        .env-slot:hover {
            border-color: var(--slate);
        }

        .env-slot.filled {
            border-style: solid;
            border-color: var(--jet);
        }

        .env-slot.paste-ready {
            border-color: #3498db;
            border-width: 2px;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }

        .env-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .env-slot .placeholder {
            text-align: center;
            color: var(--french-gray);
            font-size: var(--text-xs);
        }

        .env-slot .placeholder-hint {
            font-size: var(--text-2xs);
            margin-top: 2px;
            opacity: 0.7;
        }

        .env-slot .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.7);
            color: var(--white);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .env-slot.filled:hover .remove-btn {
            display: flex;
        }

        /* Environment Header Row */
        .env-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .env-toggles {
            display: flex;
            gap: var(--space-md);
        }

        /* Environment Tabs */
        .env-tabs {
            display: flex;
            gap: 2px;
        }

        .env-tab {
            padding: 6px 16px;
            font-size: var(--text-xs);
            font-weight: 500;
            border: 1px solid var(--gainsboro);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .env-tab:first-child {
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        }

        .env-tab:last-child {
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .env-tab.active {
            background: var(--jet);
            border-color: var(--jet);
            color: var(--white);
        }

        .env-tab:hover:not(.active) {
            border-color: var(--slate);
        }

        /* Preset Environment Grid */
        .preset-env-grid {
            display: grid;
            grid-template-columns: repeat(var(--env-grid-cols, 4), 1fr);
            gap: var(--space-md);
            max-height: 500px;
            overflow-y: auto;
            padding: var(--space-sm);
            align-items: start;
        }

        .preset-env-item {
            border-radius: var(--radius-sm);
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all var(--transition-fast);
            background: var(--off-white);
        }

        .preset-env-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        .preset-env-item:hover {
            border-color: var(--slate);
        }

        .preset-env-item.selected {
            border-color: var(--jet);
        }

        .preset-env-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .preset-count {
            font-size: var(--text-xs);
            color: var(--slate);
        }

        .deselect-btn {
            padding: 4px 12px;
            font-size: var(--text-xs);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .deselect-btn:hover {
            border-color: var(--jet);
            color: var(--jet);
        }

        .env-options {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-sm);
            padding-top: var(--space-sm);
            border-top: 1px solid var(--gainsboro);
        }

        /* Additional Prompt Box */
        .prompt-box {
            margin-top: var(--space-sm);
            padding-top: var(--space-sm);
            border-top: 1px solid var(--gainsboro);
        }

        .prompt-box label {
            font-size: var(--text-xs);
            color: var(--slate);
            display: block;
            margin-bottom: var(--space-2xs);
        }

        .prompt-box textarea {
            width: 100%;
            padding: var(--space-xs);
            font-size: var(--text-xs);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            resize: vertical;
            min-height: 50px;
            font-family: inherit;
        }

        .prompt-box textarea:focus {
            outline: none;
            border-color: var(--jet);
        }

        .env-option {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .env-option label {
            font-size: var(--text-xs);
            color: var(--slate);
        }

        .toggle-switch {
            position: relative;
            width: 36px;
            height: 20px;
            background: var(--gainsboro);
            border-radius: 10px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .toggle-switch.active {
            background: var(--jet);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: var(--white);
            border-radius: 50%;
            transition: all var(--transition-fast);
        }

        .toggle-switch.active::after {
            left: 18px;
        }

        /* Generate Bar - Bottom */
        .generate-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-sm) var(--space-md);
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
        }

        .selection-summary {
            font-size: var(--text-sm);
            color: var(--slate);
        }

        .generate-btn {
            padding: 10px 32px;
            font-size: var(--text-sm);
            font-weight: 600;
            background: var(--jet);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--white);
        }

        .generate-btn:hover {
            background: var(--slate);
        }

        .generate-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Progress & Results */
        .progress-section {
            display: none;
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-xs);
        }

        .progress-title {
            font-size: var(--text-sm);
            font-weight: 600;
        }

        .progress-count {
            font-size: var(--text-sm);
            color: var(--slate);
        }

        .progress-bar-bg {
            height: 4px;
            background: var(--gainsboro);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--jet);
            width: 0%;
            transition: width 0.3s ease;
        }

        .results-section {
            display: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-sm);
        }

        .result-card {
            border-radius: var(--radius-sm);
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .result-card img {
            width: 100%;
            display: block;
        }

        .result-card .result-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: var(--space-xs);
            background: rgba(0,0,0,0.7);
            color: var(--white);
            font-size: var(--text-xs);
            text-align: center;
        }

        .batch-divider {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            color: var(--french-gray);
            font-size: var(--text-xs);
            padding: var(--space-sm) 0;
            margin: var(--space-xs) 0;
        }

        .batch-divider::before,
        .batch-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--gainsboro);
        }

        /* Inline loader - uses shared styles from components.css */
        /* The blue sweep animation comes from components.css - don't override .loader-message */

        /* Page-level tabs */
        .page-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: var(--space-md);
        }

        .page-tab {
            padding: 10px 24px;
            font-size: var(--text-sm);
            font-weight: 600;
            border: 1px solid var(--gainsboro);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .page-tab:first-child {
            border-radius: var(--radius-md) 0 0 var(--radius-md);
        }

        .page-tab:last-child {
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
        }

        .page-tab.active {
            background: var(--jet);
            border-color: var(--jet);
            color: var(--white);
        }

        .page-panel {
            display: none;
        }

        .page-panel.active {
            display: block;
        }

        /* Video Tab Styles */
        .video-settings-bar {
            display: flex;
            gap: var(--space-lg);
            padding: var(--space-sm) var(--space-md);
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            align-items: center;
            flex-wrap: wrap;
        }

        .video-setting-group {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .video-setting-label {
            font-size: var(--text-xs);
            color: var(--slate);
            font-weight: 500;
        }

        .movement-mode-buttons,
        .aspect-ratio-buttons {
            display: flex;
            gap: 2px;
        }

        .movement-mode-btn,
        .aspect-btn {
            padding: 5px 10px;
            font-size: var(--text-2xs);
            font-weight: 500;
            border: 1px solid var(--gainsboro);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .movement-mode-btn:first-child,
        .aspect-btn:first-child {
            border-radius: var(--radius-xs) 0 0 var(--radius-xs);
        }

        .movement-mode-btn:last-child,
        .aspect-btn:last-child {
            border-radius: 0 var(--radius-xs) var(--radius-xs) 0;
        }

        .movement-mode-btn.active,
        .aspect-btn.active {
            background: var(--jet);
            border-color: var(--jet);
            color: var(--white);
        }

        .video-model-section {
            display: flex;
            gap: var(--space-md);
            padding: var(--space-sm) var(--space-md);
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            align-items: center;
        }

        .video-model-checkboxes {
            display: flex;
            gap: var(--space-md);
            flex: 1;
        }

        .video-model-checkbox {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: var(--text-sm);
            cursor: pointer;
        }

        .video-model-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .quality-select {
            padding: 3px 6px;
            font-size: var(--text-2xs);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-xs);
            background: var(--off-white);
        }

        .quality-badge {
            font-size: var(--text-2xs);
            padding: 2px 6px;
            background: var(--off-white);
            border-radius: var(--radius-xs);
            color: var(--slate);
        }

        .video-upload-section {
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .video-upload-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }

        .video-upload-title {
            font-size: var(--text-sm);
            font-weight: 600;
        }

        .video-upload-subtitle {
            font-size: var(--text-xs);
            color: var(--slate);
        }

        .video-upload-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-sm);
        }

        .video-upload-slot {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .video-upload-slot .slot-image-container {
            aspect-ratio: 3/4;
            border: 2px dashed var(--gainsboro);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: var(--off-white);
            transition: all var(--transition-fast);
        }

        .video-upload-slot .slot-image-container:hover {
            border-color: var(--slate);
        }

        .video-upload-slot.filled .slot-image-container {
            border-style: solid;
            border-color: var(--jet);
        }

        .video-upload-slot .slot-image-container img {
            width: 95%;
            height: 95%;
            object-fit: contain;
            background: white;
        }

        .video-upload-slot .slot-placeholder {
            text-align: center;
            color: var(--french-gray);
        }

        .video-upload-slot .slot-placeholder-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .video-upload-slot .slot-placeholder-text {
            font-size: var(--text-2xs);
        }

        .video-upload-slot .remove-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 22px;
            height: 22px;
            background: rgba(0,0,0,0.7);
            color: var(--white);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .video-upload-slot.filled .slot-image-container:hover .remove-btn {
            display: flex;
        }

        .video-upload-slot .slot-prompt {
            width: 100%;
            min-height: 80px;
            padding: var(--space-xs);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            font-family: var(--font-sans);
            font-size: var(--text-xs);
            resize: vertical;
            background: var(--off-white);
        }

        .video-upload-slot .slot-prompt:focus {
            outline: none;
            border-color: var(--jet);
            background: var(--white);
        }

        .video-upload-slot .slot-prompt::placeholder {
            color: var(--ash-grey);
        }

        .video-upload-slot .slot-controls {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .video-upload-slot .slot-controls {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .video-upload-slot .mode-toggle {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            width: 100%;
        }

        .video-upload-slot .mode-btn {
            padding: 6px 4px;
            font-size: 10px;
            font-weight: 500;
            border: 1px solid var(--gainsboro);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
            border-radius: var(--radius-xs);
            text-align: center;
        }

        .video-upload-slot .mode-btn:hover {
            border-color: var(--slate);
        }

        .video-upload-slot .mode-btn.active {
            background: var(--jet);
            border-color: var(--jet);
            color: var(--white);
        }

        .video-upload-slot .movement-toggle {
            display: flex;
            width: 100%;
        }

        .video-upload-slot .movement-btn {
            flex: 1;
            padding: 6px 4px;
            font-size: 10px;
            font-weight: 500;
            border: 1px solid var(--gainsboro);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
            border-radius: var(--radius-xs);
            text-align: center;
        }

        .video-upload-slot .movement-btn:hover {
            border-color: var(--slate);
        }

        .video-upload-slot .movement-btn.active {
            background: #2196F3;
            border-color: #2196F3;
            color: var(--white);
        }

        .video-upload-slot .movement-btn-plus {
            flex: 1;
            padding: 6px 4px;
            font-size: 10px;
            font-weight: 500;
            border: 1px solid var(--gainsboro);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
            border-radius: var(--radius-xs);
            text-align: center;
            margin-left: 4px;
        }

        .video-upload-slot .movement-btn-plus:hover {
            border-color: var(--slate);
        }

        .video-upload-slot .movement-btn-plus.active {
            background: #FF9800;
            border-color: #FF9800;
            color: var(--white);
        }

        .video-upload-slot .movement-btn-dynamic {
            flex: 1;
            padding: 6px 4px;
            font-size: 10px;
            font-weight: 500;
            border: 1px solid var(--gainsboro);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
            border-radius: var(--radius-xs);
            text-align: center;
            margin-left: 4px;
        }

        .video-upload-slot .movement-btn-dynamic:hover {
            border-color: var(--slate);
        }

        .video-upload-slot .movement-btn-dynamic.active {
            background: #E91E63;
            border-color: #E91E63;
            color: var(--white);
        }

        .video-upload-slot.deselected .slot-image-container {
            opacity: 0.3;
            filter: grayscale(100%);
            border-color: var(--gainsboro);
        }

        .video-upload-slot.deselected .slot-prompt,
        .video-upload-slot.deselected .slot-controls {
            opacity: 0.4;
            pointer-events: none;
        }

        .video-upload-slot .slot-checkbox input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .video-results-section {
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            padding: var(--space-md);
        }

        .video-results-header {
            font-size: var(--text-sm);
            font-weight: 600;
            margin-bottom: var(--space-sm);
        }

        .video-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--space-md);
        }

        .video-result-card {
            background: var(--off-white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .video-result-card video {
            width: 100%;
            display: block;
        }

        .video-result-card .card-footer {
            padding: var(--space-xs) var(--space-sm);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: var(--text-xs);
        }

        .video-result-card .card-label {
            color: var(--slate);
        }

        .video-result-card .card-model {
            font-weight: 500;
            color: var(--jet);
        }

        .video-result-card.generating {
            position: relative;
        }

        .video-result-card .generating-overlay {
            position: absolute;
            inset: 0;
            background: var(--off-white);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .video-result-card .generating-spinner {
            width: 28px;
            height: 28px;
            border: 2px solid var(--gainsboro);
            border-top-color: var(--jet);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-xs);
        }

        .video-result-card .generating-text {
            font-size: var(--text-xs);
            color: var(--slate);
        }

        .video-status {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--jet);
            color: var(--white);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            display: flex;
            gap: var(--space-md);
            align-items: center;
            font-size: var(--text-sm);
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .video-status-text {
            font-weight: 500;
        }

        .video-status-progress {
            opacity: 0.7;
        }

        /* Generate Tab Styles - Matches generate.html */
        .gen-settings-section {
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            padding: var(--space-md);
        }

        .gen-settings-row {
            display: flex;
            gap: var(--space-md);
            align-items: flex-start;
            margin-bottom: var(--space-sm);
        }

        .gen-settings-row:last-of-type {
            margin-bottom: 0;
        }

        .gen-setting-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2xs);
        }

        .gen-flex-1 {
            flex: 1;
        }

        .gen-setting-label {
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--slate);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .gen-custom-prompt {
            width: 100%;
            min-height: 60px;
            padding: var(--space-sm);
            font-size: var(--text-sm);
            font-family: inherit;
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            resize: vertical;
            margin-top: var(--space-xs);
        }

        .gen-custom-prompt:focus {
            outline: none;
            border-color: var(--jet);
        }

        .gen-custom-prompt::placeholder {
            color: var(--silver);
        }

        .gen-generate-row {
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--gainsboro);
        }

        .gen-calc-display {
            font-size: var(--text-sm);
            color: var(--slate);
            margin-bottom: var(--space-xs);
            text-align: center;
        }

        .btn-cost {
            opacity: 0.7;
            margin-left: 6px;
            font-weight: 400;
        }

        .btn-group--wrap {
            flex-wrap: wrap;
            gap: var(--space-xs);
        }

        /* Grid controls - slider for columns */
        .grid-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: var(--space-xs);
            margin-bottom: var(--space-sm);
            padding-right: var(--space-xs);
        }

        .grid-slider {
            width: 80px;
            cursor: pointer;
        }

        #grid-cols-value {
            font-size: var(--text-sm);
            color: var(--slate);
            min-width: 16px;
        }

        .gen-results {
            display: none;
            margin-top: var(--space-md);
        }

        .gen-results.active {
            display: block;
        }

        .gen-results-header {
            font-size: var(--text-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-sm);
        }

        .gen-results-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        .gen-batch {
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .gen-batch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) var(--space-md);
            background: var(--ghost-white);
            border-bottom: 1px solid var(--gainsboro);
        }

        .gen-batch-title {
            font-weight: 600;
            font-size: var(--text-sm);
            color: var(--jet);
        }

        .gen-batch-info {
            font-size: var(--text-xs);
            color: var(--slate);
        }

        .gen-batch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-sm);
            padding: var(--space-sm);
        }

        .gen-result-card {
            aspect-ratio: 16/9;
            border-radius: var(--radius-sm);
            overflow: hidden;
            cursor: pointer;
            position: relative;
            border: 1px solid var(--gainsboro);
        }

        .gen-result-card:hover {
            border-color: var(--jet);
        }

        .gen-result-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gen-result-card .download-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            padding: 6px 12px;
            font-size: var(--text-xs);
            font-weight: 500;
            background: rgba(0,0,0,0.7);
            color: var(--white);
            border: none;
            border-radius: var(--radius-xs);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .gen-result-card .download-btn:hover {
            background: var(--jet);
        }

        .gen-result-card .model-label {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 600;
            background: rgba(0,0,0,0.7);
            color: var(--white);
            border-radius: var(--radius-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Ron Dorff <span class="page-subtitle">Fearless Summer v2</span></h1>
        </div>

        <!-- Page-level Tabs -->
        <div class="page-tabs">
            <button class="page-tab active" data-page="campaign">Campaign</button>
            <button class="page-tab" data-page="generate">Generate</button>
            <button class="page-tab" data-page="video">Video</button>
            <button class="page-tab" data-page="prompts">Prompts</button>
        </div>

        <!-- CAMPAIGN PANEL -->
        <div class="page-panel active" id="campaign-panel">

        <!-- Settings Bar -->
        <div class="settings-bar">
            <div class="setting-item">
                <label>Ratio:</label>
                <div class="btn-group-compact" id="ratio-buttons">
                    <button data-value="1:1">1:1</button>
                    <button data-value="3:4">3:4</button>
                    <button data-value="4:3">4:3</button>
                    <button data-value="9:16">9:16</button>
                    <button class="active" data-value="16:9">16:9</button>
                </div>
            </div>
            <div class="setting-item">
                <label>Seeds:</label>
                <div class="btn-group-compact" id="seeds-buttons">
                    <button class="active" data-value="1">1</button>
                    <button data-value="2">2</button>
                    <button data-value="3">3</button>
                    <button data-value="4">4</button>
                </div>
            </div>
            <div class="setting-item">
                <label>Duo %:</label>
                <div class="slider-container">
                    <input type="range" id="duo-slider" min="0" max="100" value="0">
                    <span class="slider-value" id="duo-value">0%</span>
                </div>
            </div>
            <div class="setting-item">
                <label>Interaction:</label>
                <div class="slider-container">
                    <input type="range" id="interaction-slider" min="0" max="3" value="1" step="1">
                    <span class="slider-value" id="interaction-value">Medium</span>
                </div>
            </div>
            <div class="setting-item">
                <label>Dynamic:</label>
                <div class="slider-container">
                    <input type="range" id="dynamic-slider" min="0" max="3" value="1" step="1">
                    <span class="slider-value" id="dynamic-value">Medium</span>
                </div>
            </div>
        </div>

        <!-- Models Section -->
        <div class="section">
            <div class="section-header">
                <div>
                    <span class="section-title">Models</span>
                    <span class="section-subtitle"> â€” Select one or more</span>
                </div>
            </div>
            <div class="section-tabs" id="model-tabs">
                <button class="section-tab active" data-tab="rondorff">Ron Dorff</button>
                <button class="section-tab" data-tab="setset">Setset</button>
            </div>
            <div class="tab-panel active" id="model-panel-rondorff">
                <div class="model-grid" id="model-grid-rondorff"></div>
            </div>
            <div class="tab-panel" id="model-panel-setset">
                <div class="model-grid setset-grid" id="model-grid-setset"></div>
            </div>
        </div>

        <!-- Products Section -->
        <div class="section">
            <div class="section-header">
                <div>
                    <span class="section-title">Products</span>
                    <span class="section-subtitle"> â€” Select group for each product (1-4)</span>
                </div>
            </div>
            <div class="section-tabs" id="product-tabs">
                <button class="section-tab active" data-tab="styling">Styling</button>
                <button class="section-tab" data-tab="rondorff">Ron Dorff</button>
                <button class="section-tab" data-tab="upload">Upload</button>
            </div>
            <div class="tab-panel active" id="product-panel-styling">
                <div class="styling-controls">
                    <div class="setting-item">
                        <label>Sandals:</label>
                        <div class="slider-container">
                            <input type="range" id="sandals-slider" min="0" max="100" value="50">
                            <span class="slider-value" id="sandals-value">50%</span>
                        </div>
                    </div>
                </div>
                <div class="outfit-grid" id="outfit-grid"></div>
            </div>
            <div class="tab-panel" id="product-panel-rondorff">
                <div class="product-grid" id="product-grid"></div>
            </div>
            <div class="tab-panel" id="product-panel-upload">
                <div class="grid-controls">
                    <input type="range" id="grid-cols-slider" min="2" max="6" value="4" class="grid-slider">
                    <span id="grid-cols-value">4</span>
                </div>
                <div class="custom-product-grid" id="custom-product-grid"></div>
            </div>
            <input type="file" id="product-file-input" accept="image/*" multiple style="display: none;">

            <!-- Group Notes Section -->
            <div class="group-notes-section" id="group-notes-section">
                <h4>Group Notes (Gemini will enhance prompts with these)</h4>
                <div class="group-notes-grid" id="group-notes-grid"></div>
            </div>
        </div>

        <!-- Environments Section -->
        <div class="section">
            <div class="section-header">
                <div>
                    <span class="section-title">Environments</span>
                    <span class="section-subtitle"> â€” Select preset locations or upload your own</span>
                </div>
            </div>
            <div class="env-header-row">
                <div class="env-tabs">
                    <button class="env-tab active" data-tab="rocky-beach">Rocky Beach</button>
                    <button class="env-tab" data-tab="architecture-v2">Arch V2</button>
                    <button class="env-tab" data-tab="architecture-v1">Arch V1</button>
                    <button class="env-tab" data-tab="black-sand-beach">Black Sand</button>
                    <button class="env-tab" data-tab="upload">Upload</button>
                </div>
                <div class="env-grid-size slider-container">
                    <label>Grid:</label>
                    <input type="range" id="env-grid-slider" min="2" max="6" value="4" step="1">
                    <span class="slider-value" id="env-grid-value">4</span>
                </div>
                <div class="env-toggles">
                    <div class="setting-item">
                        <label>Copy Pose</label>
                        <div class="slider-container">
                            <input type="range" id="copy-pose-slider" min="0" max="100" value="50">
                            <span class="slider-value" id="copy-pose-value">50%</span>
                        </div>
                    </div>
                    <div class="env-option">
                        <div class="toggle-switch" id="cinematic-toggle"></div>
                        <label>Cinematic</label>
                    </div>
                    <div class="env-option">
                        <div class="toggle-switch" id="describe-only-toggle"></div>
                        <label>Describe only</label>
                    </div>
                </div>
            </div>
            <div id="env-upload-panel">
                <div class="environment-grid" id="environment-grid"></div>
            </div>
            <div id="env-black-sand-beach-panel" style="display: none;">
                <div class="preset-env-header">
                    <span class="preset-count" id="black-sand-beach-count">0 selected</span>
                    <button class="deselect-btn" id="deselect-black-sand-beach">Deselect all</button>
                </div>
                <div class="preset-env-grid" id="black-sand-beach-grid"></div>
            </div>
            <div id="env-rocky-beach-panel" style="display: none;">
                <div class="preset-env-header">
                    <span class="preset-count" id="rocky-beach-count">0 selected</span>
                    <button class="deselect-btn" id="deselect-rocky-beach">Deselect all</button>
                </div>
                <div class="preset-env-grid" id="rocky-beach-grid"></div>
            </div>
            <div id="env-architecture-v1-panel" style="display: none;">
                <div class="preset-env-header">
                    <span class="preset-count" id="architecture-v1-count">0 selected</span>
                    <button class="deselect-btn" id="deselect-architecture-v1">Deselect all</button>
                </div>
                <div class="preset-env-grid" id="architecture-v1-grid"></div>
            </div>
            <div id="env-architecture-v2-panel" style="display: none;">
                <div class="preset-env-header">
                    <span class="preset-count" id="architecture-v2-count">0 selected</span>
                    <button class="deselect-btn" id="deselect-architecture-v2">Deselect all</button>
                </div>
                <div class="preset-env-grid" id="architecture-v2-grid"></div>
            </div>
            <input type="file" id="env-file-input" accept="image/*" multiple style="display: none;">
            <div class="prompt-box">
                <label>Additional styling notes (lighting, era, mood, etc.)</label>
                <textarea id="additional-prompt" placeholder="e.g., shot with a 90s film camera, warm glowy skin, flash photography, vintage aesthetic..."></textarea>
            </div>
        </div>

        <!-- Generate Bar -->
        <div class="generate-bar">
            <div class="selection-summary" id="selection-summary">Select models, products & environments</div>
            <button class="generate-btn" id="generate-btn" disabled>Generate</button>
        </div>

        <!-- Loader -->
        <div class="inline-loader" id="loader">
            <div class="loader-message" id="loader-message">Preparing...</div>
            <div class="loader-progress" id="loader-progress">Analyzing images...</div>
        </div>

        <!-- Progress -->
        <div class="progress-section" id="progress-section">
            <div class="progress-header">
                <span class="progress-title" id="progress-title">Generating...</span>
                <span class="progress-count" id="progress-count">0 / 0</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <!-- Results -->
        <div class="results-section" id="results-section">
            <div class="section-header">
                <span class="section-title">Results</span>
            </div>
            <div class="results-grid" id="results-grid"></div>
        </div>

        </div><!-- END CAMPAIGN PANEL -->

        <!-- GENERATE PANEL -->
        <div class="page-panel" id="generate-panel">

            <!-- Settings Section -->
            <div class="gen-settings-section">
                <!-- Row 1: Models -->
                <div class="gen-settings-row">
                    <div class="gen-setting-group gen-flex-1">
                        <label class="gen-setting-label">Models</label>
                        <div class="btn-group" id="gen-model-buttons">
                            <button class="btn btn--toggle active" data-model="reve">Reve</button>
                            <button class="btn btn--toggle" data-model="zimage">Z Image</button>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Aspect Ratio + Seeds -->
                <div class="gen-settings-row">
                    <div class="gen-setting-group gen-flex-1">
                        <label class="gen-setting-label">Aspect Ratio</label>
                        <div class="btn-group" id="gen-aspect-buttons">
                            <button class="btn btn--toggle active" data-ratio="16:9">16:9</button>
                            <button class="btn btn--toggle" data-ratio="3:2">3:2</button>
                            <button class="btn btn--toggle" data-ratio="4:3">4:3</button>
                            <button class="btn btn--toggle" data-ratio="1:1">1:1</button>
                        </div>
                    </div>
                    <div class="gen-setting-group">
                        <label class="gen-setting-label">Seeds</label>
                        <div class="slider-box">
                            <input type="range" class="slider" id="gen-seeds-slider" min="1" max="4" value="1">
                            <span class="slider-value" id="gen-seeds-value">1</span>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Environment Type -->
                <div class="gen-settings-row">
                    <div class="gen-setting-group gen-flex-1">
                        <label class="gen-setting-label">Environment</label>
                        <div class="btn-group btn-group--wrap" id="gen-env-type">
                            <button class="btn btn--toggle" data-value="rocky-beach">Rocky Beach</button>
                            <button class="btn btn--toggle" data-value="black-sand">Black Sand Beach</button>
                            <button class="btn btn--toggle" data-value="architecture-v1">Architecture v1</button>
                            <button class="btn btn--toggle" data-value="architecture-v2">Architecture v2</button>
                        </div>
                    </div>
                </div>

                <!-- Row 4: Lighting -->
                <div class="gen-settings-row">
                    <div class="gen-setting-group gen-flex-1">
                        <label class="gen-setting-label">Lighting</label>
                        <div class="btn-group" id="gen-lighting">
                            <button class="btn btn--toggle active" data-value="midday">Midday Summer</button>
                            <button class="btn btn--toggle" data-value="sunrise">Sunrise</button>
                            <button class="btn btn--toggle" data-value="sunset">Sunset</button>
                        </div>
                    </div>
                </div>

                <!-- Row 5: Content -->
                <div class="gen-settings-row">
                    <div class="gen-setting-group gen-flex-1">
                        <label class="gen-setting-label">Content</label>
                        <div class="btn-group" id="gen-content">
                            <button class="btn btn--toggle active" data-value="environment">Environment Only</button>
                            <button class="btn btn--toggle" data-value="male">Environment + Male</button>
                        </div>
                    </div>
                </div>

                <!-- Row 6: Images -->
                <div class="gen-settings-row">
                    <div class="gen-setting-group">
                        <label class="gen-setting-label">Images</label>
                        <div class="btn-group" id="gen-count">
                            <button class="btn btn--toggle active" data-value="5">5</button>
                            <button class="btn btn--toggle" data-value="10">10</button>
                            <button class="btn btn--toggle" data-value="15">15</button>
                            <button class="btn btn--toggle" data-value="20">20</button>
                        </div>
                    </div>
                </div>

                <!-- Row 7: Custom Prompt -->
                <div class="gen-settings-row">
                    <div class="gen-setting-group gen-flex-1">
                        <label class="gen-setting-label">Custom Instructions (optional)</label>
                        <textarea class="gen-custom-prompt" id="gen-custom-prompt" placeholder="e.g., He should stand halfway in water looking into the camera, dramatic pose with arms raised..."></textarea>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="gen-generate-row">
                    <div class="gen-calc-display" id="gen-calc-display">Select environment type</div>
                    <button class="btn btn--primary btn--lg btn--block" id="gen-btn" disabled>Generate <span class="btn-cost" id="gen-cost-value">$0.00</span></button>
                </div>
            </div>

            <!-- Generate Loader (uses shared loader.js) -->
            <div class="inline-loader" id="gen-inline-loader">
                <div class="loader-message" id="gen-loader-message">Setting up the Studio...</div>
                <div class="loader-progress" id="gen-loader-progress">Preparing...</div>
            </div>

            <!-- Generate Results -->
            <div class="gen-results" id="gen-results">
                <div class="gen-results-header">Results</div>
                <div class="gen-results-grid" id="gen-results-grid"></div>
            </div>

        </div><!-- END GENERATE PANEL -->

        <!-- VIDEO PANEL -->
        <div class="page-panel" id="video-panel">
            <!-- Video Settings Bar -->
            <div class="video-settings-bar">
                <div class="video-setting-group">
                    <span class="video-setting-label">Camera:</span>
                    <div class="movement-mode-buttons" id="movement-mode-buttons">
                        <button class="movement-mode-btn active" data-mode="static">Static</button>
                        <button class="movement-mode-btn" data-mode="dynamic">Dynamic</button>
                        <button class="movement-mode-btn" data-mode="handheld">Handheld</button>
                        <button class="movement-mode-btn" data-mode="90s">90s</button>
                        <button class="movement-mode-btn" data-mode="follow">Follow</button>
                        <button class="movement-mode-btn" data-mode="push">Push</button>
                        <button class="movement-mode-btn" data-mode="pull">Pull</button>
                        <button class="movement-mode-btn" data-mode="arc">Arc</button>
                        <button class="movement-mode-btn" data-mode="rise">Rise</button>
                        <button class="movement-mode-btn" data-mode="drift">Drift</button>
                        <button class="movement-mode-btn" data-action="random">Random</button>
                        <button class="movement-mode-btn" data-action="clear">Clear</button>
                    </div>
                </div>
                <div class="video-setting-group">
                    <span class="video-setting-label">Aspect:</span>
                    <div class="aspect-ratio-buttons" id="video-aspect-buttons">
                        <button class="aspect-btn active" data-aspect="16:9">16:9</button>
                        <button class="aspect-btn" data-aspect="9:16">9:16</button>
                        <button class="aspect-btn" data-aspect="1:1">1:1</button>
                    </div>
                </div>
                <div class="video-setting-group">
                    <span class="video-setting-label">Duration:</span>
                    <div class="slider-container">
                        <input type="range" id="video-duration-slider" min="3" max="10" value="5" step="1">
                        <span class="slider-value" id="video-duration-value">5s</span>
                    </div>
                </div>
            </div>

            <!-- Model Selection -->
            <div class="video-model-section">
                <div class="video-model-checkboxes">
                    <label class="video-model-checkbox">
                        <input type="checkbox" id="kling-checkbox" checked>
                        <span>Kling V3</span>
                        <select id="kling-quality" class="quality-select">
                            <option value="pro">Pro</option>
                            <option value="standard">Standard</option>
                        </select>
                    </label>
                    <label class="video-model-checkbox">
                        <input type="checkbox" id="seedance-checkbox">
                        <span>Seedance 2.5</span>
                        <span class="quality-badge">720p</span>
                    </label>
                </div>
                <button class="btn btn--sm" id="video-analyze-btn">Analyze</button>
                <button class="btn btn--primary" id="video-generate-btn" disabled>Generate</button>
            </div>

            <!-- Video Upload Grid -->
            <div class="video-upload-section">
                <div class="video-upload-header">
                    <span class="video-upload-title">Upload Images</span>
                    <span class="video-upload-subtitle" id="video-upload-count">0 / 12 images</span>
                    <button class="btn btn--sm" id="video-clear-all-btn" style="display: none;">Clear All</button>
                </div>
                <div class="video-upload-grid" id="video-upload-grid">
                    <!-- 12 slots, 3 columns x 4 rows -->
                </div>
                <input type="file" id="video-file-input" accept="image/*" multiple style="display: none;">
            </div>

            <!-- Video Results -->
            <div class="video-results-section" id="video-results-section" style="display: none;">
                <div class="video-results-header">
                    <span>Results</span>
                </div>
                <div class="video-results-grid" id="video-results-grid"></div>
            </div>

            <!-- Video Status -->
            <div class="video-status" id="video-status" style="display: none;">
                <div class="video-status-text" id="video-status-text">Analyzing images...</div>
                <div class="video-status-progress" id="video-status-progress">0 / 0</div>
            </div>
        </div><!-- END VIDEO PANEL -->

        <!-- PROMPTS PANEL -->
        <div class="page-panel" id="prompts-panel">
            <div class="prompts-section">
                <div class="section-header">
                    <span class="section-title">Hair Color Prompts</span>
                    <span class="section-subtitle"> â€” Click to copy all</span>
                </div>
                <pre class="prompts-code-box" id="prompts-code-box">Transform this man's hair to a natural sun-bleached blonde, like someone who spends every day surfing in California. Keep the exact same haircut, texture, and style - just shift the color to that warm, natural blonde you get from sun and saltwater. Not platinum or yellow, but authentic surfer blonde with subtle darker roots.

Change his hair color to a natural beach blonde - the kind you see on Malibu surfers. Think sun-lightened, warm sandy blonde tones, not dyed or artificial looking. Same haircut and texture, just the color of someone who lives in the ocean. Subtle variation in tones like real sun-bleached hair.

Make his hair a warm, natural surfer blonde. Not yellow or platinum - more like golden wheat tones with subtle darker undertones at the roots. The kind of blonde that comes from months of sun and salt water. Keep the identical haircut and face, only adjust the hair color.

Adjust hair color to authentic California surfer blonde - warm golden tones, naturally sun-bleached appearance, with slightly darker roots blending into lighter ends. Think Santa Cruz or Huntington Beach local. Same exact hairstyle and texture, just the natural blonde of an outdoor athlete.

Change his hair to a natural sandy blonde, warm and sun-kissed like a professional surfer. Not bright yellow or platinum - more like John John Florence or Mick Fanning's hair color. Golden, warm, beachy. Keep everything else identical - same cut, same face, same styling.</pre>
                <div class="copy-feedback" id="copy-feedback">Copied!</div>
            </div>
        </div><!-- END PROMPTS PANEL -->

    </div>

    <script src="/shared/js/api.js"></script>
    <script src="/shared/js/models.js"></script>
    <script src="/shared/js/loader.js"></script>
    <script src="/shared/js/lightbox.js"></script>
    <script>
        // Ron Dorff "Fearless Summer" themed loader messages
        const RONDORFF_LOADER_MESSAGES = [
            "Chartering the yacht...",
            "Warming up the Mediterranean sun...",
            "Unpacking the swim trunks...",
            "Finding the perfect rock to pose on...",
            "Applying SPF 50...",
            "Checking the golden hour...",
            "Scouting the cliffside villa...",
            "Adjusting the swim briefs...",
            "Waiting for the perfect wave...",
            "Setting up the beach umbrella...",
            "Mixing the Aperol Spritz...",
            "Polishing the Ray-Bans...",
            "Finding the scenic overlook...",
            "Tanning to perfection...",
            "Anchoring near the cove...",
            "Pressing the linen shirts...",
            "Locating the infinity pool...",
            "Scouting the rooftop terrace...",
            "Walking the cobblestone streets...",
            "Finding that perfect summer light...",
            "Prepping for the dive...",
            "Relaxing on the sundeck...",
            "Catching the sea breeze...",
            "Almost ready for fearless summer..."
        ];

        // ========== DATA ==========
        const RONDORFF_MODELS = [
            {
                id: 'model-01',
                name: 'Model 1',
                image: '/assets/brand/rondorff/models/model-01.jpg',
                thumb: '/assets/brand/rondorff/models/thumbs/model-01.jpg',
                description: 'Male model with medium-length brown hair, light stubble beard, striking defined features, warm tanned skin, intense gaze, athletic build with defined abs and toned muscular physique, classic masculine proportions'
            },
            {
                id: 'model-02',
                name: 'Model 2',
                image: '/assets/brand/rondorff/models/model-02.jpg',
                thumb: '/assets/brand/rondorff/models/thumbs/model-02.jpg',
                description: 'Male model with short strawberry blonde wavy hair, striking blue eyes, clean-shaven, strong angular jawline, fair skin with light freckles, intense masculine gaze, athletic build with defined abs and toned muscular physique, classic masculine proportions'
            }
        ];

        // Setset talent roster
        const SETSET_MODELS = [
            { id: 'james', name: 'James Wilson', image: '/shared/images/talent/talent-01_JamesWilson.png', thumb: '/shared/images/talent/thumbs/talent-01_JamesWilson.png', description: 'An East Asian male in his 40s with short, slicked back black hair with gray streaks and a medium skin tone.' },
            { id: 'maya', name: 'Maya Johnson', image: '/shared/images/talent/talent-02_MayaJohnson.png', thumb: '/shared/images/talent/thumbs/talent-02_MayaJohnson.png', description: 'A mid 20s female with dark brown wavy hair, medium tan skin, and strong eyebrows.' },
            { id: 'river', name: 'River Blake', image: '/shared/images/talent/talent-03_RiverBlake.png', thumb: '/shared/images/talent/thumbs/talent-03_RiverBlake.png', description: 'A pale-skinned Caucasian male in his late 20s with platinum blonde, straight, medium length hair and intense blue eyes.' },
            { id: 'emma', name: 'Emma Sullivan', image: '/shared/images/talent/talent-04_EmmaSullivan.png', thumb: '/shared/images/talent/thumbs/talent-04_EmmaSullivan.png', description: 'A young Caucasian female in her early 20s with brown straight shoulder-length hair, fair skin, and prominent cheekbones.' },
            { id: 'marcus', name: 'Marcus Brown', image: '/shared/images/talent/talent-05_MarcusBrown.png', thumb: '/shared/images/talent/thumbs/talent-05_MarcusBrown.png', description: 'A male in his 30s with a dark skin tone, short black dreadlocks, and pronounced cheekbones.' },
            { id: 'zara', name: 'Zara Mitchell', image: '/shared/images/talent/talent-06_ZaraMitchell.png', thumb: '/shared/images/talent/thumbs/talent-06_ZaraMitchell.png', description: 'A young female with dark skin, natural black hair, and striking features.' },
            { id: 'sophia', name: 'Sophia Anderson', image: '/shared/images/talent/talent-07_SophiaAnderson.png', thumb: '/shared/images/talent/thumbs/talent-07_SophiaAnderson.png', description: 'A young Caucasian female in her early 20s with light brown, wavy, shoulder-length hair, fair skin, and thick eyebrows.' },
            { id: 'liam', name: 'Liam Garcia', image: '/shared/images/talent/talent-08_LiamGarcia.png', thumb: '/shared/images/talent/thumbs/talent-08_LiamGarcia.png', description: 'A male model with warm features and athletic build.' },
            { id: 'nina', name: 'Nina Davis', image: '/shared/images/talent/talent-09_NinaDavis.png', thumb: '/shared/images/talent/thumbs/talent-09_NinaDavis.png', description: 'A mid 20s Southeast Asian female with long, straight black hair, medium brown skin tone, and high cheekbones.' },
            { id: 'luna', name: 'Luna Park', image: '/shared/images/talent/talent-11_LunaPark.png', thumb: '/shared/images/talent/thumbs/talent-11_LunaPark.png', description: 'A Caucasian female in her early 20s with long brown hair, fair skin, and thick eyebrows.' },
            { id: 'noah', name: 'Noah Chen', image: '/shared/images/talent/talent-12_NoahChen.png', thumb: '/shared/images/talent/thumbs/talent-12_NoahChen.png', description: 'A male in his late 20s with a medium brown skin tone, short curly black hair, and a pronounced jawline.' },
            { id: 'mia', name: 'Mia Parker', image: '/shared/images/talent/talent-13_MiaParker.png', thumb: '/shared/images/talent/thumbs/talent-13_MiaParker.png', description: 'A young Black female with short natural curls and deep brown skin.' },
            { id: 'riley', name: 'Riley Morgan', image: '/shared/images/talent/talent-14_RileyMorgan.png', thumb: '/shared/images/talent/thumbs/talent-14_RileyMorgan.png', description: 'East Asian male in his early 20s with short, wavy dark brown hair and a light skin tone.' },
            { id: 'isabella', name: 'Isabella Rodriguez', image: '/shared/images/talent/talent-16_IsabellaRodriguez.png', thumb: '/shared/images/talent/thumbs/talent-16_IsabellaRodriguez.png', description: 'A Caucasian woman in her 40s with grey shoulder-length hair and intense blue eyes.' },
            { id: 'quinn', name: 'Quinn Santos', image: '/shared/images/talent/talent-17_QuinnSantos.png', thumb: '/shared/images/talent/thumbs/talent-17_QuinnSantos.png', description: 'Young Latino male in early 20s with short black hair, medium brown skin, and distinctive broad nose and full lips.' },
            { id: 'casey', name: 'Casey White', image: '/shared/images/talent/talent-18_CaseyWhite.png', thumb: '/shared/images/talent/thumbs/talent-18_CaseyWhite.png', description: 'A mid 20s Asian female with long black hair pulled back, medium skin tone, and a symmetrical face.' },
            { id: 'drew', name: 'Drew Martinez', image: '/shared/images/talent/talent-20_DrewMartinez.png', thumb: '/shared/images/talent/thumbs/talent-20_DrewMartinez.png', description: 'Young East Asian male with short black hair and white eyebrows.' },
            { id: 'avery', name: 'Avery Taylor', image: '/shared/images/talent/talent-21_AveryTaylor.png', thumb: '/shared/images/talent/thumbs/talent-21_AveryTaylor.png', description: 'A mid-20s Black female with short curly black hair, medium brown skin, and strong eyebrows.' },
            { id: 'parker', name: 'Parker Miller', image: '/shared/images/talent/talent-22_ParkerMiller.png', thumb: '/shared/images/talent/thumbs/talent-22_ParkerMiller.png', description: 'A young male with athletic build and warm features.' },
            { id: 'morgan', name: 'Morgan Kim', image: '/shared/images/talent/talent-23_MorganKim.png', thumb: '/shared/images/talent/thumbs/talent-23_MorganKim.png', description: 'A young Caucasian male in his early 20s with platinum blonde hair styled with volume, fair skin, striking blue eyes, and prominent eyebrows.' },
            { id: 'andre', name: 'Andre Jackson', image: '/shared/images/talent/talent-24_AndreJackson.png', thumb: '/shared/images/talent/thumbs/talent-24_AndreJackson.png', description: 'A late 20s Black male with a short buzz cut and dark brown skin, featuring smooth skin and symmetrical features.' },
            { id: 'sofia', name: 'Sofia Rodriguez', image: '/shared/images/talent/talent-27_SofiaRodriguez.png', thumb: '/shared/images/talent/thumbs/talent-27_SofiaRodriguez.png', description: 'A young Latina female with warm brown skin and dark hair.' },
            { id: 'clara', name: 'Clara Devereaux', image: '/shared/images/talent/talent-29_ClaraDevereaux.png', thumb: '/shared/images/talent/thumbs/talent-29_ClaraDevereaux.png', description: 'A young female with elegant features and fair skin.' }
        ];

        const PRODUCTS = [
            { id: '21bg97', name: 'Tote Bag', image: '/assets/brand/rondorff/products/21bg97.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21bg97.jpg', description: 'Peach/coral canvas tote bag with bold "FEARLESS SUMMER" black text print, casual beach accessory' },
            { id: '21ca653dd', name: 'Cap', image: '/assets/brand/rondorff/products/21ca653dd.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ca653dd.jpg', description: 'Bright orange baseball cap with curved brim, "Sunset Boy" embroidered text, sporty summer style' },
            { id: '21sr20dd', name: 'Swim Orange', image: '/assets/brand/rondorff/products/21sr20dd.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21sr20dd.jpg', description: 'Orange/peach VERY SHORT tight Speedo-style swim briefs, NOT swim shorts, brief-cut ending at upper thigh, snug fitted European style like underwear briefs' },
            { id: '21sr21b', name: 'Swim Beige', image: '/assets/brand/rondorff/products/21sr21b.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21sr21b.jpg', description: 'Beige/tan VERY SHORT tight Speedo-style swim briefs, NOT swim shorts, brief-cut ending at upper thigh, snug fitted European style like underwear briefs' },
            { id: '21ss20', name: 'Terry Shorts', image: '/assets/brand/rondorff/products/21ss20.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ss20.jpg', description: 'Warm beige/sand colored terry cloth shorts (NOT white), soft knit texture, relaxed fit, drawstring waist' },
            { id: '21ss21', name: 'Cargo Shorts', image: '/assets/brand/rondorff/products/21ss21.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ss21.jpg', description: 'Khaki/beige cargo shorts, utilitarian pockets, casual summer style' },
            { id: '21sw2019', name: 'Ombre Tank', image: '/assets/brand/rondorff/products/21sw2019.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21sw2019.jpg', description: 'Sleeveless muscle tank top with pink-to-orange ombre gradient, soft cotton, relaxed fit' },
            { id: '21tk189', name: 'Ribbed Tank', image: '/assets/brand/rondorff/products/21tk189.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21tk189.jpg', description: 'Warm beige/sand colored ribbed tank top (NOT white), fine knit texture, classic athletic cut' },
            { id: '21ts1115dd', name: 'Ombre Tee', image: '/assets/brand/rondorff/products/21ts1115dd.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ts1115dd.jpg', description: 'Crew neck t-shirt with pink-to-orange ombre gradient, soft cotton, relaxed fit' },
            { id: '21ts1267', name: 'Sunset Tank', image: '/assets/brand/rondorff/products/21ts1267.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ts1267.jpg', description: 'Sleeveless muscle tee with pink-to-coral gradient and "SUNSET BOY" text graphic' },
            { id: '21ts1505', name: 'Camp Shirt', image: '/assets/brand/rondorff/products/21ts1505.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ts1505.jpg', description: 'Warm beige/sand colored knit button-up camp collar shirt (NOT white), relaxed summer fit, breathable open-weave fabric' },
            { id: '21ur30', name: 'Brief White', image: '/assets/brand/rondorff/products/21ur30.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ur30.jpg', description: 'White VERY SHORT tight Speedo-style swim briefs, NOT swim shorts, brief-cut ending at upper thigh, snug fitted European style like underwear briefs' },
            { id: '21ur42', name: 'Brief Black', image: '/assets/brand/rondorff/products/21ur42.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ur42.jpg', description: 'Black VERY SHORT tight Speedo-style swim briefs, NOT swim shorts, brief-cut ending at upper thigh, snug fitted European style like underwear briefs' },
            { id: '21sr23dd', name: 'Swim Shorts', image: '/assets/brand/rondorff/products/21sr23dd.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21sr23dd.jpg', description: 'Colorful striped swim shorts with yellow, green, navy blue and orange horizontal stripes, mid-length, casual beach style' },
            { id: '21sn624', name: 'Sandals', image: '/assets/brand/rondorff/products/21sn624.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21sn624.jpg', description: 'Beige/tan leather strap sandals, casual summer footwear, minimalist design' },
            { id: '21ts1118', name: 'White Tee', image: '/assets/brand/rondorff/products/21ts1118.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ts1118.jpg', description: 'White crew neck t-shirt, classic fit, smooth cotton jersey, minimalist design' }
        ];

        // Predefined outfit combinations for Styling tab
        const OUTFITS = [
            {
                id: 'outfit1',
                name: 'Ribbed Tank + Terry Shorts',
                products: ['21tk189', '21ss20'],
                description: 'Beige ribbed tank top paired with cream terry cloth shorts'
            },
            {
                id: 'outfit2',
                name: 'Camp Shirt + Terry Shorts',
                products: ['21ts1505', '21ss20'],
                description: 'Cream knit camp collar shirt with cream terry cloth shorts'
            },
            {
                id: 'outfit3',
                name: 'Sunset Tank + Cargo Shorts',
                products: ['21ts1267', '21ss21'],
                description: 'Pink-coral gradient Sunset Boy tank with khaki cargo shorts'
            },
            {
                id: 'outfit4',
                name: 'Cargo Shorts + White Tee',
                products: ['21ss21', '21ts1118'],
                description: 'Khaki cargo shorts paired with white crew neck t-shirt'
            },
            {
                id: 'outfit5',
                name: 'Ombre Tank + Terry Shorts',
                products: ['21sw2019', '21ss20'],
                description: 'Pink-to-orange ombre gradient tank with cream terry shorts'
            },
            {
                id: 'outfit6',
                name: 'Swim Orange',
                products: ['21sr20dd'],
                description: 'Orange/peach VERY SHORT tight Speedo-style swim briefs, NOT swim shorts, brief-cut ending at upper thigh, snug fitted European style',
                noShirt: true
            },
            {
                id: 'outfit7',
                name: 'Swim Beige',
                products: ['21sr21b'],
                description: 'Beige/tan VERY SHORT tight Speedo-style swim briefs, NOT swim shorts, brief-cut ending at upper thigh, snug fitted European style',
                noShirt: true
            },
            {
                id: 'outfit8',
                name: 'Tote + Swim + White Tee',
                products: ['21bg97', '21sr21b', '21ts1118'],
                description: 'Fearless Summer tote bag with beige swim briefs and white t-shirt'
            },
            {
                id: 'outfit9',
                name: 'Swim Shorts',
                products: ['21sr23dd'],
                description: 'Colorful multicolor striped swim shorts, mid-thigh length, relaxed fit',
                noShirt: true
            }
        ];

        // Global pose counter for cycling through poses (ensures variety)
        let poseCounter = 0;

        // Interaction levels - for both environment and duo interaction
        const LEVEL_LABELS = ['Low', 'Medium', 'High', 'Random'];

        // Environment interaction (how model interacts with surroundings)
        const ENV_INTERACTION = {
            low: 'standing upright, not touching or leaning on anything, minimal contact with environment',
            medium: 'casually interacting with environment - perhaps hand resting on a surface, slight lean, or feet in water',
            high: 'actively engaging with environment - sitting on rocks, leaning against wall, lying on sand, climbing, or immersed in water'
        };

        // Duo interaction (how models interact with each other)
        const DUO_INTERACTION = {
            low: 'standing near each other independently, each in their own space, minimal interaction, both looking at camera or different directions',
            medium: 'standing side by side as friends, relaxed body language, perhaps one glancing at the other, easy masculine camaraderie',
            high: 'close friendly interaction - arm around shoulder, playful push, walking arm in arm, genuine laughter together, natural friendly bond'
        };

        // Cinematic framings - explicit HORIZONTAL/LANDSCAPE orientation (16:9)
        // Mix of full body, half body, and environmental shots
        const CINEMATIC_FRAMINGS = [
            // Full/Environmental
            'WIDE HORIZONTAL LANDSCAPE SHOT - model appears SMALL in the vast landscape, taking up only 20% of the frame, emphasizing the dramatic location, WIDE 16:9 aspect ratio',
            // Half body - cropped
            'HALF BODY HORIZONTAL CROP - model framed from hips up, torso and face prominent, cropped at thighs, LANDSCAPE wide composition',
            // Environmental with model
            'HORIZONTAL frame with MODEL POSITIONED IN LOWER THIRD, dramatic sky and environment filling upper 2/3, WIDE 16:9 composition',
            // Classic medium
            'MEDIUM SHOT HORIZONTAL COMPOSITION - classic editorial framing from waist up, face and outfit clearly visible, LANDSCAPE orientation filling full width',
            // Three-quarter
            'THREE-QUARTER LENGTH HORIZONTAL - classic fashion photography framing showing full outfit, LANDSCAPE wide shot',
            // Half body cropped off-center
            'HALF BODY OFF-CENTER - model cropped at hips, positioned on left or right third of frame, face and torso prominent, LANDSCAPE 16:9',
            // Off-center full
            'OFF-CENTER HORIZONTAL COMPOSITION - model positioned on left or right third of wide frame, environment filling the rest, LANDSCAPE 16:9',
            // Tight medium
            'TIGHT MEDIUM SHOT - chest and face prominent, cropped just below chest, intimate editorial crop, HORIZONTAL wide frame'
        ];

        // Duo poses - two models interacting naturally
        const DUO_POSES = [
            'walking together along shoreline, easy conversation',
            'standing side by side, looking in same direction',
            'one seated, one standing nearby, layered composition',
            'both leaning against rocks, relaxed casual stance',
            'walking together, natural movement',
            'standing at different depths, one closer to camera',
            'both seated, relaxed, each in their own space'
        ];

        // Ron Dorff solo poses - INTERLEAVED for variety (standing, water, walking, seated, leaning, dynamic)
        // Organized so consecutive poses are always different types
        const RONDORFF_SOLO_POSES = [
            // 1. Standing
            'standing on beach with arms crossed over chest, powerful frontal stance, direct commanding gaze',
            // 2. Water/Dynamic
            'emerging from water onto rocks, wet skin glistening, hands gripping rock edge, athletic',
            // 3. Walking
            'walking toward camera on beach, confident direct approach, natural stride',
            // 4. Seated
            'seated on white rocks, one leg extended, leaning back on hands, direct confident gaze toward camera',
            // 5. Leaning
            'leaning against rock face, one hand on rock, profile view, contemplative',
            // 6. Standing
            'standing among large boulders, relaxed stance, hands at sides, looking off to distance',
            // 7. Water/Dynamic
            'standing waist-deep in clear turquoise water, looking toward camera, sun-drenched',
            // 8. Walking
            'walking on wet sand near rocks, casual stride, looking off to side',
            // 9. Seated
            'seated on flat rock formation, one knee raised, arm draped casually over knee, gazing at horizon',
            // 10. Leaning
            'leaning back against low wall, hands gripping edge behind, chest forward, relaxed',
            // 11. Standing
            'standing heroically atop rock peak, silhouette against blue sky, wide confident stance',
            // 12. Water/Dynamic
            'walking out of water onto beach, water droplets on skin, athletic confident',
            // 13. Walking
            'walking across rocky terrain, mid-stride, athletic confident movement, natural energy',
            // 14. Seated
            'seated on rocks with back to camera, muscular back visible, looking toward ocean',
            // 15. Leaning
            'leaning against boulder, one shoulder touching rock, relaxed confident',
            // 16. Standing
            'standing on rocky shoreline, hands on hips, power pose, golden hour lighting',
            // 17. Water/Dynamic
            'climbing out of water onto rocks, wet skin glistening, athletic action',
            // 18. Walking
            'walking away from camera toward sunset, back visible, contemplative',
            // 19. Seated
            'seated on terracotta wall or ledge, looking out at ocean, contemplative profile view',
            // 20. Leaning
            'leaning against concrete pillar, looking off to side, weight shifted, casual',
            // 21. Standing
            'standing in shallow water against boulder, sunset behind, masculine silhouette',
            // 22. Water/Dynamic
            'standing knee-deep in ocean, looking toward horizon, sun on face, contemplative',
            // 23. Walking
            'walking descending white architectural steps, confident descent, looking down',
            // 24. Seated
            'seated at water\'s edge on dark rocks, one knee up, golden hour lighting, looking off contemplatively',
            // 25. Standing
            'standing with weight shifted to one leg, relaxed contrapposto, confident gaze',
            // 26. Water/Dynamic
            'wading through shallow water on beach, splashing, playful energy, natural movement',
            // 27. Walking
            'walking across minimalist terrace, casual confident stride, arms relaxed',
            // 28. Seated
            'seated on rock edge, feet dangling toward water, relaxed summer vibe',
            // 29. Leaning
            'leaning against white wall, arms crossed, casual confident',
            // 30. Standing
            'standing against white wall, relaxed confident stance, arms naturally at sides, direct gaze',
            // 31. Water/Dynamic
            'emerging from sea, walking toward camera through shallow water, athletic powerful',
            // 32. Walking
            'walking on pier toward camera, confident masculine approach',
            // 33. Seated
            'seated with arms crossed over chest, legs apart, intense direct gaze, confident masculine',
            // 34. Standing
            'standing on rooftop terrace, heroic wide stance, arms at sides, powerful masculine presence',
            // 35. Water/Dynamic
            'lying on rocks at water\'s edge, waves gently lapping, relaxed sensual',
            // 36. Walking
            'walking through archway onto terrace, natural confident movement',
            // 37. Seated
            'seated on ochre/yellow wall, legs dangling, sunset behind, relaxed confident',
            // 38. Standing
            'standing in architectural archway, framed by white opening, relaxed confident',
            // 39. Water/Dynamic
            'diving or about to dive into water from rocks, athletic action',
            // 40. Walking
            'walking along rocky beach, looking back over shoulder toward camera',
            // 41. Seated
            'seated leaning against large boulder, one arm resting on knee, casual confidence',
            // 42. Standing
            'standing on concrete pier at water\'s edge, powerful athletic stance, silhouette against sea',
            // 43. Water/Dynamic
            'crouching at water\'s edge, hand touching water surface, contemplative',
            // 44. Seated
            'seated on modernist concrete ledge, one leg up, arms wrapped around knee',
            // 45. Standing
            'standing against warm ochre wall, palm tree shadow across body, relaxed confident',
            // 46. Water/Dynamic
            'standing in ocean up to thighs, arms relaxed at sides, direct gaze, sun-kissed',
            // 47. Seated
            'seated on sandy beach, legs extended forward, leaning back on hands, relaxed and contemplative',
            // 48. Standing
            'standing facing away, looking toward sunset, muscular back visible, contemplative',
            // 49. Water/Dynamic
            'running through shallow surf, athletic dynamic movement, water splashing',
            // 50. Seated
            'seated crouched against wall, knees up, intimate contemplative pose',
            // 51. Standing
            'standing with one arm behind head, classic model pose, weight on one leg',
            // 52. Water/Dynamic
            'sitting in very shallow water on beach, waves around legs, relaxed sensual',
            // 53. Seated
            'seated on architectural steps, one knee up, arm resting on knee, looking off to side',
            // 54. Standing
            'standing in colorful alleyway, one hand touching wall, hip cocked, confident',
            // 55. Seated
            'seated on low wall, leaning forward, hands clasped, engaged confident gaze',
            // 56. Standing
            'standing at edge of terrace, looking out at sea, contemplative masculine',
            // 57. Seated
            'seated on bench or railing, legs apart, leaning back on hands, sunset silhouette',
            // 58. Standing
            'standing with hands on hips, low angle shot, powerful heroic stance',
            // 59. Dynamic
            'crouching low, close to camera, reaching forward, intimate engaging',
            // 60. Dynamic
            'lying reclined on smooth rocks, sensual relaxed pose, eyes toward sky'
        ];

        // Briefs product IDs (for front-facing enforcement)
        const BRIEF_PRODUCT_IDS = ['21ur30', '21ur42'];

        // Footwear options for full body shots (beach/summer appropriate)
        const FOOTWEAR = [
            'barefoot on the sand',
            'barefoot',
            'wearing minimal leather sandals',
            'wearing casual espadrilles',
            'wearing simple slides',
            'barefoot, feet visible in sand'
        ];

        // Preset environments - organized by folder
        const ENV_FOLDERS = {
            'black-sand-beach': [
                'Setset_Location_3_4_12_1769017618938 1.png',
                'Setset_Location_3_4_14_1769017366739 2.png',
                'Setset_Location_3_4_left_15_1769017370424 1.png',
                'Setset_Location_3_4_left_16_1769017374445 1.png',
                'Setset_Location_3_4_right_15_1769017623224 1.png',
                'Setset_Location_3_4_right_16_1769017625111 1.png',
                'Setset_Location_3_4_right_17_1769017371953 1.png',
                'Setset_Location_center_25_1769017385249 1.png',
                'Setset_Location_depth_10_1769017359213 1.png',
                'Setset_Location_depth_32_1769017396278 1.png',
                'Setset_Location_foreground_20_1768604125915 3.png',
                'Setset_Location_left_05_1769017353609 2.png',
                'Setset_Location_left_06_1769017355376 1.png',
                'Setset_Location_left_26_1768594347008 2.png',
                'Setset_Location_left_26_1769017645908 1.png',
                'Setset_Location_low_angle_19_1769017377305 1.png',
                'Setset_Location_right_08_1769017614142 1.png',
                'Setset_Location_right_30_1769017391812 1.png',
                'Setset_Location_wide_01_1768604080879 3.png',
                'Setset_Location_wide_01_1769017345542 1.png',
                'Setset_Location_wide_02_1768518346167 2.png',
                'Setset_Location_wide_02_1769017350673 1.png',
                'Setset_Location_wide_11_1769017363062 2.png',
                'Setset_Location_wide_21_1769017630522 1.png',
                'Setset_Location_wide_22_1769017632677 1.png'
            ],
            'rocky-beach': [
                'Setset_RonDorff_ibiza_260215_2117_01.png',
                'Setset_RonDorff_ibiza_260215_2117_03.png',
                'Setset_RonDorff_ibiza_260215_2117_04.png',
                'Setset_RonDorff_ibiza_260215_2117_05.png',
                'Setset_RonDorff_ibiza_260215_2117_06.png',
                'Setset_RonDorff_ibiza_260215_2117_07.png',
                'Setset_RonDorff_ibiza_260215_2117_08.png',
                'Setset_RonDorff_ibiza_260215_2117_10.png',
                'Setset_RonDorff_ibiza_260215_2117_11.png',
                'Setset_RonDorff_ibiza_260215_2118_20.png',
                'Setset_RonDorff_ibiza_260215_2118_22.png',
                'Setset_RonDorff_ibiza_260215_2118_23.png',
                'Setset_RonDorff_ibiza_260215_2118_30.png',
                'Setset_RonDorff_ibiza_260215_2118_36.png',
                'Setset_RonDorff_ibiza_260215_2118_40.png',
                'Setset_RonDorff_ibiza_260215_2120_04.png',
                'Setset_RonDorff_ibiza_260215_2120_05.png',
                'Setset_RonDorff_ibiza_260215_2120_06.png',
                'Setset_RonDorff_ibiza_260215_2120_08.png',
                'Setset_RonDorff_ibiza_260215_2120_12.png',
                'Setset_RonDorff_ibiza_260215_2121_04.png',
                'Setset_RonDorff_ibiza_260215_2121_05.png',
                'Setset_RonDorff_ibiza_260215_2121_09.png',
                'Setset_RonDorff_ibiza_260215_2121_10.png',
                'Setset_RonDorff_ibiza_260215_2121_11.png',
                'Setset_RonDorff_ibiza_260215_2121_12.png',
                'Setset_RonDorff_ibiza_260215_2121_16.png',
                'Setset_RonDorff_ibiza_260215_2121_17.png',
                'Setset_RonDorff_ibiza_260215_2122_19.png',
                'Setset_RonDorff_ibiza_260215_2122_25.png',
                'Setset_RonDorff_ibiza_260215_2122_28.png',
                'Setset_RonDorff_ibiza_260215_2122_29.png',
                'Setset_RonDorff_ibiza_260215_2122_32.png',
                'Setset_RonDorff_ibiza_260215_2122_38.png',
                'Setset_RonDorff_ibiza_260215_2122_39.png',
                'Setset_RonDorff_ibiza_260215_2122_40.png',
                'Setset_RonDorff_ibiza_260215_2128_02.png',
                'Setset_RonDorff_ibiza_260215_2128_04.png',
                'Setset_RonDorff_ibiza_260215_2128_11.png',
                'Setset_RonDorff_ibiza_260215_2128_17.png',
                'Setset_RonDorff_ibiza_260215_2128_24.png',
                'Setset_RonDorff_ibiza_260215_2129_29.png',
                'Setset_RonDorff_ibiza_260215_2129_33.png',
                'Setset_RonDorff_ibiza_260215_2131_02.png',
                'Setset_RonDorff_ibiza_260215_2131_03.png',
                'Setset_RonDorff_ibiza_260215_2131_04.png',
                'Setset_RonDorff_ibiza_260215_2131_07.png',
                'Setset_RonDorff_ibiza_260215_2131_11.png',
                'Setset_RonDorff_ibiza_260215_2131_13.png',
                'Setset_RonDorff_rocky-beach_260224_1940_02.png',
                'Setset_RonDorff_rocky-beach_260224_1940_03.png',
                'Setset_RonDorff_rocky-beach_260224_1940_08.png',
                'Setset_RonDorff_rocky-beach_260224_1940_11.png',
                'Setset_RonDorff_rocky-beach_260224_1943_02.png',
                'Setset_RonDorff_rocky-beach_260224_1943_04.png',
                'Setset_RonDorff_rocky-beach_260224_1957_09.png',
                'Setset_RonDorff_rocky-beach_260224_1957_17.png'
            ],
            'architecture-v1': [
                'Setset_Location_3_4_11_1769017979925 1.png',
                'Setset_Location_3_4_12_1769017981652 1.png',
                'Setset_Location_3_4_12_1769018653858 1.png',
                'Setset_Location_3_4_left_07_1768595721045 2.png',
                'Setset_Location_3_4_right_15_1769018656715 1.png',
                'Setset_Location_3_4_right_16_1769018201128 1.png',
                'Setset_Location_3_4_right_16_1769018660698 1.png',
                'Setset_Location_center_02_1768595713242 2.png',
                'Setset_Location_center_03_1769024890410 1.png',
                'Setset_Location_center_04_1769018176460 1.png',
                'Setset_Location_center_04_1769018641273 1.png',
                'Setset_Location_center_24_1769017999834 1.png',
                'Setset_Location_center_24_1769018193084 2.png',
                'Setset_Location_center_24_1769018669930 2.png',
                'Setset_Location_depth_09_1769018648389 1.png',
                'Setset_Location_depth_29_1769018186910 1.png',
                'Setset_Location_foreground_20_1769024877914 1.png',
                'Setset_Location_foreground_31_1769018183822 1.png',
                'Setset_Location_left_03_1768595944837 2.png',
                'Setset_Location_low_angle_17_1769017991175 1.png',
                'Setset_Location_low_angle_17_1769018658974 1.png',
                'Setset_Location_right_07_1769018645148 1.png',
                'Setset_Location_right_08_1768596493361 3.png',
                'Setset_Location_right_08_1769017976707 1.png',
                'Setset_Location_right_08_1769024901692 1.png',
                'Setset_Location_wide_01_1769017962075 3.png',
                'Setset_Location_wide_01_1769024913596 2.png',
                'Setset_Location_wide_11_1768594945886 2.png',
                'Setset_Location_wide_22_1769017996899 1.png'
            ],
            'architecture-v2': [
                'Setset_RonDorff_architecture_260215_2134_01.png',
                'Setset_RonDorff_architecture_260215_2134_08.png',
                'Setset_RonDorff_architecture_260215_2134_10.png',
                'Setset_RonDorff_architecture_260215_2134_11.png',
                'Setset_RonDorff_architecture_260215_2134_15.png',
                'Setset_RonDorff_architecture_260215_2134_23.png',
                'Setset_RonDorff_architecture_260215_2134_27.png',
                'Setset_RonDorff_architecture_260215_2134_39.png',
                'Setset_RonDorff_architecture_260215_2140_01.png',
                'Setset_RonDorff_architecture_260215_2140_09.png',
                'Setset_RonDorff_architecture_260215_2140_11.png',
                'Setset_RonDorff_architecture_260215_2140_15.png',
                'Setset_RonDorff_architecture_260215_2140_19.png',
                'Setset_RonDorff_architecture_260215_2140_33.png',
                'Setset_RonDorff_architecture_260215_2140_38.png',
                'Setset_RonDorff_architecture_260215_2151_07.png',
                'Setset_RonDorff_architecture_260215_2151_10.png',
                'Setset_RonDorff_architecture_260215_2152_31.png',
                'Setset_RonDorff_architecture_260215_2156_01.png',
                'Setset_RonDorff_architecture_260215_2156_04.png',
                'Setset_RonDorff_architecture_260215_2156_07.png',
                'Setset_RonDorff_architecture_260215_2156_11.png',
                'Setset_RonDorff_architecture_260215_2156_19.png',
                'Setset_RonDorff_architecture_260215_2156_20.png',
                'Setset_RonDorff_architecture_260215_2156_26.png',
                'Setset_RonDorff_architecture_260215_2204_10.png',
                'Setset_RonDorff_architecture_260215_2209_02.png',
                'Setset_RonDorff_architecture_260215_2209_04.png',
                'Setset_RonDorff_architecture_260215_2209_10.png',
                'Setset_RonDorff_architecture_260215_2209_14.png',
                'Setset_RonDorff_architecture_260215_2209_24.png',
                'Setset_RonDorff_architecture_260215_2209_27.png',
                'Setset_RonDorff_architecture_260215_2209_32.png',
                'Setset_RonDorff_architecture_260215_2209_39.png'
            ]
        };

        // Helper to get folder for a filename
        function getEnvFolder(filename) {
            for (const [folder, images] of Object.entries(ENV_FOLDERS)) {
                if (images.includes(filename)) return folder;
            }
            return null;
        }

        // Legacy aliases for backwards compatibility
        const BEACH_IMAGES = ENV_FOLDERS['black-sand-beach'];
        const ARCHITECTURE_IMAGES = ENV_FOLDERS['architecture-v1'];

        // ========== STATE ==========
        const state = {
            selectedModels: [],
            modelTab: 'rondorff', // 'rondorff' or 'setset'
            selectedProducts: {}, // { productId: groupNumber (1-4) }
            selectedOutfits: [], // Array of selected outfit IDs
            customProducts: [], // Array of { url, file, analysis, group }
            productTab: 'styling', // 'styling', 'rondorff', or 'upload'
            environments: [], // Array of { url, file, analysis }
            selectedPresetEnvs: [], // Array of preset image filenames
            envTab: 'rocky-beach', // Default to rocky beach
            ratio: '16:9',
            seeds: 1,
            duoPercent: 0,
            interactionLevel: 1, // 0=Low, 1=Medium, 2=High, 3=Random
            dynamicLevel: 1, // 0=Low, 1=Medium, 2=High, 3=Random
            copyPosePercent: 50, // 0-100% chance to copy pose from environment image
            cinematicMode: false,
            describeEnvOnly: false, // Don't use env image, just describe it
            additionalPrompt: '',
            sandalsPercent: 0, // 0-100% chance of sandals vs barefoot
            groupNotes: { 1: '', 2: '', 3: '', 4: '' }, // Notes per product group for Gemini enhancement
            results: [],
            modelFalUrls: {},
            productFalUrls: {},
            customProductFalUrls: {},
            presetEnvFalUrls: {}
        };

        // Batch counter for dividers
        let batchCounter = 0;

        // ========== DOM ==========
        const elements = {
            modelTabs: document.getElementById('model-tabs'),
            modelGridRondorff: document.getElementById('model-grid-rondorff'),
            modelGridSetset: document.getElementById('model-grid-setset'),
            modelPanelRondorff: document.getElementById('model-panel-rondorff'),
            modelPanelSetset: document.getElementById('model-panel-setset'),
            productTabs: document.getElementById('product-tabs'),
            productGrid: document.getElementById('product-grid'),
            customProductGrid: document.getElementById('custom-product-grid'),
            gridColsSlider: document.getElementById('grid-cols-slider'),
            gridColsValue: document.getElementById('grid-cols-value'),
            productPanelRondorff: document.getElementById('product-panel-rondorff'),
            productPanelStyling: document.getElementById('product-panel-styling'),
            outfitGrid: document.getElementById('outfit-grid'),
            productPanelUpload: document.getElementById('product-panel-upload'),
            productFileInput: document.getElementById('product-file-input'),
            groupNotesSection: document.getElementById('group-notes-section'),
            groupNotesGrid: document.getElementById('group-notes-grid'),
            environmentGrid: document.getElementById('environment-grid'),
            envFileInput: document.getElementById('env-file-input'),
            envTabs: document.querySelectorAll('.env-tab'),
            envUploadPanel: document.getElementById('env-upload-panel'),
            envBeachPanel: document.getElementById('env-beach-panel'),
            envArchitecturePanel: document.getElementById('env-architecture-panel'),
            beachGrid: document.getElementById('beach-grid'),
            architectureGrid: document.getElementById('architecture-grid'),
            additionalPrompt: document.getElementById('additional-prompt'),
            ratioButtons: document.getElementById('ratio-buttons'),
            seedsButtons: document.getElementById('seeds-buttons'),
            duoSlider: document.getElementById('duo-slider'),
            duoValue: document.getElementById('duo-value'),
            interactionSlider: document.getElementById('interaction-slider'),
            interactionValue: document.getElementById('interaction-value'),
            dynamicSlider: document.getElementById('dynamic-slider'),
            dynamicValue: document.getElementById('dynamic-value'),
            sandalsSlider: document.getElementById('sandals-slider'),
            sandalsValue: document.getElementById('sandals-value'),
            copyPoseSlider: document.getElementById('copy-pose-slider'),
            copyPoseValue: document.getElementById('copy-pose-value'),
            cinematicToggle: document.getElementById('cinematic-toggle'),
            describeOnlyToggle: document.getElementById('describe-only-toggle'),
            selectionSummary: document.getElementById('selection-summary'),
            generateBtn: document.getElementById('generate-btn'),
            loader: document.getElementById('loader'),
            loaderMessage: document.getElementById('loader-message'),
            loaderProgress: document.getElementById('loader-progress'),
            progressSection: document.getElementById('progress-section'),
            progressTitle: document.getElementById('progress-title'),
            progressCount: document.getElementById('progress-count'),
            progressBar: document.getElementById('progress-bar'),
            resultsSection: document.getElementById('results-section'),
            resultsGrid: document.getElementById('results-grid')
        };

        // Focused env slot for paste
        let focusedEnvSlot = null;

        // Init lightbox with proxy download
        const lightbox = new Lightbox({
            onDownload: async (url, filename) => {
                try {
                    // Handle data URLs directly (base64 from Gemini)
                    if (url.startsWith('data:')) {
                        const response = await fetch(url);
                        const blob = await response.blob();
                        const blobUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(blobUrl);
                        return;
                    }

                    const proxyUrl = `/api/proxy-download?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error('Proxy failed');
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(blobUrl);
                } catch (err) {
                    console.error('Lightbox download failed:', err);
                    // Fallback to direct download attempt
                    try {
                        const response = await fetch(url);
                        const blob = await response.blob();
                        const blobUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(blobUrl);
                    } catch (e2) {
                        console.error('Direct download also failed:', e2);
                        window.open(url, '_blank');
                    }
                }
            }
        });

        // ========== RENDER ==========
        function renderModels() {
            // Render Ron Dorff models
            elements.modelGridRondorff.innerHTML = '';
            RONDORFF_MODELS.forEach(model => {
                const card = document.createElement('div');
                card.className = 'model-card';
                card.dataset.id = model.id;
                card.dataset.source = 'rondorff';
                if (state.selectedModels.includes(model.id)) card.classList.add('selected');
                card.innerHTML = `
                    <img src="${model.thumb}" alt="${model.name}">
                    <div class="model-name">${model.name}</div>
                `;
                card.addEventListener('click', () => toggleModel(model.id, 'rondorff'));
                elements.modelGridRondorff.appendChild(card);
            });

            // Render Setset models
            elements.modelGridSetset.innerHTML = '';
            SETSET_MODELS.forEach(model => {
                const card = document.createElement('div');
                card.className = 'model-card';
                card.dataset.id = model.id;
                card.dataset.source = 'setset';
                if (state.selectedModels.includes(model.id)) card.classList.add('selected');
                card.innerHTML = `
                    <img src="${model.thumb}" alt="${model.name}">
                    <div class="model-name">${model.name.split(' ')[0]}</div>
                `;
                card.addEventListener('click', () => toggleModel(model.id, 'setset'));
                elements.modelGridSetset.appendChild(card);
            });
        }

        function renderProducts() {
            elements.productGrid.innerHTML = '';
            PRODUCTS.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.id = product.id;
                const group = state.selectedProducts[product.id] || 0;
                if (group > 0) card.classList.add('has-group');

                card.innerHTML = `
                    <div class="product-name">${product.name}</div>
                    <img class="product-image" src="${product.thumb}" alt="${product.name}">
                    <div class="group-buttons">
                        <button class="group-btn g1 ${group === 1 ? 'active' : ''}" data-group="1">1</button>
                        <button class="group-btn g2 ${group === 2 ? 'active' : ''}" data-group="2">2</button>
                        <button class="group-btn g3 ${group === 3 ? 'active' : ''}" data-group="3">3</button>
                        <button class="group-btn g4 ${group === 4 ? 'active' : ''}" data-group="4">4</button>
                    </div>
                `;

                // Group button clicks
                card.querySelectorAll('.group-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const groupNum = parseInt(btn.dataset.group);
                        setProductGroup(product.id, groupNum);
                    });
                });

                elements.productGrid.appendChild(card);
            });
        }

        // Render group notes based on active groups
        function renderGroupNotes() {
            // Get all active groups from products and custom products
            const presetGroups = new Set(Object.values(state.selectedProducts));
            const customGroups = new Set(state.customProducts.filter(p => p && p.group > 0).map(p => p.group));
            const activeGroups = new Set([...presetGroups, ...customGroups]);

            elements.groupNotesGrid.innerHTML = '';

            for (let g = 1; g <= 4; g++) {
                const isActive = activeGroups.has(g);
                const item = document.createElement('div');
                item.className = `group-note-item${isActive ? '' : ' inactive'}`;

                item.innerHTML = `
                    <div class="group-note-label">
                        <span class="dot g${g}"></span>
                        <span>Group ${g}</span>
                    </div>
                    <textarea class="group-note-input" id="group-note-${g}"
                        placeholder="${isActive ? 'e.g., Make sure the back looks hairy...' : 'No products in this group'}"
                        ${isActive ? '' : 'disabled'}>${state.groupNotes[g] || ''}</textarea>
                `;

                // Add input listener
                const textarea = item.querySelector('textarea');
                textarea.addEventListener('input', (e) => {
                    state.groupNotes[g] = e.target.value;
                });

                elements.groupNotesGrid.appendChild(item);
            }
        }

        function renderOutfits() {
            elements.outfitGrid.innerHTML = '';
            OUTFITS.forEach((outfit, index) => {
                const card = document.createElement('div');
                card.className = 'outfit-card';
                card.dataset.id = outfit.id;
                const isSelected = state.selectedOutfits.includes(outfit.id);
                if (isSelected) card.classList.add('selected');

                // Build thumbnail HTML for each product in the outfit
                const thumbsHtml = outfit.products.map(productId => {
                    if (productId === 'white-tee') {
                        return `<div class="outfit-thumb placeholder">T</div>`;
                    }
                    const product = PRODUCTS.find(p => p.id === productId);
                    if (product) {
                        return `<img class="outfit-thumb" src="${product.thumb}" alt="${product.name}">`;
                    }
                    return `<div class="outfit-thumb placeholder">?</div>`;
                }).join('');

                const outfitNum = String(index + 1).padStart(2, '0');
                card.innerHTML = `
                    <div class="outfit-number">Style ${outfitNum}</div>
                    <div class="outfit-thumbs">${thumbsHtml}</div>
                    <div class="outfit-name">${outfit.name}</div>
                `;

                // Click to toggle selection
                card.addEventListener('click', () => {
                    const idx = state.selectedOutfits.indexOf(outfit.id);
                    if (idx >= 0) {
                        state.selectedOutfits.splice(idx, 1);
                        card.classList.remove('selected');
                    } else {
                        state.selectedOutfits.push(outfit.id);
                        card.classList.add('selected');
                    }
                    updateSummary();
                });

                elements.outfitGrid.appendChild(card);
            });
        }

        // Track focused custom product slot for paste
        let focusedCustomProductSlot = null;

        function renderCustomProducts() {
            elements.customProductGrid.innerHTML = '';
            for (let i = 0; i < 7; i++) {
                const slot = document.createElement('div');
                slot.className = 'custom-product-slot';
                slot.dataset.index = i;
                slot.tabIndex = 0; // Make focusable for paste

                const customProduct = state.customProducts[i];
                if (customProduct) {
                    slot.classList.add('filled');
                    if (customProduct.group > 0) slot.classList.add('has-group');

                    const group = customProduct.group || 0;
                    slot.innerHTML = `
                        <img src="${customProduct.url}" alt="Product">
                        <button class="remove-btn">&times;</button>
                        <div class="group-buttons">
                            <button class="group-btn g1 ${group === 1 ? 'active' : ''}" data-group="1">1</button>
                            <button class="group-btn g2 ${group === 2 ? 'active' : ''}" data-group="2">2</button>
                            <button class="group-btn g3 ${group === 3 ? 'active' : ''}" data-group="3">3</button>
                            <button class="group-btn g4 ${group === 4 ? 'active' : ''}" data-group="4">4</button>
                        </div>
                    `;

                    // Remove button handler
                    slot.querySelector('.remove-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeCustomProduct(i);
                    });

                    // Group button handlers
                    slot.querySelectorAll('.group-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const groupNum = parseInt(btn.dataset.group);
                            setCustomProductGroup(i, groupNum);
                        });
                    });
                } else {
                    slot.innerHTML = `
                        <div class="placeholder">
                            <div>+ Click & paste</div>
                            <div class="placeholder-hint">or drag & drop</div>
                        </div>
                    `;
                }

                // Focus handling for paste
                slot.addEventListener('focus', () => {
                    focusedCustomProductSlot = i;
                    slot.classList.add('paste-ready');
                });
                slot.addEventListener('blur', () => {
                    slot.classList.remove('paste-ready');
                });

                slot.addEventListener('click', () => {
                    if (!state.customProducts[i]) {
                        slot.focus();
                    }
                });

                // Drag & drop
                slot.addEventListener('dragover', (e) => { e.preventDefault(); slot.style.borderColor = 'var(--jet)'; });
                slot.addEventListener('dragleave', () => { slot.style.borderColor = ''; });
                slot.addEventListener('drop', (e) => handleCustomProductDrop(e, i));

                elements.customProductGrid.appendChild(slot);
            }
        }

        function handleCustomProductDrop(e, index) {
            e.preventDefault();
            e.target.closest('.custom-product-slot').style.borderColor = '';
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if (files.length > 0) {
                processCustomProductFile(files[0], index);
            }
        }

        function processCustomProductFile(file, index) {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.customProducts[index] = {
                    url: e.target.result,
                    file: file,
                    analysis: null,
                    group: 0,
                    falUrl: null
                };
                renderCustomProducts();
                updateSummary();
            };
            reader.readAsDataURL(file);
        }

        function removeCustomProduct(index) {
            state.customProducts.splice(index, 1);
            renderCustomProducts();
            updateSummary();
        }

        function setCustomProductGroup(index, groupNum) {
            const current = state.customProducts[index].group || 0;
            if (current === groupNum) {
                state.customProducts[index].group = 0; // Toggle off
            } else {
                state.customProducts[index].group = groupNum;
            }
            renderCustomProducts();
            updateSummary();
        }

        function renderEnvironments() {
            elements.environmentGrid.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const slot = document.createElement('div');
                slot.className = 'env-slot';
                slot.dataset.index = i;
                slot.tabIndex = 0; // Make focusable for paste

                if (state.environments[i]) {
                    slot.classList.add('filled');
                    slot.innerHTML = `
                        <img src="${state.environments[i].url}" alt="Environment">
                        <button class="remove-btn" onclick="removeEnvironment(${i}); event.stopPropagation();">&times;</button>
                    `;
                } else {
                    slot.innerHTML = `
                        <div class="placeholder">
                            <div>+ Click & paste</div>
                            <div class="placeholder-hint">or drag & drop</div>
                        </div>
                    `;
                }

                // Focus handling for paste
                slot.addEventListener('focus', () => {
                    focusedEnvSlot = i;
                    slot.classList.add('paste-ready');
                });
                slot.addEventListener('blur', () => {
                    slot.classList.remove('paste-ready');
                });

                slot.addEventListener('click', () => {
                    if (!state.environments[i]) {
                        slot.focus();
                    }
                });

                // Drag & drop
                slot.addEventListener('dragover', (e) => { e.preventDefault(); slot.style.borderColor = 'var(--jet)'; });
                slot.addEventListener('dragleave', () => { slot.style.borderColor = ''; });
                slot.addEventListener('drop', (e) => handleEnvDrop(e, i));

                elements.environmentGrid.appendChild(slot);
            }
        }

        function renderEnvGrid(folder) {
            const gridId = `${folder}-grid`;
            const grid = document.getElementById(gridId);
            if (!grid) return;

            grid.innerHTML = '';
            const images = ENV_FOLDERS[folder] || [];
            images.forEach(filename => {
                const item = document.createElement('div');
                item.className = 'preset-env-item';
                item.dataset.filename = filename;
                item.dataset.folder = folder;
                if (state.selectedPresetEnvs.includes(filename)) {
                    item.classList.add('selected');
                }
                item.innerHTML = `<img src="/assets/brand/rondorff/environments/${folder}/${encodeURIComponent(filename)}" alt="${folder}">`;
                item.addEventListener('click', () => togglePresetEnv(filename));
                grid.appendChild(item);
            });
        }

        function renderPresetEnvironments() {
            Object.keys(ENV_FOLDERS).forEach(folder => renderEnvGrid(folder));
        }

        function togglePresetEnv(filename) {
            const idx = state.selectedPresetEnvs.indexOf(filename);
            if (idx >= 0) {
                state.selectedPresetEnvs.splice(idx, 1);
            } else {
                state.selectedPresetEnvs.push(filename);
            }
            renderPresetEnvironments();
            updatePresetCounts();
            updateSummary();
        }

        function updatePresetCounts() {
            Object.keys(ENV_FOLDERS).forEach(folder => {
                const images = ENV_FOLDERS[folder];
                const count = state.selectedPresetEnvs.filter(f => images.includes(f)).length;
                const countEl = document.getElementById(`${folder}-count`);
                if (countEl) countEl.textContent = `${count} selected`;
            });
        }

        function deselectFolder(folder) {
            const images = ENV_FOLDERS[folder] || [];
            state.selectedPresetEnvs = state.selectedPresetEnvs.filter(f => !images.includes(f));
            renderPresetEnvironments();
            updatePresetCounts();
            updateSummary();
        }

        // Deselect buttons for each folder
        Object.keys(ENV_FOLDERS).forEach(folder => {
            const btn = document.getElementById(`deselect-${folder}`);
            if (btn) btn.addEventListener('click', () => deselectFolder(folder));
        });

        function switchEnvTab(tab) {
            state.envTab = tab;
            elements.envTabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            elements.envUploadPanel.style.display = tab === 'upload' ? 'block' : 'none';
            // Hide all env panels then show the selected one
            Object.keys(ENV_FOLDERS).forEach(folder => {
                const panel = document.getElementById(`env-${folder}-panel`);
                if (panel) panel.style.display = tab === folder ? 'block' : 'none';
            });
            // Hide grid size slider on Upload tab, show on preset tabs
            const gridSizeEl = document.querySelector('.env-grid-size');
            if (gridSizeEl) {
                gridSizeEl.style.display = tab === 'upload' ? 'none' : 'flex';
            }
        }

        // Tab click handlers
        document.querySelectorAll('.env-tab').forEach(tab => {
            tab.addEventListener('click', () => switchEnvTab(tab.dataset.tab));
        });

        // Grid size slider
        const envGridSlider = document.getElementById('env-grid-slider');
        const envGridValue = document.getElementById('env-grid-value');
        if (envGridSlider) {
            envGridSlider.addEventListener('input', () => {
                const cols = envGridSlider.value;
                envGridValue.textContent = cols;
                document.querySelectorAll('.preset-env-grid').forEach(grid => {
                    grid.style.setProperty('--env-grid-cols', cols);
                });
            });
        }

        // ========== HANDLERS ==========
        function toggleModel(id, source) {
            const idx = state.selectedModels.indexOf(id);
            if (idx >= 0) {
                state.selectedModels.splice(idx, 1);
            } else {
                state.selectedModels.push(id);
            }
            updateModelUI();
            updateSummary();
        }

        // Get model object by id (from either RONDORFF_MODELS or SETSET_MODELS)
        function getModelById(id) {
            return RONDORFF_MODELS.find(m => m.id === id) || SETSET_MODELS.find(m => m.id === id);
        }

        function setProductGroup(productId, groupNum) {
            const current = state.selectedProducts[productId] || 0;
            if (current === groupNum) {
                // Toggle off
                delete state.selectedProducts[productId];
            } else {
                state.selectedProducts[productId] = groupNum;
            }
            renderProducts();
            updateSummary();
        }

        function updateModelUI() {
            // Update both grids
            document.querySelectorAll('.model-card').forEach(card => {
                card.classList.toggle('selected', state.selectedModels.includes(card.dataset.id));
            });
        }

        // Model tab switching
        function switchModelTab(tab) {
            state.modelTab = tab;
            elements.modelTabs.querySelectorAll('.section-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            elements.modelPanelRondorff.classList.toggle('active', tab === 'rondorff');
            elements.modelPanelSetset.classList.toggle('active', tab === 'setset');
        }

        // Product tab switching
        function switchProductTab(tab) {
            state.productTab = tab;
            elements.productTabs.querySelectorAll('.section-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            elements.productPanelRondorff.classList.toggle('active', tab === 'rondorff');
            elements.productPanelStyling.classList.toggle('active', tab === 'styling');
            elements.productPanelUpload.classList.toggle('active', tab === 'upload');
        }

        function handleEnvDrop(e, index) {
            e.preventDefault();
            e.target.closest('.env-slot').style.borderColor = '';
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if (files.length > 0) {
                processEnvFile(files[0], index);
            }
        }

        // Clipboard paste handler
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;

            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        // Check if we're pasting into custom products
                        if (focusedCustomProductSlot !== null && state.productTab === 'upload') {
                            let slotIndex = focusedCustomProductSlot;
                            if (state.customProducts[slotIndex]) {
                                slotIndex = state.customProducts.findIndex((p, i) => !p);
                                if (slotIndex === -1) slotIndex = state.customProducts.length;
                            }
                            if (slotIndex < 7) {
                                processCustomProductFile(file, slotIndex);
                            }
                            return;
                        }

                        // Otherwise paste into environment
                        let slotIndex = focusedEnvSlot;
                        if (slotIndex === null || state.environments[slotIndex]) {
                            slotIndex = state.environments.findIndex((e, i) => !e);
                            if (slotIndex === -1) slotIndex = 0;
                        }
                        processEnvFile(file, slotIndex);
                    }
                    return;
                }
            }
        });

        elements.envFileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            let slotIndex = focusedEnvSlot || 0;
            files.forEach((file, idx) => {
                if (slotIndex + idx < 5) {
                    processEnvFile(file, slotIndex + idx);
                }
            });
            e.target.value = '';
        });

        async function processEnvFile(file, index) {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.environments[index] = {
                    url: e.target.result,
                    file: file,
                    analysis: null
                };
                renderEnvironments();
                updateSummary();
            };
            reader.readAsDataURL(file);
        }

        window.removeEnvironment = function(index) {
            state.environments.splice(index, 1);
            renderEnvironments();
            updateSummary();
        };

        // Settings handlers
        elements.ratioButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                elements.ratioButtons.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                state.ratio = e.target.dataset.value;
            }
        });

        elements.seedsButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                elements.seedsButtons.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                state.seeds = parseInt(e.target.dataset.value);
                updateSummary();
            }
        });

        elements.duoSlider.addEventListener('input', (e) => {
            state.duoPercent = parseInt(e.target.value);
            elements.duoValue.textContent = `${state.duoPercent}%`;
        });

        elements.interactionSlider.addEventListener('input', (e) => {
            state.interactionLevel = parseInt(e.target.value);
            elements.interactionValue.textContent = LEVEL_LABELS[state.interactionLevel];
        });

        elements.dynamicSlider.addEventListener('input', (e) => {
            state.dynamicLevel = parseInt(e.target.value);
            elements.dynamicValue.textContent = LEVEL_LABELS[state.dynamicLevel];
        });

        elements.sandalsSlider.addEventListener('input', (e) => {
            state.sandalsPercent = parseInt(e.target.value);
            elements.sandalsValue.textContent = `${state.sandalsPercent}%`;
        });

        elements.copyPoseSlider.addEventListener('input', () => {
            state.copyPosePercent = parseInt(elements.copyPoseSlider.value);
            elements.copyPoseValue.textContent = `${state.copyPosePercent}%`;
        });

        elements.cinematicToggle.addEventListener('click', () => {
            state.cinematicMode = !state.cinematicMode;
            elements.cinematicToggle.classList.toggle('active', state.cinematicMode);
        });

        elements.describeOnlyToggle.addEventListener('click', () => {
            state.describeEnvOnly = !state.describeEnvOnly;
            elements.describeOnlyToggle.classList.toggle('active', state.describeEnvOnly);
        });

        function updateSummary() {
            const modelCount = state.selectedModels.length;

            // Count outfits (from styling tab) or groups (from rondorff/upload tabs)
            const outfitCount = state.selectedOutfits.length;
            const presetGroups = new Set(Object.values(state.selectedProducts));
            const customGroups = new Set(state.customProducts.filter(p => p && p.group > 0).map(p => p.group));
            const allGroups = new Set([...presetGroups, ...customGroups]);
            const groupCount = allGroups.size;

            // Use outfits if any are selected, otherwise use product groups
            const productSelection = outfitCount > 0 ? outfitCount : groupCount;
            const productLabel = outfitCount > 0 ? 'outfit' : 'group';

            const uploadedEnvCount = state.environments.filter(e => e).length;
            const presetEnvCount = state.selectedPresetEnvs.length;
            const envCount = uploadedEnvCount + presetEnvCount;
            const totalImages = envCount * state.seeds;

            // Cost estimate: $0.134 per image (Gemini 3 Pro 2K) + ~$0.004 per request for input images
            const costPerImage = 0.134;
            const inputCostPerRequest = 0.004; // ~4 input images at $0.001 each
            const estimatedCost = totalImages * (costPerImage + inputCostPerRequest);
            const costStr = estimatedCost > 0 ? ` (~$${estimatedCost.toFixed(2)})` : '';

            elements.selectionSummary.textContent = `${modelCount} model${modelCount !== 1 ? 's' : ''}, ${productSelection} ${productLabel}${productSelection !== 1 ? 's' : ''}, ${envCount} env${envCount !== 1 ? 's' : ''} = ${totalImages} image${totalImages !== 1 ? 's' : ''}${costStr}`;
            elements.generateBtn.disabled = modelCount === 0 || (groupCount === 0 && outfitCount === 0) || envCount === 0;

            // Update group notes UI when products change
            renderGroupNotes();
        }

        // Additional prompt handler
        elements.additionalPrompt.addEventListener('input', (e) => {
            state.additionalPrompt = e.target.value;
        });

        // ========== GENERATION ==========
        elements.generateBtn.addEventListener('click', generate);

        async function generate() {
            if (state.selectedModels.length === 0) return;
            const uploadedEnvs = state.environments.filter(e => e);
            const hasEnvs = uploadedEnvs.length > 0 || state.selectedPresetEnvs.length > 0;
            if (!hasEnvs) return;

            // Reset pose counter for new generation
            poseCounter = 0;

            // Build combined environments list
            const allEnvs = [];

            // Add uploaded environments
            uploadedEnvs.forEach((env, i) => {
                allEnvs.push({
                    type: 'uploaded',
                    url: env.url,
                    file: env.file,
                    falUrl: env.falUrl,
                    analysis: env.analysis
                });
            });

            // Add preset environments
            state.selectedPresetEnvs.forEach(filename => {
                const folder = getEnvFolder(filename) || 'black-sand-beach';
                allEnvs.push({
                    type: 'preset',
                    filename: filename,
                    folder: folder,
                    path: `/assets/brand/rondorff/environments/${folder}/${encodeURIComponent(filename)}`,
                    falUrl: state.presetEnvFalUrls[filename] || null,
                    analysis: null
                });
            });

            console.log('');
            console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
            console.log('â•‘     RON DORFF - FEARLESS SUMMER        â•‘');
            console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log(`âš™ï¸ Settings: Seeds=${state.seeds}, Duo=${state.duoPercent}%, Interaction=${state.interactionLevel}%, Cinematic=${state.cinematicMode}`);
            console.log(`ðŸ‘¤ Models: ${state.selectedModels.join(', ')}`);
            console.log(`ðŸ‘• Products: ${Object.keys(state.selectedProducts).length} items in ${new Set(Object.values(state.selectedProducts)).size} groups`);
            console.log(`ðŸ“ Environments: ${allEnvs.length} (${uploadedEnvs.length} uploaded, ${state.selectedPresetEnvs.length} preset)`);
            console.log(`ðŸŽ­ Poses: smart selection based on environment`);
            if (state.additionalPrompt) console.log(`âœ¨ Additional styling: ${state.additionalPrompt}`);
            console.log('');

            // Show loader
            elements.loader.classList.add('visible');
            elements.loaderMessage.textContent = 'Preparing assets...';
            elements.loaderProgress.textContent = 'Uploading model references...';

            // Upload models (parallel) - now supports both MODELS and SETSET_MODELS
            console.log('ðŸ‘¤ Uploading model references...');
            await Promise.all(state.selectedModels.map(async (modelId) => {
                if (!state.modelFalUrls[modelId]) {
                    const model = getModelById(modelId);
                    if (!model) {
                        console.error(`Model ${modelId} not found`);
                        return;
                    }
                    const response = await fetch(model.image);
                    const blob = await response.blob();
                    const file = new File([blob], `${modelId}.jpg`, { type: 'image/jpeg' });
                    const formData = new FormData();
                    formData.append('image', file);
                    const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                    const uploadData = await uploadRes.json();
                    state.modelFalUrls[modelId] = uploadData.url;
                    console.log(`ðŸ“¤ [${model.name}] Uploaded:`, uploadData.url);
                } else {
                    console.log(`âœ“ [${modelId}] Already uploaded`);
                }
            }));

            // Collect all product IDs needed (from both individual selections and outfits)
            const outfitCountForUpload = state.selectedOutfits.length;
            let allProductIdsToUpload = new Set();

            if (outfitCountForUpload > 0) {
                // Using outfits - collect all product IDs from selected outfits
                state.selectedOutfits.forEach(outfitId => {
                    const outfit = OUTFITS.find(o => o.id === outfitId);
                    if (outfit) {
                        outfit.products.forEach(productId => {
                            if (productId !== 'white-tee') { // Skip placeholders
                                allProductIdsToUpload.add(productId);
                            }
                        });
                    }
                });
            } else {
                // Using individual product selections
                allProductIdsToUpload = new Set(Object.keys(state.selectedProducts));
            }

            // If sandals slider > 0, ensure sandals product is uploaded
            if (state.sandalsPercent > 0) {
                allProductIdsToUpload.add('21sn624');
            }

            // Upload preset products (parallel)
            console.log('ðŸ‘• Uploading product images...');
            elements.loaderProgress.textContent = 'Uploading product images...';
            await Promise.all([...allProductIdsToUpload].map(async (productId) => {
                if (!state.productFalUrls[productId]) {
                    const product = PRODUCTS.find(p => p.id === productId);
                    if (!product) return; // Skip if product not found
                    const response = await fetch(product.image);
                    const blob = await response.blob();
                    const file = new File([blob], `${productId}.jpg`, { type: 'image/jpeg' });
                    const formData = new FormData();
                    formData.append('image', file);
                    const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                    const uploadData = await uploadRes.json();
                    state.productFalUrls[productId] = uploadData.url;
                    console.log(`ðŸ“¤ [${product.name}] Uploaded:`, uploadData.url);
                } else {
                    console.log(`âœ“ [${productId}] Already uploaded`);
                }
            }));

            // Upload custom products (parallel)
            const customProductsWithGroups = state.customProducts.filter(p => p && p.group > 0);
            if (customProductsWithGroups.length > 0) {
                console.log('ðŸ‘• Uploading custom products...');
                elements.loaderProgress.textContent = 'Uploading custom products...';
                await Promise.all(customProductsWithGroups.map(async (customProduct, i) => {
                    if (!customProduct.falUrl) {
                        const formData = new FormData();
                        formData.append('image', customProduct.file);
                        const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                        const uploadData = await uploadRes.json();
                        customProduct.falUrl = uploadData.url;
                        console.log(`ðŸ“¤ [Custom Product ${i + 1}] Uploaded:`, uploadData.url);
                    }
                }));
            }

            // Upload environments (parallel)
            console.log('ðŸ“ Uploading environments...');
            elements.loaderProgress.textContent = 'Uploading environments...';
            await Promise.all(allEnvs.map(async (env, i) => {
                if (!env.falUrl) {
                    if (env.type === 'uploaded') {
                        const formData = new FormData();
                        formData.append('image', env.file);
                        const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                        const uploadData = await uploadRes.json();
                        env.falUrl = uploadData.url;
                        // Also update the original uploaded env
                        const originalIdx = uploadedEnvs.findIndex(e => e.file === env.file);
                        if (originalIdx >= 0) uploadedEnvs[originalIdx].falUrl = uploadData.url;
                    } else {
                        // Preset environment - fetch and upload
                        const response = await fetch(env.path);
                        const blob = await response.blob();
                        const file = new File([blob], env.filename, { type: 'image/png' });
                        const formData = new FormData();
                        formData.append('image', file);
                        const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                        const uploadData = await uploadRes.json();
                        env.falUrl = uploadData.url;
                        state.presetEnvFalUrls[env.filename] = uploadData.url;
                    }
                    console.log(`ðŸ“¤ [Env ${i + 1}] Uploaded:`, env.falUrl);
                }
            }));

            // Analyze environments (parallel)
            console.log('ðŸ” Analyzing environments...');
            elements.loaderProgress.textContent = 'Analyzing environments...';
            await Promise.all(allEnvs.map(async (env, i) => {
                if (!env.analysis) {
                    env.analysis = await analyzeEnvironment(env.falUrl, i);
                }
            }));
            console.log('âœ… All environments analyzed');

            // Build tasks - keep loader visible, also show progress and results sections
            elements.loaderMessage.textContent = 'Building tasks...';
            elements.loaderProgress.textContent = 'Creating generation queue...';
            elements.progressSection.style.display = 'block';
            elements.resultsSection.style.display = 'block';

            // Get product groups (from outfits OR from individual selections)
            const groups = {};
            const totalOutfitCount = state.selectedOutfits.length;

            if (totalOutfitCount > 0) {
                // Using outfits - each selected outfit becomes a group
                // Store outfit index for naming (Style 01, Style 02, etc.)
                state.selectedOutfits.forEach((outfitId, idx) => {
                    const outfit = OUTFITS.find(o => o.id === outfitId);
                    if (outfit) {
                        const outfitIndex = OUTFITS.findIndex(o => o.id === outfitId);
                        const groupNum = idx + 1;
                        groups[groupNum] = outfit.products
                            .filter(pid => pid !== 'white-tee') // Skip placeholder products
                            .map(productId => ({ type: 'preset', id: productId, outfit: outfit, styleNum: outfitIndex + 1 }));
                    }
                });
            } else {
                // Using individual product selections
                for (const [productId, groupNum] of Object.entries(state.selectedProducts)) {
                    if (!groups[groupNum]) groups[groupNum] = [];
                    groups[groupNum].push({ type: 'preset', id: productId });
                }

                // Add custom products to groups
                state.customProducts.forEach((customProduct, idx) => {
                    if (customProduct && customProduct.group > 0) {
                        const groupNum = customProduct.group;
                        if (!groups[groupNum]) groups[groupNum] = [];
                        groups[groupNum].push({ type: 'custom', index: idx, product: customProduct });
                    }
                });
            }

            const groupNumbers = Object.keys(groups).map(Number).sort();

            // Build tasks: one per environment Ã— seeds
            const tasks = [];
            let soloModelIndex = 0; // Rotate through models for solo shots
            allEnvs.forEach((env, envIdx) => {
                for (let seed = 0; seed < state.seeds; seed++) {
                    // Determine if this is a duo shot based on duoPercent
                    const isDuo = state.selectedModels.length >= 2 && Math.random() * 100 < state.duoPercent;

                    // Assign groups to this image
                    let assignedGroups;
                    if (isDuo && groupNumbers.length >= 2) {
                        // Pick 2 random different groups for duo
                        const shuffled = [...groupNumbers].sort(() => Math.random() - 0.5);
                        assignedGroups = [shuffled[0], shuffled[1]];
                    } else {
                        // Pick random group for solo
                        assignedGroups = [groupNumbers[Math.floor(Math.random() * groupNumbers.length)]];
                    }

                    // Get styleNum from the first assigned group (for naming)
                    const primaryGroup = assignedGroups[0];
                    const styleNum = groups[primaryGroup] && groups[primaryGroup][0] && groups[primaryGroup][0].styleNum
                        ? groups[primaryGroup][0].styleNum
                        : primaryGroup;

                    // For solo shots, rotate through selected models
                    const modelIndex = isDuo ? 0 : soloModelIndex++;

                    tasks.push({
                        env,
                        envIdx,
                        seed,
                        isDuo,
                        modelIndex,
                        assignedGroups,
                        groups,
                        styleNum
                    });
                }
            });

            // Log task summary
            const duoCount = tasks.filter(t => t.isDuo).length;
            const soloCount = tasks.length - duoCount;
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log(`ðŸš€ Starting generation: ${tasks.length} images`);
            console.log(`   Solo: ${soloCount} | Duo: ${duoCount}`);
            console.log(`   Groups: ${groupNumbers.join(', ')}`);
            console.log(`   Environments: ${allEnvs.length}`);
            console.log(`   Seeds: ${state.seeds}`);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            // Create batch divider
            batchCounter++;
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            const modelNames = state.selectedModels.map(id => {
                const m = getModelById(id);
                return m ? m.name.split(' ')[0] : id;
            }).join(' + ');
            const divider = document.createElement('div');
            divider.className = 'batch-divider';
            divider.textContent = `Batch ${batchCounter} â€¢ ${modelNames} â€¢ ${state.ratio} â€¢ ${timeStr}`;
            elements.resultsGrid.insertBefore(divider, elements.resultsGrid.firstChild);

            // Update loader with task creation status
            elements.loaderMessage.textContent = 'Creating prompts...';
            elements.loaderProgress.textContent = `Preparing ${tasks.length} images...`;
            elements.progressTitle.textContent = 'Preparing...';
            elements.progressCount.textContent = `0 / ${tasks.length}`;
            elements.progressBar.style.width = '0%';

            let completed = 0;

            // Process ALL in parallel for maximum speed
            elements.loaderMessage.textContent = 'Generating images...';
            elements.loaderProgress.textContent = `Sending ${tasks.length} requests in parallel...`;
            elements.progressTitle.textContent = 'Generating...';
            elements.progressCount.textContent = `${completed} / ${tasks.length}`;

            console.log(`ðŸš€ Launching ALL ${tasks.length} requests in parallel...`);
            const startTime = Date.now();

            // Pre-build all prompts and image URLs BEFORE launching requests
            // Check if any group notes need enhancement
            const hasGroupNotes = Object.values(state.groupNotes).some(note => note && note.trim());

            let preparedTasks;
            if (hasGroupNotes) {
                console.log('ðŸ“ Group notes detected, enhancing prompts with Gemini...');
                preparedTasks = await Promise.all(tasks.map(async task => {
                    task.useSandals = Math.random() * 100 < state.sandalsPercent;
                    const { prompt: basePrompt, usedCopyPose } = buildPrompt(task);
                    const imageUrls = buildImageUrls(task);
                    // Enhance prompt with group notes if applicable
                    const prompt = await enhancePromptWithGroupNotes(basePrompt, state.groupNotes, task.assignedGroups);
                    return { ...task, prompt, usedCopyPose, imageUrls };
                }));
            } else {
                preparedTasks = tasks.map(task => {
                    task.useSandals = Math.random() * 100 < state.sandalsPercent;
                    const { prompt, usedCopyPose } = buildPrompt(task);
                    const imageUrls = buildImageUrls(task);
                    return { ...task, prompt, usedCopyPose, imageUrls };
                });
            }

            console.log(`ðŸ“‹ All ${preparedTasks.length} prompts prepared, launching fetch requests NOW...`);

            await Promise.all(preparedTasks.map(async (task) => {
                const taskId = `Env${task.envIdx + 1}-Seed${task.seed + 1}`;
                try {
                    console.log(`ðŸŒ [${taskId}] Sending request...`);

                    const response = await fetch('/api/remix-gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'gemini-3-pro',
                            prompt: task.prompt,
                            image_urls: task.imageUrls,
                            aspect_ratio: state.ratio,
                            resolution: '2K'
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.images && data.images.length > 0) {
                            console.log(`âœ… [${taskId}] Generated ${data.images.length} image(s)`);
                            data.images.forEach(img => {
                                addResult({
                                    url: img.url,
                                    prompt: task.prompt,
                                    envIdx: task.envIdx,
                                    isDuo: task.isDuo,
                                    styleNum: task.styleNum,
                                    usedCopyPose: task.usedCopyPose,
                                    inputImages: task.imageUrls // Store input images for debugging
                                });
                            });
                        } else if (data.blocked) {
                            // Content filter block - log detailed info
                            console.warn(`âš ï¸ [${taskId}] BLOCKED by content filter! Reason: ${data.reason}`);
                            console.warn(`âš ï¸ [${taskId}] Style: ${task.styleNum}, Prompt: ${task.prompt.substring(0, 100)}...`);
                            if (data.safetyRatings) {
                                console.warn(`âš ï¸ [${taskId}] Safety ratings:`, data.safetyRatings);
                            }
                        } else {
                            console.error(`âŒ [${taskId}] No images in response (may be content filtered):`, data);
                        }
                    } else {
                        const errorText = await response.text();
                        console.error(`âŒ [${taskId}] Generation failed (${response.status}):`, errorText);
                    }
                } catch (err) {
                    console.error(`âŒ [${taskId}] Generation error:`, err);
                }

                completed++;
                elements.progressCount.textContent = `${completed} / ${tasks.length}`;
                elements.progressBar.style.width = `${(completed / tasks.length) * 100}%`;
                elements.loaderProgress.textContent = `${completed} of ${tasks.length} complete...`;
            }));

            const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
            console.log(`â±ï¸ All ${tasks.length} images completed in ${totalTime}s`);

            // Generation complete - hide loader and update status
            elements.loader.classList.remove('visible');
            elements.progressTitle.textContent = 'Complete!';
            elements.progressCount.textContent = `${completed} / ${tasks.length}`;
            elements.generateBtn.disabled = false;
        }

        // Enhance user's styling notes into richer prompt language
        function enhanceStylingNotes(input) {
            const lower = input.toLowerCase();
            let enhanced = '';

            // Detect and expand common styling keywords
            if (lower.includes('90s') || lower.includes('nineties') || lower.includes('vintage')) {
                enhanced += 'Captured with the aesthetic of 90s fashion photography, film grain texture, slightly desaturated warm tones, nostalgic analog feel. ';
            }
            if (lower.includes('flash') || lower.includes('strobe')) {
                enhanced += 'Direct flash photography creating harsh shadows, blown-out highlights, raw and immediate feel like paparazzi or snapshot aesthetic. ';
            }
            if (lower.includes('glow') || lower.includes('glowy') || lower.includes('dreamy')) {
                enhanced += 'Soft glowing skin with ethereal light diffusion, dreamy haze, gentle highlights wrapping around the subject. ';
            }
            if (lower.includes('film') || lower.includes('analog') || lower.includes('grain')) {
                enhanced += 'Shot on film with natural grain, organic color rendering, subtle imperfections that add character and warmth. ';
            }
            if (lower.includes('golden') || lower.includes('sunset') || lower.includes('magic hour')) {
                enhanced += 'Bathed in golden hour light, warm amber tones, long shadows, sun flares catching the lens. ';
            }
            if (lower.includes('moody') || lower.includes('dark') || lower.includes('shadow')) {
                enhanced += 'Moody atmospheric lighting with deep shadows, dramatic contrast, mysterious and contemplative mood. ';
            }
            if (lower.includes('bright') || lower.includes('airy') || lower.includes('light')) {
                enhanced += 'Bright airy lighting, open shadows, fresh and clean aesthetic with luminous quality. ';
            }
            if (lower.includes('raw') || lower.includes('gritty') || lower.includes('real')) {
                enhanced += 'Raw unpolished aesthetic, authentic and gritty, imperfect and real, documentary-style honesty. ';
            }
            if (lower.includes('soft') || lower.includes('diffused')) {
                enhanced += 'Soft diffused lighting, gentle gradients, no harsh shadows, flattering and smooth. ';
            }
            if (lower.includes('contras') || lower.includes('punchy')) {
                enhanced += 'High contrast with punchy blacks and bright highlights, bold and graphic quality. ';
            }
            if (lower.includes('desaturate') || lower.includes('muted') || lower.includes('faded')) {
                enhanced += 'Desaturated muted color palette, faded tones, understated and sophisticated. ';
            }
            if (lower.includes('saturate') || lower.includes('vivid') || lower.includes('vibrant')) {
                enhanced += 'Rich saturated colors, vivid and vibrant, bold color presence. ';
            }
            if (lower.includes('backlit') || lower.includes('silhouette') || lower.includes('rim light')) {
                enhanced += 'Backlit with rim lighting around the subject, sun behind creating halo effect, dramatic silhouette edges. ';
            }
            if (lower.includes('natural') || lower.includes('available light')) {
                enhanced += 'Natural available light only, authentic to the environment, no artificial lighting feel. ';
            }
            if (lower.includes('polaroid') || lower.includes('instant')) {
                enhanced += 'Polaroid instant film aesthetic, slightly washed out, soft focus edges, nostalgic snapshot quality. ';
            }
            if (lower.includes('editorial') || lower.includes('magazine') || lower.includes('vogue')) {
                enhanced += 'High fashion editorial quality, magazine-ready, polished yet with artistic edge. ';
            }

            // If no keywords matched, use the input directly but frame it nicely
            if (!enhanced) {
                enhanced = `The image should evoke: ${input}. `;
            }

            console.log(`   âœ¨ Enhanced styling: "${input}" â†’ "${enhanced.substring(0, 80)}..."`);
            return enhanced;
        }

        // Helper to get level value (handles random)
        function getEffectiveLevel(level) {
            if (level === 3) { // Random
                return Math.floor(Math.random() * 3); // 0, 1, or 2
            }
            return level;
        }

        function getLevelKey(level) {
            const keys = ['low', 'medium', 'high'];
            return keys[level];
        }

        async function analyzeEnvironment(imageUrl, envIndex) {
            console.log(`ðŸ” [Env ${envIndex + 1}] Starting analysis...`);

            // Get effective levels (resolve random to actual value)
            const effectiveDynamic = getEffectiveLevel(state.dynamicLevel);
            const effectiveInteraction = getEffectiveLevel(state.interactionLevel);

            // Dynamic level affects pose energy
            const dynamicDescs = [
                'subtle and minimal - standing upright, simple weight shift, relaxed stance',
                'relaxed editorial - casual stance, natural body language, slight movement',
                'expressive and dynamic - strong poses, dramatic angles, active movement'
            ];
            const dynamicDesc = dynamicDescs[effectiveDynamic];

            // Interaction level affects environment engagement
            const interactionDesc = ENV_INTERACTION[getLevelKey(effectiveInteraction)];

            const basePrompt = `Analyze this image for a men's fashion photoshoot.

1. LOCATION (2 sentences): Describe the setting, lighting, and atmosphere.

2. POSE SUGGESTION: Suggest ONE specific pose that works naturally with this environment.
   - Energy level: ${dynamicDesc}
   - Environment interaction: ${interactionDesc}
   Be specific about body position, what the model is doing, and how they engage with the surroundings.

Format your response as:
LOCATION: [description]
POSE: [specific pose suggestion]`;

            try {
                const response = await fetch('/api/analyze-gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_url: imageUrl, prompt: basePrompt })
                });

                if (response.ok) {
                    const data = await response.json();
                    const result = data.content || 'LOCATION: a scenic outdoor location\nPOSE: standing naturally';
                    console.log(`âœ… [Env ${envIndex + 1}] Analysis complete:`);
                    console.log(result);
                    return result;
                } else {
                    console.error(`âŒ [Env ${envIndex + 1}] Analysis failed:`, response.status);
                }
            } catch (err) {
                console.error(`âŒ [Env ${envIndex + 1}] Analysis error:`, err);
            }
            return 'LOCATION: a scenic outdoor location\nPOSE: standing naturally';
        }

        // Enhance prompt with group notes using Gemini
        async function enhancePromptWithGroupNotes(basePrompt, groupNotes, assignedGroups) {
            // Collect notes for assigned groups
            const notesToApply = assignedGroups
                .map(g => state.groupNotes[g])
                .filter(note => note && note.trim());

            if (notesToApply.length === 0) {
                return basePrompt;
            }

            const combinedNotes = notesToApply.join('\n');

            try {
                const response = await fetch('/api/gemini-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        system: 'You are a prompt engineer for AI image generation. Your task is to incorporate user notes into an existing image generation prompt. Keep the enhanced prompt concise and focused. Do not add unnecessary details. Preserve the original structure and intent.',
                        prompt: `Here is the base prompt:\n\n${basePrompt}\n\nHere are the user's additional notes/requirements that MUST be incorporated:\n\n${combinedNotes}\n\nReturn ONLY the enhanced prompt with the notes naturally incorporated. Keep it concise.`
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.content) {
                        console.log('âœ… Prompt enhanced with group notes');
                        return data.content.trim();
                    }
                }
                console.warn('âš ï¸ Failed to enhance prompt, using base prompt');
                return basePrompt;
            } catch (err) {
                console.error('âŒ Error enhancing prompt:', err);
                return basePrompt;
            }
        }

        function buildPrompt(task) {
            const { env, assignedGroups, groups, isDuo, modelIndex } = task;

            // Parse location and pose from environment analysis
            let location = 'scenic outdoor location with warm golden light';
            let suggestedPose = 'standing naturally with relaxed confident stance';

            if (env.analysis) {
                const locationMatch = env.analysis.match(/LOCATION:\s*(.+?)(?=POSE:|$)/si);
                const poseMatch = env.analysis.match(/POSE:\s*(.+?)$/si);

                if (locationMatch) location = locationMatch[1].trim();
                if (poseMatch) suggestedPose = poseMatch[1].trim();

                // Fallback cleanup if no structured format
                if (!locationMatch && !poseMatch) {
                    location = env.analysis.replace(/ACTIONS:.*$/s, '').trim();
                }
            }

            // Get model descriptions - for solo, only the one assigned to this task
            let modelDescs;
            if (isDuo) {
                // Duo: use both selected models
                modelDescs = state.selectedModels.map(id => {
                    const model = getModelById(id);
                    return model ? model.description : 'a fashion model';
                });
            } else {
                // Solo: only the model for this specific task
                const soloModelId = state.selectedModels[modelIndex % state.selectedModels.length];
                const model = getModelById(soloModelId);
                modelDescs = [model ? model.description : 'a fashion model'];
            }

            // Get outfits for each person - with emphasis on exact match
            const outfits = [];
            assignedGroups.forEach((groupNum) => {
                const productItems = groups[groupNum];
                const items = productItems.map(item => {
                    if (item.type === 'preset') {
                        const product = PRODUCTS.find(p => p.id === item.id);
                        return product ? product.description : 'fashion item';
                    } else {
                        // Custom product - use generic description
                        return 'the clothing item shown in the reference image';
                    }
                });
                // Join items and add emphasis for exact matching
                const outfitDescription = items.join(' AND ');
                outfits.push(outfitDescription);
            });

            // Get effective interaction level for this shot
            const effectiveInteraction = getEffectiveLevel(state.interactionLevel);
            const interactionKey = getLevelKey(effectiveInteraction);

            // Check if any briefs are in the assigned groups
            const hasBriefs = assignedGroups.some(groupNum => {
                const productItems = groups[groupNum];
                return productItems.some(item =>
                    item.type === 'preset' && BRIEF_PRODUCT_IDS.includes(item.id)
                );
            });

            // Check if any outfit has noShirt flag (swim-only outfits)
            const isSwimOnly = assignedGroups.some(groupNum => {
                const productItems = groups[groupNum];
                return productItems.some(item =>
                    item.type === 'preset' && item.outfit && item.outfit.noShirt
                );
            });

            // Determine pose strategy based on copyPose slider (0-100%)
            // Roll once per task to decide if we copy pose from environment
            const useCopyPose = Math.random() * 100 < state.copyPosePercent;
            let pose;
            if (useCopyPose && suggestedPose && suggestedPose !== 'standing naturally') {
                // COPY POSE MODE: Use the exact pose from the environment image
                pose = suggestedPose;
                console.log(`   ðŸ“· Copy Pose Mode: Using environment pose`);
            } else if (isDuo) {
                // For duos: combine environment interaction with duo interaction
                const duoInteraction = DUO_INTERACTION[interactionKey];
                const basePose = DUO_POSES[poseCounter % DUO_POSES.length];
                pose = `${basePose}, ${duoInteraction}`;
            } else {
                // Use Ron Dorff poses for solo shots
                pose = RONDORFF_SOLO_POSES[poseCounter % RONDORFF_SOLO_POSES.length];
            }
            poseCounter++;

            // If briefs, force front-facing
            if (hasBriefs) {
                pose = pose + ', MUST be facing camera directly from the front, front view only, no side or back angles';
            }

            // Get framing for cinematic mode
            const framing = state.cinematicMode
                ? CINEMATIC_FRAMINGS[poseCounter % CINEMATIC_FRAMINGS.length]
                : 'full body shot';

            // Footwear - based on sandals decision made per-task
            let footwear;
            if (task.useSandals) {
                // Use the Ron Dorff sandals product
                const sandalsProduct = PRODUCTS.find(p => p.id === '21sn624');
                footwear = sandalsProduct ? `wearing ${sandalsProduct.description}` : 'wearing beige/tan leather strap sandals';
            } else {
                footwear = 'barefoot';
            }

            console.log(`   ðŸŽ­ Pose: ${pose}`);
            console.log(`   ðŸ“ Framing: ${framing}`);
            console.log(`   ðŸ¤ Interaction: ${interactionKey}`);

            // Build concise prompt - prioritize model identity and clothing accuracy
            let parts = [];
            const numModels = state.selectedModels.length;
            const clothingImageStart = numModels + 1;

            // STYLE PREFIX
            if (state.cinematicMode) {
                parts.push('35mm film grain analog photography, warm tones, soft edges');
            }
            parts.push(`Fashion editorial, ${framing}`);

            // MODEL IDENTITY - describe the reference image content
            if (isDuo) {
                parts.push(`Two male models. First model EXACTLY matches the reference portrait showing ${modelDescs[0]}. Second model EXACTLY matches the reference portrait showing ${modelDescs[1] || modelDescs[0]}`);
                parts.push(`${pose}`);
            } else {
                // Single model - describe what the reference shows
                parts.push(`Male model EXACTLY matching the reference portrait: ${modelDescs[0]}, suntanned Mediterranean skin`);
                parts.push(`${pose}`);
            }

            // CLOTHING - describe the garments with their colors
            if (isDuo) {
                parts.push(`OUTFIT: First model wears EXACTLY the garments shown in the product reference: ${outfits[0]}. Second model wears EXACTLY the garments shown: ${outfits[1] || outfits[0]}. Reproduce these EXACT colors and styles`);
            } else {
                parts.push(`OUTFIT: Wearing EXACTLY the garments shown in the product reference image: ${outfits[0]}. Reproduce these EXACT colors`);
            }

            // Swim-only outfits - explicitly state NO shirt, bare chest
            if (isSwimOnly) {
                parts.push('SWIM ONLY - NO shirt, NO t-shirt, NO tank top. Model has bare chest/torso, showing athletic physique. ONLY wearing the swim briefs/shorts shown in the product reference');
            }

            // Footwear
            parts.push(footwear);

            // Location
            parts.push(`Location: ${location}`);

            // Pristine environment - no footprints on beaches/sand
            parts.push('Pristine untouched environment, NO footprints in sand, NO tracks, clean undisturbed beach surface');

            // Copy Pose mode - use environment for composition inspiration, not exact pose replication
            if (useCopyPose) {
                parts.push('Use environment image as composition reference, natural relaxed pose');
            }

            // Additional styling from user
            if (state.additionalPrompt && state.additionalPrompt.trim()) {
                const enhanced = enhanceStylingNotes(state.additionalPrompt.trim());
                parts.push(enhanced);
            }

            // Technical requirements - consolidated
            // Note: Even for sunset/golden hour, always have the SUN ILLUMINATING the model's face/body (not silhouette)
            // IMPORTANT: Single person only (unless duo mode), strict 16:9 horizontal, minimal clean backgrounds
            const personCount = isDuo ? 'exactly TWO people' : 'exactly ONE person only (NEVER two people)';
            const shirtInstruction = isSwimOnly
                ? ''
                : '. CRITICAL: Tank top/shirt must be worn properly pulled ALL THE WAY DOWN covering entire torso - absolutely NO lifted shirts, NO exposed midriff, NO belly showing';
            parts.push(`${personCount}. WIDE HORIZONTAL 16:9 aspect ratio, NOT vertical, NOT 3:4. Strong natural sunlight illuminating model's face and body (NOT silhouette, NOT backlit), minimal clean background, vivid warm colors${shirtInstruction}`);

            return {
                prompt: parts.join('. ') + '.',
                usedCopyPose: useCopyPose && suggestedPose && suggestedPose !== 'standing naturally'
            };
        }

        function buildImageUrls(task) {
            const urls = [];
            const isDuo = task.isDuo;

            // Add model references - only add what's needed for this shot
            if (isDuo) {
                // Duo shot: add both models
                state.selectedModels.forEach(modelId => {
                    if (state.modelFalUrls[modelId]) {
                        urls.push(state.modelFalUrls[modelId]);
                    }
                });
            } else {
                // Solo shot: only add ONE model (the first one, or rotate through selected)
                const modelIndex = task.modelIndex || 0;
                const modelId = state.selectedModels[modelIndex % state.selectedModels.length];
                if (state.modelFalUrls[modelId]) {
                    urls.push(state.modelFalUrls[modelId]);
                }
            }

            // Add product references (both preset and custom)
            task.assignedGroups.forEach(groupNum => {
                const productItems = task.groups[groupNum];
                productItems.forEach(item => {
                    if (item.type === 'preset') {
                        if (state.productFalUrls[item.id]) {
                            urls.push(state.productFalUrls[item.id]);
                        }
                    } else if (item.type === 'custom') {
                        if (item.product && item.product.falUrl) {
                            urls.push(item.product.falUrl);
                        }
                    }
                });
            });

            // Add sandals product image if sandals are being used
            if (task.useSandals && state.productFalUrls['21sn624']) {
                urls.push(state.productFalUrls['21sn624']);
            }

            // Add environment reference (unless describe-only mode)
            if (task.env.falUrl && !state.describeEnvOnly) {
                urls.push(task.env.falUrl);
            }

            return urls;
        }

        function addResult(result) {
            // Generate filename at creation time
            const now = new Date();
            const datePart = now.toISOString().slice(2, 10).replace(/-/g, ''); // YYMMDD
            const timePart = now.toTimeString().slice(0, 5).replace(':', ''); // HHMM
            const styleStr = String(result.styleNum || 1).padStart(2, '0');
            const cardNum = String(state.results.length + 1).padStart(2, '0');
            result.filename = `Setset_RonDorff_Campaign_Style${styleStr}_${datePart}_${timePart}_${cardNum}.png`;

            state.results.push(result);
            const resultIndex = state.results.length - 1;

            // Convert ratio to CSS aspect-ratio (e.g., "16:9" -> "16 / 9")
            const aspectRatio = state.ratio.replace(':', ' / ');

            const card = document.createElement('div');
            card.className = 'result-card';
            card.style.aspectRatio = aspectRatio;
            card.innerHTML = `
                <img src="${result.url}" alt="Result">
                <div class="result-label">Style ${styleStr} - ${result.isDuo ? 'Duo' : 'Solo'}</div>
            `;
            card.addEventListener('click', () => {
                const lightboxResults = state.results.map(r => ({
                    url: r.url,
                    prompt: r.prompt,
                    modelName: 'Ron Dorff',
                    filename: r.filename,
                    inputImages: r.inputImages || [],
                    usedCopyPose: r.usedCopyPose
                }));
                lightbox.setResults(lightboxResults);
                lightbox.open(resultIndex);
            });

            // Insert after the batch divider (which is the first child)
            const divider = elements.resultsGrid.querySelector('.batch-divider');
            if (divider && divider.nextSibling) {
                elements.resultsGrid.insertBefore(card, divider.nextSibling);
            } else if (divider) {
                elements.resultsGrid.appendChild(card);
            } else {
                elements.resultsGrid.prepend(card);
            }
        }

        // ========== INIT ==========
        function init() {
            renderModels();
            renderProducts();
            renderOutfits();
            renderCustomProducts();
            renderEnvironments();
            renderPresetEnvironments();
            updateSummary();

            // Switch to default env tab (rocky-beach)
            switchEnvTab('rocky-beach');

            // Model tab click handlers
            elements.modelTabs.querySelectorAll('.section-tab').forEach(tab => {
                tab.addEventListener('click', () => switchModelTab(tab.dataset.tab));
            });

            // Product tab click handlers
            elements.productTabs.querySelectorAll('.section-tab').forEach(tab => {
                tab.addEventListener('click', () => switchProductTab(tab.dataset.tab));
            });

            // Grid columns slider
            if (elements.gridColsSlider) {
                elements.gridColsSlider.addEventListener('input', () => {
                    const cols = elements.gridColsSlider.value;
                    elements.gridColsValue.textContent = cols;
                    elements.customProductGrid.style.setProperty('--grid-cols', cols);
                });
            }
        }

        init();

        // ========== GENERATE TAB ==========
        const genState = {
            models: ['reve'], // 'reve', 'zimage'
            aspectRatio: '16:9',
            seeds: 1,
            envTypes: [], // 'ibiza', 'architecture', 'volcanic'
            lighting: ['midday'],
            content: 'environment',
            count: 5,
            customPrompt: '', // Custom instructions for the prompt
            batchNumber: 0, // Track batch number for history
            results: []
        };

        const genElements = {
            modelButtons: document.querySelectorAll('#gen-model-buttons .btn--toggle'),
            aspectButtons: document.querySelectorAll('#gen-aspect-buttons .btn--toggle'),
            seedsSlider: document.getElementById('gen-seeds-slider'),
            seedsValue: document.getElementById('gen-seeds-value'),
            envTypeButtons: document.querySelectorAll('#gen-env-type .btn--toggle'),
            lightingButtons: document.querySelectorAll('#gen-lighting .btn--toggle'),
            contentButtons: document.querySelectorAll('#gen-content .btn--toggle'),
            countButtons: document.querySelectorAll('#gen-count .btn--toggle'),
            customPrompt: document.getElementById('gen-custom-prompt'),
            calcDisplay: document.getElementById('gen-calc-display'),
            costValue: document.getElementById('gen-cost-value'),
            generateBtn: document.getElementById('gen-btn'),
            results: document.getElementById('gen-results'),
            resultsGrid: document.getElementById('gen-results-grid')
        };

        // Create dedicated StudioLoader for Generate tab with Ron Dorff themed messages
        const genLoader = new StudioLoader({
            loaderElement: document.getElementById('gen-inline-loader'),
            messageElement: document.getElementById('gen-loader-message'),
            progressElement: document.getElementById('gen-loader-progress'),
            messages: RONDORFF_LOADER_MESSAGES
        });

        // Page tab switching
        document.querySelectorAll('.page-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.page-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.page-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.page + '-panel').classList.add('active');
            });
        });

        // Model selection (multi-select)
        genElements.modelButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('active');
                const val = btn.dataset.model;
                if (btn.classList.contains('active')) {
                    if (!genState.models.includes(val)) genState.models.push(val);
                } else {
                    genState.models = genState.models.filter(v => v !== val);
                }
                updateGenCalc();
            });
        });

        // Aspect ratio selection (single-select)
        genElements.aspectButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                genElements.aspectButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                genState.aspectRatio = btn.dataset.ratio;
                updateGenCalc();
            });
        });

        // Seeds slider
        genElements.seedsSlider.addEventListener('input', () => {
            genState.seeds = parseInt(genElements.seedsSlider.value);
            genElements.seedsValue.textContent = genState.seeds;
            updateGenCalc();
        });

        // Environment type selection (multi-select)
        genElements.envTypeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('active');
                const val = btn.dataset.value;
                if (btn.classList.contains('active')) {
                    if (!genState.envTypes.includes(val)) genState.envTypes.push(val);
                } else {
                    genState.envTypes = genState.envTypes.filter(v => v !== val);
                }
                updateGenCalc();
            });
        });

        // Lighting selection (multi-select)
        genElements.lightingButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('active');
                const val = btn.dataset.value;
                if (btn.classList.contains('active')) {
                    if (!genState.lighting.includes(val)) genState.lighting.push(val);
                } else {
                    genState.lighting = genState.lighting.filter(v => v !== val);
                }
                updateGenCalc();
            });
        });

        // Content selection (single-select)
        genElements.contentButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                genElements.contentButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                genState.content = btn.dataset.value;
                updateGenCalc();
            });
        });

        // Count selection (single-select)
        genElements.countButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                genElements.countButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                genState.count = parseInt(btn.dataset.value);
                updateGenCalc();
            });
        });

        function updateGenCalc() {
            if (genState.models.length === 0) {
                genElements.calcDisplay.textContent = 'Select at least one model';
                genElements.generateBtn.disabled = true;
                return;
            }
            if (genState.envTypes.length === 0) {
                genElements.calcDisplay.textContent = 'Select environment type';
                genElements.generateBtn.disabled = true;
                return;
            }
            if (genState.lighting.length === 0) {
                genElements.calcDisplay.textContent = 'Select at least one lighting';
                genElements.generateBtn.disabled = true;
                return;
            }

            const totalImages = genState.count * genState.seeds * genState.models.length;
            const modelNames = genState.models.map(m => m === 'reve' ? 'Reve' : 'Z Image').join(' + ');
            genElements.calcDisplay.textContent = `${genState.count} prompts Ã— ${genState.seeds} seed${genState.seeds > 1 ? 's' : ''} Ã— ${genState.models.length} model${genState.models.length > 1 ? 's' : ''} = ${totalImages} images`;

            // Calculate cost using shared models.js
            const cost = calculateCost(genState.models, genState.count, genState.seeds);
            genElements.costValue.textContent = `$${cost.toFixed(2)}`;

            genElements.generateBtn.disabled = false;
        }

        // Ron Dorff Poses (from reference images)
        const GEN_RONDORFF_POSES = [
            'leaning against wall with one hand in hair, confident gaze, weight shifted to one leg',
            'seated on edge of surface, legs extended, relaxed confident posture, looking off to side',
            'walking casually on wet sand, mid-stride, barefoot, natural movement',
            'standing with hands adjusting waistband or hem of clothing, looking down, playful',
            'seated on rocks with one knee up, arm resting on knee, gazing at horizon',
            'leaning on railing or ledge, profile view, looking out at ocean',
            'standing with arms crossed or hands in pockets, strong stance, direct gaze',
            'crouching or squatting casually, athletic pose, confident expression'
        ];

        // Environment prompts
        // Environment variations - each image gets a unique combination
        const ENV_VARIATIONS = {
            ibiza: [
                // Intimate rocky beach compositions - light Ibiza limestone, campaign-ready framing
                'Ibiza rocky beach with warm beige limestone boulders in foreground framing shot, golden sand, turquoise water, intimate scale',
                'light sandstone rocks creating natural frame, sandy beach between rocks, clear shallow water, close-up textured rock surfaces',
                'weathered cream-colored limestone formations on Ibiza beach, rocks in foreground and background creating depth, sand and sea',
                'honey-toned rock shelf on Ibiza coast, textured stone surface, small sandy cove, turquoise water lapping at rocks',
                'pale limestone boulders scattered on Ibiza beach, warm sand between rocks, intimate cove setting, clear water',
                'Ibiza cala with light-colored rock walls framing intimate beach, golden sand, shallow turquoise lagoon',
                'smooth beige sandstone rocks on beach, natural rock steps leading to water, warm sand patches, close framing',
                'layered sedimentary limestone on Ibiza shore, horizontal rock strata, sand and rock textures, intimate scale',
                'warm-toned rock formation on beach creating natural alcove, soft sand, gentle waves, secluded intimate feel',
                'Ibiza beach with large pale boulders in foreground, textured rock surfaces catching light, sand and sea behind',
                'limestone rock platform on coast, worn smooth surfaces, tidal pools in rock, sandy beach visible',
                'cream and gold colored rocks framing Ibiza beach scene, intimate cove, crystal clear water, campaign-ready composition',
                'natural rock arch in light limestone on Ibiza beach, sand visible through arch, turquoise water, intimate framing',
                'textured sandstone boulders on golden sand beach, rocks creating foreground interest, sea in background',
                'Ibiza rocky shoreline with warm beige tones, layered rocks creating depth, small sandy areas between stones',
                'pale weathered rocks on intimate Ibiza beach, rock textures prominent, sand and turquoise water, close composition'
            ],
            architecture: [
                'brutalist concrete rooftop terrace overlooking ocean, clean geometric edges, minimalist design, vast sky',
                'terracotta-colored Mediterranean rooftop with low walls, warm orange tones, geometric shapes, sea view',
                'whitewashed Greek-style terrace with blue accents, clean lines, bright surfaces, ocean backdrop',
                'modernist beach house exterior with raw concrete walls, large geometric shadows, minimalist landscaping',
                'Spanish colonial courtyard with ochre walls, arched doorways, tiled floor, glimpse of sea through opening',
                'minimalist poolside deck with travertine stone, infinity edge toward ocean, clean horizontal lines',
                'Moroccan-inspired rooftop with sand-colored walls, geometric cutouts framing sky, warm earth tones',
                'contemporary villa terrace with smooth stucco walls, built-in concrete bench, unobstructed sea view',
                'Ricardo Bofill style red walls, postmodern geometric architecture, dramatic angular shadows',
                'Santorini cave house terrace carved into cliff, white curves, blue dome accent, endless sea',
                'minimalist concrete staircase leading to ocean view platform, strong diagonal lines, industrial chic',
                'Luis Barragan inspired pink and orange walls, bold color blocks, play of light and shadow',
                'beach club wooden deck with weathered planks, rope railings, nautical minimalism, horizon view',
                'abandoned concrete structure on beach, industrial ruins, raw texture, nature reclaiming',
                'Cycladic architecture with rounded white walls, small square windows, deep shadows, blue sea beyond',
                'modernist pergola with concrete columns, geometric shade patterns on ground, framed ocean view',
                'Mediterranean fortress wall with weathered stone, crenellations, dramatic sea backdrop',
                'contemporary art museum terrace, white geometric forms, sculptural shadows, coastal setting',
                'traditional finca courtyard with terracotta tiles, whitewashed walls, bougainvillea, glimpse of sea',
                'beach cabana with thatched roof, wooden posts, sand floor, open to ocean breeze'
            ],
            volcanic: [
                'dramatic black lava rock beach with golden sand patches, dark volcanic boulders, contrasting bright sky',
                'volcanic coastline with weathered basalt formations, black sand beach, turquoise water, rugged texture',
                'Lanzarote-style landscape with red-brown volcanic rocks, sparse vegetation, ocean in distance',
                'black sand beach with scattered volcanic stones, dramatic dark cliffs, powerful wave patterns',
                'volcanic rock pools with dark stone edges, calm trapped water, raw natural texture, distant horizon',
                'eroded lava formations creating natural sculptures, black and rust colored rocks, beach in background',
                'dramatic basalt columns meeting the sea, hexagonal rock formations, black sand, moody atmosphere',
                'volcanic crater rim with ocean view, rust and black rock layers, alien landscape feel',
                'black pebble beach with smooth volcanic stones, contrasting white foam, dark dramatic cliffs',
                'lava field meeting turquoise sea, stark contrast, otherworldly terrain, bright sky above',
                'ancient volcanic arch over water, black rock framing blue sea, natural sculpture',
                'tiered volcanic rock platforms descending to ocean, natural stairs, textured dark stone'
            ]
        };

        const LIGHTING_VARIATIONS = {
            midday: [
                'bright midday summer sun, vivid blue sky, high sun casting short crisp shadows, warm atmosphere, no clouds',
                'intense Mediterranean noon light, deep blue sky, strong overhead sun, minimal shadows, summer heat haze',
                'peak daylight with sun directly overhead, saturated blue sky, sharp defined shadows, warm golden tones on skin',
                'classic summer midday, cloudless cerulean sky, even bright light, warm but not orange, clear visibility',
                'blazing summer sun at zenith, electric blue sky, strong contrast, warm skin tones, beach day energy',
                'high noon Mediterranean light, deep shadows under overhangs, bright sunlit surfaces, summer intensity',
                'perfect beach weather lighting, postcard blue sky, sun high and bright, warm golden highlights',
                'midday brilliance with slight sea haze, softening distant views, bright foreground, summer warmth',
                'scorching summer light, deep blue overhead, heat shimmer on surfaces, bronzed skin tones',
                'crystal clear midday, unlimited visibility, rich blue sky, strong sun from above, summer perfection'
            ],
            sunrise: [
                'soft warm sunrise, golden pink sky on horizon, gentle long shadows, peaceful morning stillness',
                'early morning light with soft peach tones, mist on water, delicate shadows, quiet atmosphere',
                'dawn breaking with warm amber light, sky gradient from pink to blue, everything bathed in soft glow',
                'first light of day, rose gold illumination, long dramatic shadows, world just waking',
                'morning golden hour, warm side lighting, soft shadows, dewy fresh atmosphere',
                'sunrise through light clouds, diffused warm light, pastel sky colors, serene mood',
                'crisp morning light just after sunrise, clean air, long shadows, optimistic energy',
                'beach at dawn, pink sky reflected in wet sand, warm tones, peaceful solitude'
            ],
            sunset: [
                'golden hour with warm orange light, long dramatic shadows, rich saturated colors, romantic mood',
                'late afternoon sun low on horizon, everything bathed in warm honey light, soft shadows',
                'sunset with pink and coral sky, warm reflections on water, silhouette potential, magic hour',
                'deep golden sunset, amber light on skin, purple shadows, end of day warmth',
                'dramatic sunset with orange and magenta sky, strong backlighting, rim light on figure',
                'soft sunset through thin clouds, diffused golden light, gentle warm glow everywhere',
                'beach sunset with sun touching water, golden path on sea, warm atmospheric light',
                'late golden hour, everything glowing warm, long shadows stretching, romantic atmosphere'
            ]
        };

        const STYLE_ELEMENTS = [
            'clean graphic composition, strong horizon line, uncluttered frame',
            'minimalist composition, negative space, architectural framing',
            'balanced asymmetric composition, rule of thirds, visual anchor point',
            'geometric composition, leading lines, clean edges',
            'layered depth composition, foreground interest, clear background',
            'centered subject with symmetric framing, calm balanced feel',
            'diagonal composition creating dynamic energy, visual tension',
            'frame within frame composition, natural or architectural borders',
            'low angle composition emphasizing sky and subject, powerful feel',
            'high vantage point looking down, graphic patterns visible',
            'silhouette-friendly composition with bright background',
            'intimate close framing with environmental context',
            'wide establishing shot with small figure in vast space',
            'triangular composition with strong visual anchor'
        ];

        genElements.generateBtn.addEventListener('click', generateEnvironments);

        async function generateEnvironments() {
            // Start the animated loader (uses dedicated genLoader instance)
            genLoader.start(`Generating prompts: 0 / ${genState.count}`);

            // Increment batch number and create batch container
            genState.batchNumber++;
            const batchId = `gen-batch-${genState.batchNumber}`;
            const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const settingsDesc = `${genState.envTypes.join(', ')} â€¢ ${genState.lighting.join(', ')} â€¢ ${genState.content === 'male' ? 'w/ Model' : 'Environment'}`;

            // Create batch header and container at the TOP of results
            const batchHtml = `
                <div class="gen-batch" id="${batchId}">
                    <div class="gen-batch-header">
                        <span class="gen-batch-title">Batch ${genState.batchNumber}</span>
                        <span class="gen-batch-info">${settingsDesc} â€¢ ${timestamp}</span>
                    </div>
                    <div class="gen-batch-grid" id="${batchId}-grid"></div>
                </div>
            `;
            genElements.resultsGrid.insertAdjacentHTML('afterbegin', batchHtml);

            genState.results = [];
            // Show results section immediately so images appear as they generate
            genElements.results.classList.add('active');

            // Step 1: Generate prompts via Gemini
            // Get custom instructions from textarea
            genState.customPrompt = genElements.customPrompt.value.trim();

            let geminiPrompts = [];
            try {
                const promptResponse = await fetch('/api/prompts/campaign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        numPrompts: genState.count,
                        environments: genState.envTypes,
                        lighting: genState.lighting,
                        includeModel: genState.content === 'male',
                        customInstructions: genState.customPrompt || null
                    })
                });

                if (!promptResponse.ok) {
                    throw new Error('Failed to generate prompts');
                }

                const promptData = await promptResponse.json();
                geminiPrompts = promptData.prompts || [];
                genLoader.updateProgress(`Generating prompts: ${geminiPrompts.length} / ${genState.count}`);
                console.log(`ðŸ“ Gemini generated ${geminiPrompts.length} prompts`);
            } catch (err) {
                console.error('Gemini prompt generation failed, falling back to random:', err);
                // Fallback to random prompts if Gemini fails
                for (let i = 0; i < genState.count; i++) {
                    const envType = genState.envTypes[i % genState.envTypes.length];
                    const light = genState.lighting[i % genState.lighting.length];
                    geminiPrompts.push(buildGenPrompt(envType, light));
                }
            }

            // Step 2: Build task list: prompts Ã— seeds Ã— models
            const tasks = [];
            geminiPrompts.forEach((prompt, promptIdx) => {
                const envType = genState.envTypes[promptIdx % genState.envTypes.length];
                const light = genState.lighting[promptIdx % genState.lighting.length];

                for (let seed = 0; seed < genState.seeds; seed++) {
                    genState.models.forEach(model => {
                        tasks.push({
                            prompt,
                            envType,
                            light,
                            model,
                            seed,
                            index: tasks.length
                        });
                    });
                }
            });

            // Switch to image generation phase
            genLoader.updateProgress(`Generating images: 0 / ${tasks.length}`);
            let completed = 0;

            // Generate ALL tasks in parallel
            const allPromises = tasks.map(async (task) => {
                try {
                    console.log(`ðŸŽ¨ [${task.index + 1}] ${task.model}: ${task.envType} / ${task.light}`);
                    console.log(`   Prompt: ${task.prompt.substring(0, 120)}...`);

                    const params = {
                        prompt: task.prompt,
                        aspect_ratio: genState.aspectRatio
                    };

                    // Z Image uses steps=16
                    if (task.model === 'zimage') {
                        params.num_inference_steps = 16;
                    }

                    const result = await api.generateImage(task.model, params);

                    if (result.images && result.images[0]) {
                        // Generate filename at creation time
                        const now = new Date();
                        const datePart = now.toISOString().slice(2, 10).replace(/-/g, '');
                        const timePart = now.toTimeString().slice(0, 5).replace(':', '');
                        const cardNumber = String(genState.results.length + 1).padStart(2, '0');
                        const filename = `Setset_RonDorff_${task.envType}_${datePart}_${timePart}_${cardNumber}.png`;

                        genState.results.push({
                            url: result.images[0].url,
                            envType: task.envType,
                            light: task.light,
                            model: task.model,
                            prompt: task.prompt,
                            filename: filename
                        });
                        addGenResultCard(result.images[0].url, task.envType, task.light, task.model, task.prompt, filename, batchId);
                    }
                } catch (err) {
                    console.error(`Error generating ${task.envType}/${task.light}:`, err);
                }
                completed++;
                genLoader.updateProgress(`Generating images: ${completed} / ${tasks.length}`);
            });

            await Promise.all(allPromises);

            // Stop the loader
            genLoader.stop();
            if (genState.results.length > 0) {
                genElements.results.classList.add('active');
            }
        }

        function buildGenPrompt(envType, light) {
            // Pick random variation for environment
            const envVariations = ENV_VARIATIONS[envType];
            const envDesc = envVariations[Math.floor(Math.random() * envVariations.length)];

            // Pick random variation for lighting
            const lightVariations = LIGHTING_VARIATIONS[light];
            const lightDesc = lightVariations[Math.floor(Math.random() * lightVariations.length)];

            // Pick random style element
            const styleElement = STYLE_ELEMENTS[Math.floor(Math.random() * STYLE_ELEMENTS.length)];

            // Add "empty/clean" for beach environments
            const cleanSuffix = (envType === 'ibiza' || envType === 'volcanic')
                ? ', pristine untouched beach, clean sand'
                : '';

            // Start with strong campaign context
            const campaignPrefix = 'Photorealistic campaign image for premium male swimwear brand';
            const styleSuffix = `${styleElement}, professional fashion photography, natural light only, no flash, no artificial lighting`;

            let prompt;

            if (genState.content === 'male') {
                const pose = GEN_RONDORFF_POSES[Math.floor(Math.random() * GEN_RONDORFF_POSES.length)];
                prompt = `${campaignPrefix}. Athletic male model in swimwear, suntanned healthy skin, ${pose}, ${envDesc}${cleanSuffix}, ${lightDesc}, ${styleSuffix}`;
            } else {
                // Environment only - explicitly exclude people
                prompt = `Empty scenic landscape, no people, no humans, no figures. ${envDesc}${cleanSuffix}, ${lightDesc}, ${styleElement}, professional landscape photography, natural light only`;
            }

            return prompt;
        }

        function addGenResultCard(url, envType, light, model, prompt, filename, batchId) {
            const card = document.createElement('div');
            card.className = 'gen-result-card';

            const modelLabel = model === 'reve' ? 'Reve' : 'Z Image';
            card.innerHTML = `
                <img src="${url}" alt="${envType} ${light} ${model}">
                <span class="model-label">${modelLabel}</span>
                <button class="download-btn" data-url="${url}" data-filename="${filename}">Download</button>
            `;

            // Store index for lightbox navigation
            const cardIndex = genState.results.length - 1;

            // Download button click
            const downloadBtn = card.querySelector('.download-btn');
            downloadBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const btnUrl = downloadBtn.dataset.url;
                const btnFilename = downloadBtn.dataset.filename;
                try {
                    // Handle data URLs directly (base64 from Gemini)
                    if (btnUrl.startsWith('data:')) {
                        const response = await fetch(btnUrl);
                        const blob = await response.blob();
                        const blobUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = btnFilename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(blobUrl);
                        return;
                    }

                    const proxyUrl = `/api/proxy-download?url=${encodeURIComponent(btnUrl)}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error('Proxy failed');
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = btnFilename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(blobUrl);
                } catch (err) {
                    console.error('Proxy download failed, trying direct:', err);
                    // Fallback: try direct fetch (works for some CDNs)
                    try {
                        const response = await fetch(btnUrl);
                        const blob = await response.blob();
                        const blobUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = btnFilename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(blobUrl);
                    } catch (e2) {
                        console.error('Direct download also failed:', e2);
                        window.open(btnUrl, '_blank');
                    }
                }
            });

            card.addEventListener('click', () => {
                // Build array of all results for lightbox - use stored filenames
                const lightboxItems = genState.results.map(r => ({
                    url: r.url,
                    prompt: r.prompt,
                    model: r.model,
                    filename: r.filename
                }));
                lightbox.setResults(lightboxItems);
                lightbox.open(cardIndex);
            });

            // Add to batch-specific grid if provided, otherwise main grid
            const targetGrid = batchId ? document.getElementById(`${batchId}-grid`) : genElements.resultsGrid;
            if (targetGrid) {
                targetGrid.appendChild(card);
            } else {
                genElements.resultsGrid.appendChild(card);
            }
        }

        // Initialize calc
        updateGenCalc();

        // ========== PROMPTS TAB ==========
        const promptsCodeBox = document.getElementById('prompts-code-box');
        if (promptsCodeBox) {
            promptsCodeBox.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(promptsCodeBox.textContent);
                    const feedback = document.getElementById('copy-feedback');
                    feedback.classList.add('visible');
                    setTimeout(() => feedback.classList.remove('visible'), 1500);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            });
        }

        // ========== VIDEO TAB ==========
        const videoState = {
            globalMovementMode: 'static', // static, dynamic, handheld, 90s, random
            aspectRatio: '16:9',
            duration: 5,
            useKling: true,
            klingQuality: 'pro',
            useSeedance: false,
            images: [], // Array of { file, thumbnail, uploaded, motionDesc, modes: ['static'], selected: true }
            results: []
        };

        const VIDEO_SLOTS = 12;

        // Movement mode prompts for Ron Dorff campaign aesthetic
        // These get prepended to the motion description
        const MOVEMENT_PROMPTS = {
            static: {
                prefix: 'Fixed camera, static shot.',
                description: 'Static'
            },
            dynamic: {
                prefix: 'Slow subtle camera movement, gentle zoom in or slight dolly push, smooth cinematic motion.',
                description: 'Dynamic'
            },
            handheld: {
                prefix: 'Handheld camera with natural organic movement, slight breathing shake, documentary intimate feel.',
                description: 'Handheld'
            },
            '90s': {
                prefix: 'Shot on vintage 8mm film camera, analog warmth, 90s VHS camcorder aesthetic, sun-drenched nostalgic grain texture.',
                description: '90s'
            },
            follow: {
                prefix: 'Camera tracking shot following model movement, smooth lateral or forward track maintaining subject in frame, cinematic follow.',
                description: 'Follow'
            },
            push: {
                prefix: 'Dolly push forward toward subject, camera steadily advancing, building intensity and presence, smooth approach.',
                description: 'Push'
            },
            pull: {
                prefix: 'Camera pulling back slowly, revealing more of the environment, establishing context, smooth retreat.',
                description: 'Pull'
            },
            arc: {
                prefix: 'Camera arcing around subject in smooth circular path, dramatic three-dimensional perspective shift, orbital motion.',
                description: 'Arc'
            },
            rise: {
                prefix: 'Camera rising upward while maintaining subject in frame, crane-like movement, ascending reveal.',
                description: 'Rise'
            },
            drift: {
                prefix: 'Camera slowly drifting sideways with subtle parallax, dreamlike floating movement, gentle lateral slide.',
                description: 'Drift'
            }
        };

        // Helper to build full prompt from ambient/movement descriptions + mode prefix
        function buildFullPrompt(img, mode) {
            const modePrompt = MOVEMENT_PROMPTS[mode];
            if (!modePrompt) return img.ambientDesc || '';

            // Combine ambient + movement based on which movement mode is enabled
            let motionPart = img.ambientDesc || '';
            if (img.addDynamicMovement && img.dynamicMovementDesc) {
                // +++ Move - use dynamic cinematic movement (running, spinning, jumping)
                motionPart = `${img.ambientDesc} ${img.dynamicMovementDesc}`;
            } else if (img.addActiveMovement && img.activeMovementDesc) {
                // ++ Move - use active editorial movement (walking, turning, etc.)
                motionPart = `${img.ambientDesc} ${img.activeMovementDesc}`;
            } else if (img.addMovement && img.movementDesc) {
                // + Move - use subtle editorial movement (head turn, weight shift)
                motionPart = `${img.ambientDesc} ${img.movementDesc}`;
            }

            return `${modePrompt.prefix} ${motionPart}`;
        }

        // Kling pricing per second
        const KLING_PRICING = {
            pro: 0.224,
            standard: 0.084
        };

        // Seedance pricing (720p is ~$0.05 per 5s)
        const SEEDANCE_PRICE_PER_VIDEO = 0.05;

        const videoElements = {
            movementModeButtons: document.querySelectorAll('#movement-mode-buttons .movement-mode-btn'),
            aspectButtons: document.querySelectorAll('#video-aspect-buttons .aspect-btn'),
            durationSlider: document.getElementById('video-duration-slider'),
            durationValue: document.getElementById('video-duration-value'),
            klingCheckbox: document.getElementById('kling-checkbox'),
            klingQuality: document.getElementById('kling-quality'),
            seedanceCheckbox: document.getElementById('seedance-checkbox'),
            analyzeBtn: document.getElementById('video-analyze-btn'),
            generateBtn: document.getElementById('video-generate-btn'),
            uploadGrid: document.getElementById('video-upload-grid'),
            uploadCount: document.getElementById('video-upload-count'),
            clearAllBtn: document.getElementById('video-clear-all-btn'),
            fileInput: document.getElementById('video-file-input'),
            resultsSection: document.getElementById('video-results-section'),
            resultsGrid: document.getElementById('video-results-grid'),
            status: document.getElementById('video-status'),
            statusText: document.getElementById('video-status-text'),
            statusProgress: document.getElementById('video-status-progress')
        };

        // Initialize Video Tab
        function initVideoTab() {
            renderVideoUploadGrid();
            setupVideoEventListeners();
            updateVideoUI();
        }

        function setupVideoEventListeners() {
            const availableModes = ['static', 'dynamic', 'handheld', '90s', 'follow', 'push', 'pull', 'arc', 'rise', 'drift'];

            // Global movement mode buttons
            videoElements.movementModeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    const mode = btn.dataset.mode;

                    if (action === 'random') {
                        // Randomize each image's mode individually
                        videoState.images.forEach(img => {
                            if (img) {
                                const randomMode = availableModes[Math.floor(Math.random() * availableModes.length)];
                                img.modes = [randomMode];
                                img.customMode = true;
                            }
                        });
                        // Clear active states on mode buttons
                        videoElements.movementModeButtons.forEach(b => b.classList.remove('active'));
                        renderVideoUploadGrid();
                        return;
                    }

                    if (action === 'clear') {
                        // Clear all mode selections - images keep their modes but you can now pick new ones
                        videoState.images.forEach(img => {
                            if (img) {
                                img.modes = [];
                                img.customMode = false;
                            }
                        });
                        videoElements.movementModeButtons.forEach(b => b.classList.remove('active'));
                        renderVideoUploadGrid();
                        return;
                    }

                    // Regular mode button - apply to all images
                    videoElements.movementModeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    videoState.globalMovementMode = mode;
                    // Apply to all images
                    videoState.images.forEach(img => {
                        if (img) {
                            img.modes = [mode];
                            img.customMode = false;
                        }
                    });
                    renderVideoUploadGrid();
                });
            });

            // Aspect ratio buttons
            videoElements.aspectButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    videoElements.aspectButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    videoState.aspectRatio = btn.dataset.aspect;
                    updateVideoUI();
                });
            });

            // Duration slider
            videoElements.durationSlider.addEventListener('input', () => {
                videoState.duration = parseInt(videoElements.durationSlider.value);
                videoElements.durationValue.textContent = `${videoState.duration}s`;
                updateVideoUI();
            });

            // Model checkboxes
            videoElements.klingCheckbox.addEventListener('change', () => {
                videoState.useKling = videoElements.klingCheckbox.checked;
                updateVideoUI();
            });

            videoElements.klingQuality.addEventListener('change', () => {
                videoState.klingQuality = videoElements.klingQuality.value;
                updateVideoUI();
            });

            videoElements.seedanceCheckbox.addEventListener('change', () => {
                videoState.useSeedance = videoElements.seedanceCheckbox.checked;
                updateVideoUI();
            });

            // Analyze button
            videoElements.analyzeBtn.addEventListener('click', handleVideoAnalyze);

            // Generate button
            videoElements.generateBtn.addEventListener('click', handleVideoGenerate);

            // Clear all button
            videoElements.clearAllBtn.addEventListener('click', () => {
                videoState.images = [];
                renderVideoUploadGrid();
                updateVideoUI();
            });

            // File input
            videoElements.fileInput.addEventListener('change', handleVideoFileSelect);

            // Drag and drop
            videoElements.uploadGrid.addEventListener('dragover', (e) => {
                e.preventDefault();
                videoElements.uploadGrid.classList.add('drag-over');
            });

            videoElements.uploadGrid.addEventListener('dragleave', () => {
                videoElements.uploadGrid.classList.remove('drag-over');
            });

            videoElements.uploadGrid.addEventListener('drop', (e) => {
                e.preventDefault();
                videoElements.uploadGrid.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                handleVideoFiles(files);
            });

            // Global paste handler for video tab
            document.addEventListener('paste', (e) => {
                // Only handle if video panel is active
                const videoPanel = document.getElementById('video-panel');
                if (!videoPanel.classList.contains('active')) return;

                const items = e.clipboardData?.items;
                if (!items) return;

                const files = [];
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) files.push(file);
                    }
                }

                if (files.length > 0) {
                    e.preventDefault();
                    handleVideoFiles(files);
                }
            });
        }

        function renderVideoUploadGrid() {
            let html = '';
            for (let i = 0; i < VIDEO_SLOTS; i++) {
                const image = videoState.images[i];
                if (image) {
                    // Get current modes for this image - empty array means "no mode selected yet" (after Clear)
                    const modes = image.modes && image.modes.length > 0 ? image.modes : [];
                    const modeLabels = modes.length > 0
                        ? modes.map(m => MOVEMENT_PROMPTS[m]?.description || m).join(' + ')
                        : 'Select mode';

                    // Build display prompt: show full prompt for first mode (what you'll see in generation)
                    // If no mode selected, just show the ambient description without prefix
                    const displayPrompt = image.ambientDesc
                        ? (modes[0] ? buildFullPrompt(image, modes[0]) : image.ambientDesc)
                        : '';

                    const isDeselected = image.selected === false;
                    const currentMode = modes[0] || '';
                    const hasMovement = image.addMovement === true;
                    html += `
                        <div class="video-upload-slot filled ${isDeselected ? 'deselected' : ''}" data-index="${i}">
                            <div class="slot-image-container" data-toggle-select="${i}">
                                <img src="${image.thumbnail}" alt="Image ${i + 1}">
                                <button class="remove-btn">&times;</button>
                            </div>
                            <textarea class="slot-prompt" data-index="${i}" placeholder="Click Analyze to generate prompt...">${displayPrompt}</textarea>
                            <div class="slot-controls">
                                <div class="mode-toggle">
                                    <button class="mode-btn ${currentMode === 'static' ? 'active' : ''}" data-mode="static" data-index="${i}">Static</button>
                                    <button class="mode-btn ${currentMode === 'dynamic' ? 'active' : ''}" data-mode="dynamic" data-index="${i}">Dynamic</button>
                                    <button class="mode-btn ${currentMode === 'handheld' ? 'active' : ''}" data-mode="handheld" data-index="${i}">Handheld</button>
                                    <button class="mode-btn ${currentMode === '90s' ? 'active' : ''}" data-mode="90s" data-index="${i}">90s</button>
                                    <button class="mode-btn ${currentMode === 'follow' ? 'active' : ''}" data-mode="follow" data-index="${i}">Follow</button>
                                    <button class="mode-btn ${currentMode === 'push' ? 'active' : ''}" data-mode="push" data-index="${i}">Push</button>
                                    <button class="mode-btn ${currentMode === 'pull' ? 'active' : ''}" data-mode="pull" data-index="${i}">Pull</button>
                                    <button class="mode-btn ${currentMode === 'arc' ? 'active' : ''}" data-mode="arc" data-index="${i}">Arc</button>
                                    <button class="mode-btn ${currentMode === 'rise' ? 'active' : ''}" data-mode="rise" data-index="${i}">Rise</button>
                                    <button class="mode-btn ${currentMode === 'drift' ? 'active' : ''}" data-mode="drift" data-index="${i}">Drift</button>
                                </div>
                                <div class="movement-toggle">
                                    <button class="movement-btn ${hasMovement ? 'active' : ''}" data-index="${i}">+ Move</button>
                                    <button class="movement-btn-plus ${image.addActiveMovement ? 'active' : ''}" data-index="${i}">++ Move</button>
                                    <button class="movement-btn-dynamic ${image.addDynamicMovement ? 'active' : ''}" data-index="${i}">+++ Move</button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="video-upload-slot" data-index="${i}">
                            <div class="slot-image-container">
                                <div class="slot-placeholder">
                                    <div class="slot-placeholder-icon">+</div>
                                    <div class="slot-placeholder-text">${i + 1}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            videoElements.uploadGrid.innerHTML = html;

            // Attach click handlers
            document.querySelectorAll('.video-upload-slot').forEach(slot => {
                const index = parseInt(slot.dataset.index);

                // Click on empty slot opens file dialog, click on filled image toggles selection
                slot.querySelector('.slot-image-container')?.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-btn')) {
                        videoState.images.splice(index, 1);
                        renderVideoUploadGrid();
                        updateVideoUI();
                        return;
                    }
                    if (!slot.classList.contains('filled')) {
                        videoElements.fileInput.click();
                    } else {
                        // Toggle selection - click image to deselect/reselect
                        const img = videoState.images[index];
                        if (img) {
                            img.selected = img.selected === false ? true : false;
                            renderVideoUploadGrid();
                            updateVideoUI();
                        }
                    }
                });

                // Prompt textarea updates - user can edit the full prompt directly
                const promptTextarea = slot.querySelector('.slot-prompt');
                if (promptTextarea) {
                    promptTextarea.addEventListener('input', (e) => {
                        const idx = parseInt(e.target.dataset.index);
                        if (videoState.images[idx]) {
                            // Store as custom full prompt (bypasses mode prefix)
                            videoState.images[idx].customPrompt = e.target.value;
                        }
                    });
                }

                // Mode toggle buttons - single select only
                slot.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const mode = e.target.dataset.mode;
                        const idx = parseInt(e.target.dataset.index);
                        if (videoState.images[idx]) {
                            // Single select - just set this mode
                            videoState.images[idx].modes = [mode];
                            videoState.images[idx].customMode = true;
                            videoState.images[idx].customPrompt = null; // Clear custom prompt so it rebuilds with new mode
                            renderVideoUploadGrid();
                            updateVideoUI();
                        }
                    });
                });

                // Movement toggle button (+ Move - subtle editorial)
                slot.querySelector('.movement-btn')?.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    if (videoState.images[idx]) {
                        videoState.images[idx].addMovement = !videoState.images[idx].addMovement;
                        // If enabling + Move, disable ++ Move and +++ Move
                        if (videoState.images[idx].addMovement) {
                            videoState.images[idx].addActiveMovement = false;
                            videoState.images[idx].addDynamicMovement = false;
                        }
                        videoState.images[idx].customPrompt = null; // Clear custom prompt so it rebuilds
                        renderVideoUploadGrid();
                        updateVideoUI();
                    }
                });

                // Active movement toggle button (++ Move - active editorial)
                slot.querySelector('.movement-btn-plus')?.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    if (videoState.images[idx]) {
                        videoState.images[idx].addActiveMovement = !videoState.images[idx].addActiveMovement;
                        // If enabling ++ Move, disable + Move and +++ Move
                        if (videoState.images[idx].addActiveMovement) {
                            videoState.images[idx].addMovement = false;
                            videoState.images[idx].addDynamicMovement = false;
                        }
                        videoState.images[idx].customPrompt = null; // Clear custom prompt so it rebuilds
                        renderVideoUploadGrid();
                        updateVideoUI();
                    }
                });

                // Dynamic movement toggle button (+++ Move - dynamic cinematic)
                slot.querySelector('.movement-btn-dynamic')?.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    if (videoState.images[idx]) {
                        videoState.images[idx].addDynamicMovement = !videoState.images[idx].addDynamicMovement;
                        // If enabling +++ Move, disable + Move and ++ Move
                        if (videoState.images[idx].addDynamicMovement) {
                            videoState.images[idx].addMovement = false;
                            videoState.images[idx].addActiveMovement = false;
                        }
                        videoState.images[idx].customPrompt = null; // Clear custom prompt so it rebuilds
                        renderVideoUploadGrid();
                        updateVideoUI();
                    }
                });
            });

            // Show/hide clear all button
            videoElements.clearAllBtn.style.display = videoState.images.length > 0 ? 'inline-block' : 'none';
        }

        function handleVideoFileSelect(e) {
            const files = Array.from(e.target.files);
            handleVideoFiles(files);
            e.target.value = '';
        }

        async function handleVideoFiles(files) {
            for (const file of files) {
                if (videoState.images.length >= VIDEO_SLOTS) break;

                const thumbnail = await createVideoThumbnail(file, 400);
                videoState.images.push({
                    file,
                    thumbnail,
                    uploaded: null,
                    prompt: '',
                    modes: [videoState.globalMovementMode],
                    selected: true,
                    customMode: false
                });
            }

            renderVideoUploadGrid();
            updateVideoUI();
        }

        function createVideoThumbnail(file, maxSize = 400) {
            return new Promise((resolve) => {
                const img = new Image();
                const url = URL.createObjectURL(file);

                img.onload = () => {
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        height = Math.round((height * maxSize) / width);
                        width = maxSize;
                    } else {
                        width = Math.round((width * maxSize) / height);
                        height = maxSize;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    URL.revokeObjectURL(url);
                    resolve(canvas.toDataURL('image/jpeg', 0.85));
                };

                img.src = url;
            });
        }

        function updateVideoUI() {
            const imageCount = videoState.images.length;
            const selectedCount = videoState.images.filter(img => img && img.selected !== false).length;

            videoElements.uploadCount.textContent = `${imageCount} / ${VIDEO_SLOTS} images`;

            // Enable/disable buttons
            videoElements.analyzeBtn.disabled = imageCount === 0;

            // Calculate how many videos will be generated
            const selectedImages = videoState.images.filter(img => img && img.selected !== false);
            let totalVideos = 0;
            let totalCost = 0;

            selectedImages.forEach(img => {
                // If no modes selected (after Clear), count as 0 - user needs to select modes
                const modes = img.modes && img.modes.length > 0 ? img.modes : [];
                const modeCount = modes.length || 0;
                const modelsEnabled = (videoState.useKling ? 1 : 0) + (videoState.useSeedance ? 1 : 0);
                totalVideos += modeCount * modelsEnabled;

                // Cost calculation
                if (videoState.useKling) {
                    totalCost += modeCount * KLING_PRICING[videoState.klingQuality] * videoState.duration;
                }
                if (videoState.useSeedance) {
                    totalCost += modeCount * SEEDANCE_PRICE_PER_VIDEO;
                }
            });

            // Enable generate if we have images with prompts AND modes selected, and at least one model selected
            const imagesWithPromptsAndModes = videoState.images.filter(img =>
                img && img.selected !== false &&
                (img.ambientDesc || img.customPrompt) &&
                img.modes && img.modes.length > 0
            ).length;
            const hasPromptsAndModels = imagesWithPromptsAndModes > 0 && (videoState.useKling || videoState.useSeedance);
            videoElements.generateBtn.disabled = !hasPromptsAndModels;

            // Update generate button text with cost estimate
            if (totalVideos > 0) {
                videoElements.generateBtn.textContent = `Generate ${totalVideos} video${totalVideos !== 1 ? 's' : ''} (~$${totalCost.toFixed(2)})`;
            } else {
                videoElements.generateBtn.textContent = 'Generate';
            }
        }

        async function handleVideoAnalyze() {
            const imagesToAnalyze = videoState.images.filter(img => img && img.selected !== false);
            if (imagesToAnalyze.length === 0) return;

            // Show status
            videoElements.status.style.display = 'flex';
            videoElements.statusText.textContent = 'Analyzing images...';
            videoElements.statusProgress.textContent = `0 / ${imagesToAnalyze.length}`;

            videoElements.analyzeBtn.disabled = true;

            let completed = 0;

            // Upload and analyze each image in parallel
            await Promise.all(imagesToAnalyze.map(async (img, idx) => {
                try {
                    // Upload image if not already uploaded
                    if (!img.uploaded) {
                        const fullDataUrl = await readVideoFileAsDataURL(img.file);
                        const compressedUrl = await compressVideoImageForUpload(fullDataUrl, 2000);
                        const result = await api.uploadBase64(compressedUrl);
                        img.uploaded = result.url;
                    }

                    // Build analysis prompt - get ambient motion, subtle movement, active movement, and dynamic movement
                    const analysisPrompt = `Analyze this fashion photography image from a Ron Dorff "Fearless Summer" campaign.

This is a premium men's swimwear/lifestyle brand - think Mediterranean summer, athletic men, minimal aesthetic, sun-drenched coastal settings.

Provide FOUR motion descriptions in this exact format:

AMBIENT: [Describe subtle environmental motion - wind in hair, fabric shifting, water ripples, leaves moving, light playing on skin. Keep subject mostly still. 20-30 words max.]

MOVEMENT: [Describe a natural subtle character action - slowly turning head, shifting weight, slight gesture. Editorial and minimal. 15-25 words max.]

ACTIVE_MOVEMENT: [Describe walking/turning action - walks confidently toward camera, turns 180 degrees, steps forward and pauses, rises from position. Continuous 5-second action. 20-30 words max.]

DYNAMIC_MOVEMENT: [Describe high-energy cinematic action. Choose ONE environment-agnostic movement:
- Spins 360 degrees in place showing outfit from all angles
- Breaks into a light jog/run toward camera
- Takes several quick strides forward, stops suddenly, strikes a pose
- Walks backward then spins around and continues forward
- Does a small jump in place, lands, continues walking
- Starts from stillness, builds momentum, breaks into a run
- Lunges forward dramatically, transitions into walking
- Raises arms overhead in stretch, brings down while stepping forward
Pick one that fits the current pose. Make it athletic and cinematic. 20-30 words max.]

Do NOT mention "breathing" - it looks unnatural. Focus on premium editorial movements.
Return ONLY the four lines in the format above, nothing else.`;

                    const response = await fetch('/api/analyze-gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image_url: img.uploaded,
                            prompt: analysisPrompt
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const content = data.content || '';

                        // Parse AMBIENT, MOVEMENT, ACTIVE_MOVEMENT, and DYNAMIC_MOVEMENT from response
                        const ambientMatch = content.match(/AMBIENT:\s*(.+?)(?=\n|MOVEMENT:|$)/i);
                        const movementMatch = content.match(/MOVEMENT:\s*(.+?)(?=\n|ACTIVE_MOVEMENT:|$)/im);
                        const activeMovementMatch = content.match(/ACTIVE_MOVEMENT:\s*(.+?)(?=\n|DYNAMIC_MOVEMENT:|$)/im);
                        const dynamicMovementMatch = content.match(/DYNAMIC_MOVEMENT:\s*(.+?)$/im);

                        let ambientDesc = ambientMatch ? ambientMatch[1].trim() : 'Wind gently moves through the scene, subtle light plays across the skin.';
                        let movementDesc = movementMatch ? movementMatch[1].trim() : 'Slowly turns head to gaze toward the horizon.';
                        let activeMovementDesc = activeMovementMatch ? activeMovementMatch[1].trim() : 'Walks confidently toward camera, natural stride, steady approach.';
                        let dynamicMovementDesc = dynamicMovementMatch ? dynamicMovementMatch[1].trim() : 'Spins 360 degrees in place, showing outfit from all angles, confident smooth rotation.';

                        // Clean up brackets if present
                        ambientDesc = ambientDesc.replace(/^\[|\]$/g, '').trim();
                        movementDesc = movementDesc.replace(/^\[|\]$/g, '').trim();
                        activeMovementDesc = activeMovementDesc.replace(/^\[|\]$/g, '').trim();
                        dynamicMovementDesc = dynamicMovementDesc.replace(/^\[|\]$/g, '').trim();

                        // Store all descriptions
                        img.ambientDesc = ambientDesc;
                        img.movementDesc = movementDesc;
                        img.activeMovementDesc = activeMovementDesc;
                        img.dynamicMovementDesc = dynamicMovementDesc;
                        img.customPrompt = null; // Clear any custom edit

                        console.log(`[Analyze ${idx}] Ambient: ${ambientDesc}`);
                        console.log(`[Analyze ${idx}] Movement: ${movementDesc}`);
                        console.log(`[Analyze ${idx}] Active Movement: ${activeMovementDesc}`);
                        console.log(`[Analyze ${idx}] Dynamic Movement: ${dynamicMovementDesc}`);
                    }
                } catch (err) {
                    console.error(`Error analyzing image ${idx}:`, err);
                    img.ambientDesc = 'Wind moves gently through the scene, light plays across the skin.';
                    img.movementDesc = 'Slowly turns head to look toward the horizon.';
                    img.activeMovementDesc = 'Walks confidently toward camera, natural stride, steady approach.';
                    img.dynamicMovementDesc = 'Spins 360 degrees in place, showing outfit from all angles, confident smooth rotation.';
                }

                completed++;
                videoElements.statusProgress.textContent = `${completed} / ${imagesToAnalyze.length}`;
            }));

            // Hide status and re-render
            videoElements.status.style.display = 'none';
            videoElements.analyzeBtn.disabled = false;
            renderVideoUploadGrid();
            updateVideoUI();
        }

        function readVideoFileAsDataURL(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        function compressVideoImageForUpload(dataUrl, maxSize = 2000) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;

                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = Math.round((height * maxSize) / width);
                            width = maxSize;
                        } else {
                            width = Math.round((width * maxSize) / height);
                            height = maxSize;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    resolve(canvas.toDataURL('image/jpeg', 0.9));
                };
                img.src = dataUrl;
            });
        }

        async function handleVideoGenerate() {
            // Filter images that have prompts AND modes selected
            const selectedImages = videoState.images.filter(img =>
                img && img.selected !== false &&
                (img.ambientDesc || img.customPrompt) &&
                img.modes && img.modes.length > 0
            );
            if (selectedImages.length === 0) return;

            // Build list of all video generation tasks
            const tasks = [];

            selectedImages.forEach((img, imgIdx) => {
                const modes = img.modes;

                modes.forEach(mode => {
                    // Get the actual mode (resolve 'random')
                    let actualMode = mode;
                    if (mode === 'random') {
                        const randomModes = ['static', 'dynamic', 'handheld', '90s', 'follow', 'push', 'pull', 'arc', 'rise', 'drift'];
                        actualMode = randomModes[Math.floor(Math.random() * randomModes.length)];
                    }

                    // Build full prompt: use customPrompt if user edited it, otherwise build from ambient/movement + mode prefix
                    let fullPrompt;
                    if (img.customPrompt) {
                        // User manually edited the prompt - use it as-is
                        fullPrompt = img.customPrompt;
                    } else {
                        // Build from ambient/movement descriptions + mode prefix
                        fullPrompt = buildFullPrompt(img, actualMode);
                    }

                    console.log(`[Video Task] Mode: ${actualMode}, Prompt: ${fullPrompt}`);

                    if (videoState.useKling) {
                        tasks.push({
                            imageUrl: img.uploaded,
                            prompt: fullPrompt,
                            model: 'kling',
                            quality: videoState.klingQuality,
                            mode: actualMode,
                            imgIdx
                        });
                    }

                    if (videoState.useSeedance) {
                        tasks.push({
                            imageUrl: img.uploaded,
                            prompt: fullPrompt,
                            model: 'seedance',
                            mode: actualMode,
                            imgIdx
                        });
                    }
                });
            });

            if (tasks.length === 0) return;

            // Show results section
            videoElements.resultsSection.style.display = 'block';

            // Show status
            videoElements.status.style.display = 'flex';
            videoElements.statusText.textContent = 'Generating videos...';
            videoElements.statusProgress.textContent = `0 / ${tasks.length}`;

            videoElements.generateBtn.disabled = true;

            // Create placeholder cards
            tasks.forEach((task, idx) => {
                const card = document.createElement('div');
                card.className = 'video-result-card generating';
                card.id = `video-result-${idx}`;
                card.innerHTML = `
                    <div class="generating-overlay">
                        <div class="generating-spinner"></div>
                        <div class="generating-text">${task.model === 'kling' ? 'Kling V3' : 'Seedance'}...</div>
                    </div>
                    <video style="aspect-ratio: ${videoState.aspectRatio.replace(':', '/')};"></video>
                    <div class="card-footer">
                        <span class="card-label">${MOVEMENT_PROMPTS[task.mode]?.description || task.mode}</span>
                        <span class="card-model">${task.model === 'kling' ? `Kling V3 ${videoState.klingQuality}` : 'Seedance'}</span>
                        <button class="btn btn--sm" disabled>Download</button>
                    </div>
                `;
                videoElements.resultsGrid.insertBefore(card, videoElements.resultsGrid.firstChild);
            });

            let completed = 0;

            // Generate all videos in parallel
            await Promise.all(tasks.map(async (task, idx) => {
                try {
                    let videoUrl;

                    if (task.model === 'kling') {
                        videoUrl = await generateKlingVideo(task);
                    } else {
                        videoUrl = await generateSeedanceVideo(task);
                    }

                    // Update card with result
                    const card = document.getElementById(`video-result-${idx}`);
                    if (card && videoUrl) {
                        card.classList.remove('generating');
                        const overlay = card.querySelector('.generating-overlay');
                        if (overlay) overlay.remove();

                        const video = card.querySelector('video');
                        video.src = videoUrl;
                        video.controls = true;
                        video.loop = true;

                        const downloadBtn = card.querySelector('.btn');
                        downloadBtn.disabled = false;
                        downloadBtn.onclick = () => {
                            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                            downloadVideoFile(videoUrl, `RonDorff_Video_${task.mode}_${task.model}_${timestamp}.mp4`);
                        };

                        videoState.results.push({ url: videoUrl, task });
                    }
                } catch (err) {
                    console.error(`Error generating video ${idx}:`, err);
                    const card = document.getElementById(`video-result-${idx}`);
                    if (card) {
                        card.classList.remove('generating');
                        const overlay = card.querySelector('.generating-overlay');
                        if (overlay) {
                            overlay.innerHTML = `<div class="generating-text" style="color: #dc2626;">Failed</div>`;
                        }
                    }
                }

                completed++;
                videoElements.statusProgress.textContent = `${completed} / ${tasks.length}`;
            }));

            // Hide status
            videoElements.status.style.display = 'none';
            videoElements.generateBtn.disabled = false;
            updateVideoUI();
        }

        async function generateKlingVideo(task) {
            // Use Kling V3 (image-to-video) - Pro or Standard
            const model = task.quality === 'pro' ? 'v3-pro' : 'v3-standard';

            const params = {
                model,
                image_url: task.imageUrl,
                prompt: task.prompt,
                duration: String(videoState.duration),
                aspect_ratio: videoState.aspectRatio,
                generate_audio: false, // $0.224/s without audio, $0.336/s with audio
                falKey: api.getFalKey()
            };

            const response = await fetch('/api/video', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Kling V3 video generation failed');
            }

            const data = await response.json();
            return data.video?.url || data.url;
        }

        async function generateSeedanceVideo(task) {
            const params = {
                image_url: task.imageUrl,
                prompt: task.prompt,
                aspect_ratio: videoState.aspectRatio,
                resolution: '720p',
                duration: String(videoState.duration),
                camera_fixed: task.mode === 'static',
                model_version: '1.5',
                falKey: api.getFalKey()
            };

            const response = await fetch('/api/video/seedance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Seedance video generation failed');
            }

            const data = await response.json();
            return data.video?.url || data.url;
        }

        async function downloadVideoFile(url, filename) {
            try {
                const proxyUrl = `/api/proxy-download?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(blobUrl);
            } catch (e) {
                window.open(url, '_blank');
            }
        }

        // Initialize video tab
        initVideoTab();
    </script>
</body>
</html>
