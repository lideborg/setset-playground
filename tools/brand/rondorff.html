<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ron Dorff - Fearless Summer</title>
    <link rel="stylesheet" href="/shared/css/tokens.css">
    <link rel="stylesheet" href="/shared/css/base.css">
    <link rel="stylesheet" href="/shared/css/components.css">
    <style>
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: var(--space-md);
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--gainsboro);
        }

        .page-title {
            font-size: var(--text-lg);
            font-weight: 600;
        }

        .page-subtitle {
            font-size: var(--text-sm);
            color: var(--slate);
            font-weight: 400;
            margin-left: var(--space-sm);
        }

        /* Settings Bar */
        .settings-bar {
            display: flex;
            gap: var(--space-md);
            padding: var(--space-sm);
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            align-items: center;
            flex-wrap: wrap;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: var(--space-2xs);
        }

        .setting-item label {
            font-size: var(--text-xs);
            color: var(--slate);
            white-space: nowrap;
        }

        .btn-group-compact {
            display: flex;
            gap: 2px;
        }

        .btn-group-compact button {
            padding: 4px 8px;
            font-size: var(--text-2xs);
            font-weight: 500;
            border: 1px solid var(--gainsboro);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-group-compact button:first-child {
            border-radius: var(--radius-xs) 0 0 var(--radius-xs);
        }

        .btn-group-compact button:last-child {
            border-radius: 0 var(--radius-xs) var(--radius-xs) 0;
        }

        .btn-group-compact button.active {
            background: var(--jet);
            border-color: var(--jet);
            color: var(--white);
        }

        /* Sliders */
        .slider-container {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .slider-container input[type="range"] {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            background: var(--gainsboro);
            border-radius: 2px;
            outline: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--jet);
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-value {
            font-size: var(--text-xs);
            color: var(--jet);
            font-weight: 600;
            min-width: 32px;
        }

        /* Sections */
        .section {
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-sm);
        }

        .section-title {
            font-size: var(--text-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-subtitle {
            font-size: var(--text-xs);
            color: var(--french-gray);
        }

        /* Section Tabs */
        .section-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: var(--space-sm);
        }

        .section-tab {
            padding: 6px 16px;
            font-size: var(--text-xs);
            font-weight: 500;
            border: 1px solid var(--gainsboro);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .section-tab:first-child {
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        }

        .section-tab:last-child {
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .section-tab.active {
            background: var(--jet);
            border-color: var(--jet);
            color: var(--white);
        }

        .section-tab:hover:not(.active) {
            border-color: var(--slate);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Model Selection */
        .model-grid {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        .model-grid.setset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: var(--space-sm);
        }

        .model-card {
            position: relative;
            width: 120px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .setset-grid .model-card {
            width: auto;
        }

        .model-card img {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            border-radius: var(--radius-sm);
            border: 3px solid transparent;
            transition: all var(--transition-fast);
        }

        .model-card:hover img {
            border-color: var(--slate);
        }

        .model-card.selected img {
            border-color: var(--jet);
        }

        .model-card.selected::after {
            content: '✓';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: var(--jet);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .setset-grid .model-card.selected::after {
            width: 18px;
            height: 18px;
            font-size: 10px;
            top: 4px;
            right: 4px;
        }

        .model-name {
            text-align: center;
            font-size: var(--text-xs);
            margin-top: var(--space-2xs);
            color: var(--slate);
        }

        .setset-grid .model-name {
            font-size: 9px;
        }

        /* Product Grid - New Layout */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--space-sm);
        }

        /* Custom Product Upload Grid */
        .custom-product-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--space-sm);
        }

        .custom-product-slot {
            aspect-ratio: 3/4;
            border: 2px dashed var(--gainsboro);
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: var(--off-white);
            transition: all var(--transition-fast);
        }

        .custom-product-slot:hover {
            border-color: var(--slate);
        }

        .custom-product-slot.filled {
            border-style: solid;
            border-color: var(--gainsboro);
        }

        .custom-product-slot.filled.has-group {
            border-color: var(--jet);
        }

        .custom-product-slot.paste-ready {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }

        .custom-product-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .custom-product-slot .placeholder {
            text-align: center;
            color: var(--french-gray);
            font-size: var(--text-xs);
        }

        .custom-product-slot .placeholder-hint {
            font-size: var(--text-2xs);
            margin-top: 2px;
            opacity: 0.7;
        }

        .custom-product-slot .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 18px;
            height: 18px;
            background: rgba(0,0,0,0.7);
            color: var(--white);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .custom-product-slot.filled:hover .remove-btn {
            display: flex;
        }

        .custom-product-slot .group-buttons {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 2px;
        }

        .custom-product-slot.filled .group-buttons {
            display: flex;
        }

        .custom-product-slot .group-btn {
            width: 18px;
            height: 18px;
            border: none;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--white);
            opacity: 0.4;
        }

        .custom-product-slot .group-btn:hover {
            opacity: 0.7;
        }

        .custom-product-slot .group-btn.active {
            opacity: 1;
        }

        .custom-product-slot .group-btn.g1 { background: #e74c3c; }
        .custom-product-slot .group-btn.g2 { background: #3498db; }
        .custom-product-slot .group-btn.g3 { background: #2ecc71; }
        .custom-product-slot .group-btn.g4 { background: #9b59b6; }

        .product-card {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .product-card .product-name {
            font-size: var(--text-2xs);
            color: var(--jet);
            text-align: center;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .product-card .product-image {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            border-radius: var(--radius-sm);
            border: 2px solid var(--gainsboro);
            transition: all var(--transition-fast);
        }

        .product-card.has-group .product-image {
            border-color: var(--jet);
        }

        .product-card .group-buttons {
            display: flex;
            gap: 2px;
            margin-top: 4px;
        }

        .product-card .group-btn {
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--white);
            opacity: 0.3;
        }

        .product-card .group-btn:hover {
            opacity: 0.7;
        }

        .product-card .group-btn.active {
            opacity: 1;
        }

        .product-card .group-btn.g1 { background: #e74c3c; }
        .product-card .group-btn.g2 { background: #3498db; }
        .product-card .group-btn.g3 { background: #2ecc71; }
        .product-card .group-btn.g4 { background: #9b59b6; }

        /* Environment Upload */
        .environment-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-sm);
        }

        .env-slot {
            aspect-ratio: 4/3;
            border: 2px dashed var(--gainsboro);
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: var(--off-white);
            transition: all var(--transition-fast);
        }

        .env-slot:hover {
            border-color: var(--slate);
        }

        .env-slot.filled {
            border-style: solid;
            border-color: var(--jet);
        }

        .env-slot.paste-ready {
            border-color: #3498db;
            border-width: 2px;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }

        .env-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .env-slot .placeholder {
            text-align: center;
            color: var(--french-gray);
            font-size: var(--text-xs);
        }

        .env-slot .placeholder-hint {
            font-size: var(--text-2xs);
            margin-top: 2px;
            opacity: 0.7;
        }

        .env-slot .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.7);
            color: var(--white);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .env-slot.filled:hover .remove-btn {
            display: flex;
        }

        /* Environment Header Row */
        .env-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .env-toggles {
            display: flex;
            gap: var(--space-md);
        }

        /* Environment Tabs */
        .env-tabs {
            display: flex;
            gap: 2px;
        }

        .env-tab {
            padding: 6px 16px;
            font-size: var(--text-xs);
            font-weight: 500;
            border: 1px solid var(--gainsboro);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .env-tab:first-child {
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        }

        .env-tab:last-child {
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .env-tab.active {
            background: var(--jet);
            border-color: var(--jet);
            color: var(--white);
        }

        .env-tab:hover:not(.active) {
            border-color: var(--slate);
        }

        /* Preset Environment Grid */
        .preset-env-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
            max-height: 500px;
            overflow-y: auto;
            padding: var(--space-sm);
            align-items: start;
        }

        .preset-env-item {
            border-radius: var(--radius-sm);
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all var(--transition-fast);
            background: var(--off-white);
        }

        .preset-env-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        .preset-env-item:hover {
            border-color: var(--slate);
        }

        .preset-env-item.selected {
            border-color: var(--jet);
        }

        .preset-env-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .preset-count {
            font-size: var(--text-xs);
            color: var(--slate);
        }

        .deselect-btn {
            padding: 4px 12px;
            font-size: var(--text-xs);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            background: var(--white);
            color: var(--slate);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .deselect-btn:hover {
            border-color: var(--jet);
            color: var(--jet);
        }

        .env-options {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-sm);
            padding-top: var(--space-sm);
            border-top: 1px solid var(--gainsboro);
        }

        /* Additional Prompt Box */
        .prompt-box {
            margin-top: var(--space-sm);
            padding-top: var(--space-sm);
            border-top: 1px solid var(--gainsboro);
        }

        .prompt-box label {
            font-size: var(--text-xs);
            color: var(--slate);
            display: block;
            margin-bottom: var(--space-2xs);
        }

        .prompt-box textarea {
            width: 100%;
            padding: var(--space-xs);
            font-size: var(--text-xs);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            resize: vertical;
            min-height: 50px;
            font-family: inherit;
        }

        .prompt-box textarea:focus {
            outline: none;
            border-color: var(--jet);
        }

        .env-option {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .env-option label {
            font-size: var(--text-xs);
            color: var(--slate);
        }

        .toggle-switch {
            position: relative;
            width: 36px;
            height: 20px;
            background: var(--gainsboro);
            border-radius: 10px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .toggle-switch.active {
            background: var(--jet);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: var(--white);
            border-radius: 50%;
            transition: all var(--transition-fast);
        }

        .toggle-switch.active::after {
            left: 18px;
        }

        /* Generate Bar - Bottom */
        .generate-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-sm) var(--space-md);
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
        }

        .selection-summary {
            font-size: var(--text-sm);
            color: var(--slate);
        }

        .generate-btn {
            padding: 10px 32px;
            font-size: var(--text-sm);
            font-weight: 600;
            background: var(--jet);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--white);
        }

        .generate-btn:hover {
            background: var(--slate);
        }

        .generate-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Progress & Results */
        .progress-section {
            display: none;
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-xs);
        }

        .progress-title {
            font-size: var(--text-sm);
            font-weight: 600;
        }

        .progress-count {
            font-size: var(--text-sm);
            color: var(--slate);
        }

        .progress-bar-bg {
            height: 4px;
            background: var(--gainsboro);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--jet);
            width: 0%;
            transition: width 0.3s ease;
        }

        .results-section {
            display: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-sm);
        }

        .result-card {
            aspect-ratio: 3/4;
            border-radius: var(--radius-sm);
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .result-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .result-card .result-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: var(--space-xs);
            background: rgba(0,0,0,0.7);
            color: var(--white);
            font-size: var(--text-xs);
            text-align: center;
        }

        /* Inline loader */
        .inline-loader {
            display: none;
            padding: var(--space-md);
            text-align: center;
            background: var(--off-white);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
        }

        .inline-loader.active {
            display: block;
        }

        .loader-message {
            font-size: var(--text-sm);
            color: var(--jet);
            margin-bottom: var(--space-xs);
        }

        .loader-progress {
            font-size: var(--text-xs);
            color: var(--slate);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Ron Dorff <span class="page-subtitle">Fearless Summer</span></h1>
        </div>

        <!-- Settings Bar -->
        <div class="settings-bar">
            <div class="setting-item">
                <label>Ratio:</label>
                <div class="btn-group-compact" id="ratio-buttons">
                    <button data-value="1:1">1:1</button>
                    <button data-value="3:4">3:4</button>
                    <button data-value="4:3">4:3</button>
                    <button data-value="9:16">9:16</button>
                    <button class="active" data-value="16:9">16:9</button>
                </div>
            </div>
            <div class="setting-item">
                <label>Seeds:</label>
                <div class="btn-group-compact" id="seeds-buttons">
                    <button class="active" data-value="1">1</button>
                    <button data-value="2">2</button>
                    <button data-value="3">3</button>
                    <button data-value="4">4</button>
                </div>
            </div>
            <div class="setting-item">
                <label>Duo %:</label>
                <div class="slider-container">
                    <input type="range" id="duo-slider" min="0" max="100" value="50">
                    <span class="slider-value" id="duo-value">50%</span>
                </div>
            </div>
            <div class="setting-item">
                <label>Interaction:</label>
                <div class="slider-container">
                    <input type="range" id="interaction-slider" min="0" max="3" value="1" step="1">
                    <span class="slider-value" id="interaction-value">Medium</span>
                </div>
            </div>
            <div class="setting-item">
                <label>Dynamic:</label>
                <div class="slider-container">
                    <input type="range" id="dynamic-slider" min="0" max="3" value="1" step="1">
                    <span class="slider-value" id="dynamic-value">Medium</span>
                </div>
            </div>
        </div>

        <!-- Models Section -->
        <div class="section">
            <div class="section-header">
                <div>
                    <span class="section-title">Models</span>
                    <span class="section-subtitle"> — Select one or more</span>
                </div>
            </div>
            <div class="section-tabs" id="model-tabs">
                <button class="section-tab active" data-tab="rondorff">Ron Dorff</button>
                <button class="section-tab" data-tab="setset">Setset</button>
            </div>
            <div class="tab-panel active" id="model-panel-rondorff">
                <div class="model-grid" id="model-grid-rondorff"></div>
            </div>
            <div class="tab-panel" id="model-panel-setset">
                <div class="model-grid setset-grid" id="model-grid-setset"></div>
            </div>
        </div>

        <!-- Products Section -->
        <div class="section">
            <div class="section-header">
                <div>
                    <span class="section-title">Products</span>
                    <span class="section-subtitle"> — Select group for each product (1-4)</span>
                </div>
            </div>
            <div class="section-tabs" id="product-tabs">
                <button class="section-tab active" data-tab="rondorff">Ron Dorff</button>
                <button class="section-tab" data-tab="upload">Upload</button>
            </div>
            <div class="tab-panel active" id="product-panel-rondorff">
                <div class="product-grid" id="product-grid"></div>
            </div>
            <div class="tab-panel" id="product-panel-upload">
                <div class="custom-product-grid" id="custom-product-grid"></div>
            </div>
            <input type="file" id="product-file-input" accept="image/*" multiple style="display: none;">
        </div>

        <!-- Environments Section -->
        <div class="section">
            <div class="section-header">
                <div>
                    <span class="section-title">Environments</span>
                    <span class="section-subtitle"> — Select preset locations or upload your own</span>
                </div>
            </div>
            <div class="env-header-row">
                <div class="env-tabs">
                    <button class="env-tab active" data-tab="upload">Upload</button>
                    <button class="env-tab" data-tab="beach">Beach</button>
                    <button class="env-tab" data-tab="architecture">Architecture</button>
                </div>
                <div class="env-toggles">
                    <div class="env-option">
                        <div class="toggle-switch" id="cinematic-toggle"></div>
                        <label>Cinematic</label>
                    </div>
                    <div class="env-option">
                        <div class="toggle-switch" id="describe-only-toggle"></div>
                        <label>Describe only</label>
                    </div>
                </div>
            </div>
            <div id="env-upload-panel">
                <div class="environment-grid" id="environment-grid"></div>
            </div>
            <div id="env-beach-panel" style="display: none;">
                <div class="preset-env-header">
                    <span class="preset-count" id="beach-count">0 selected</span>
                    <button class="deselect-btn" id="deselect-beach">Deselect all</button>
                </div>
                <div class="preset-env-grid" id="beach-grid"></div>
            </div>
            <div id="env-architecture-panel" style="display: none;">
                <div class="preset-env-header">
                    <span class="preset-count" id="architecture-count">0 selected</span>
                    <button class="deselect-btn" id="deselect-architecture">Deselect all</button>
                </div>
                <div class="preset-env-grid" id="architecture-grid"></div>
            </div>
            <input type="file" id="env-file-input" accept="image/*" multiple style="display: none;">
            <div class="prompt-box">
                <label>Additional styling notes (lighting, era, mood, etc.)</label>
                <textarea id="additional-prompt" placeholder="e.g., shot with a 90s film camera, warm glowy skin, flash photography, vintage aesthetic..."></textarea>
            </div>
        </div>

        <!-- Generate Bar -->
        <div class="generate-bar">
            <div class="selection-summary" id="selection-summary">Select models, products & environments</div>
            <button class="generate-btn" id="generate-btn" disabled>Generate</button>
        </div>

        <!-- Loader -->
        <div class="inline-loader" id="loader">
            <div class="loader-message" id="loader-message">Preparing...</div>
            <div class="loader-progress" id="loader-progress">Analyzing images...</div>
        </div>

        <!-- Progress -->
        <div class="progress-section" id="progress-section">
            <div class="progress-header">
                <span class="progress-title" id="progress-title">Generating...</span>
                <span class="progress-count" id="progress-count">0 / 0</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <!-- Results -->
        <div class="results-section" id="results-section">
            <div class="section-header">
                <span class="section-title">Results</span>
            </div>
            <div class="results-grid" id="results-grid"></div>
        </div>
    </div>

    <script src="/shared/js/api.js"></script>
    <script src="/shared/js/loader.js"></script>
    <script src="/shared/js/lightbox.js"></script>
    <script>
        // ========== DATA ==========
        const MODELS = [
            {
                id: 'model-01',
                name: 'Model 1',
                image: '/assets/brand/rondorff/models/model-01.jpg',
                thumb: '/assets/brand/rondorff/models/thumbs/model-01.jpg',
                description: 'Male model with medium-length brown hair, light stubble beard, striking defined features, warm tanned skin, intense gaze, athletic build with defined abs and toned muscular physique, classic masculine proportions'
            },
            {
                id: 'model-02',
                name: 'Model 2',
                image: '/assets/brand/rondorff/models/model-02.jpg',
                thumb: '/assets/brand/rondorff/models/thumbs/model-02.jpg',
                description: 'Male model with short brown hair, clean-shaven, youthful athletic appearance, sharp jawline, cool confident presence, athletic build with defined abs and toned muscular physique, classic masculine proportions'
            }
        ];

        // Setset talent roster
        const SETSET_MODELS = [
            { id: 'james', name: 'James Wilson', image: '/shared/images/talent/talent-01_JamesWilson.png', thumb: '/shared/images/talent/thumbs/talent-01_JamesWilson.png', description: 'An East Asian male in his 40s with short, slicked back black hair with gray streaks and a medium skin tone.' },
            { id: 'maya', name: 'Maya Johnson', image: '/shared/images/talent/talent-02_MayaJohnson.png', thumb: '/shared/images/talent/thumbs/talent-02_MayaJohnson.png', description: 'A mid 20s female with dark brown wavy hair, medium tan skin, and strong eyebrows.' },
            { id: 'river', name: 'River Blake', image: '/shared/images/talent/talent-03_RiverBlake.png', thumb: '/shared/images/talent/thumbs/talent-03_RiverBlake.png', description: 'A pale-skinned Caucasian male in his late 20s with platinum blonde, straight, medium length hair and intense blue eyes.' },
            { id: 'emma', name: 'Emma Sullivan', image: '/shared/images/talent/talent-04_EmmaSullivan.png', thumb: '/shared/images/talent/thumbs/talent-04_EmmaSullivan.png', description: 'A young Caucasian female in her early 20s with brown straight shoulder-length hair, fair skin, and prominent cheekbones.' },
            { id: 'marcus', name: 'Marcus Brown', image: '/shared/images/talent/talent-05_MarcusBrown.png', thumb: '/shared/images/talent/thumbs/talent-05_MarcusBrown.png', description: 'A male in his 30s with a dark skin tone, short black dreadlocks, and pronounced cheekbones.' },
            { id: 'zara', name: 'Zara Mitchell', image: '/shared/images/talent/talent-06_ZaraMitchell.png', thumb: '/shared/images/talent/thumbs/talent-06_ZaraMitchell.png', description: 'A young female with dark skin, natural black hair, and striking features.' },
            { id: 'sophia', name: 'Sophia Anderson', image: '/shared/images/talent/talent-07_SophiaAnderson.png', thumb: '/shared/images/talent/thumbs/talent-07_SophiaAnderson.png', description: 'A young Caucasian female in her early 20s with light brown, wavy, shoulder-length hair, fair skin, and thick eyebrows.' },
            { id: 'liam', name: 'Liam Garcia', image: '/shared/images/talent/talent-08_LiamGarcia.png', thumb: '/shared/images/talent/thumbs/talent-08_LiamGarcia.png', description: 'A male model with warm features and athletic build.' },
            { id: 'nina', name: 'Nina Davis', image: '/shared/images/talent/talent-09_NinaDavis.png', thumb: '/shared/images/talent/thumbs/talent-09_NinaDavis.png', description: 'A mid 20s Southeast Asian female with long, straight black hair, medium brown skin tone, and high cheekbones.' },
            { id: 'luna', name: 'Luna Park', image: '/shared/images/talent/talent-11_LunaPark.png', thumb: '/shared/images/talent/thumbs/talent-11_LunaPark.png', description: 'A Caucasian female in her early 20s with long brown hair, fair skin, and thick eyebrows.' },
            { id: 'noah', name: 'Noah Chen', image: '/shared/images/talent/talent-12_NoahChen.png', thumb: '/shared/images/talent/thumbs/talent-12_NoahChen.png', description: 'A male in his late 20s with a medium brown skin tone, short curly black hair, and a pronounced jawline.' },
            { id: 'mia', name: 'Mia Parker', image: '/shared/images/talent/talent-13_MiaParker.png', thumb: '/shared/images/talent/thumbs/talent-13_MiaParker.png', description: 'A young Black female with short natural curls and deep brown skin.' },
            { id: 'riley', name: 'Riley Morgan', image: '/shared/images/talent/talent-14_RileyMorgan.png', thumb: '/shared/images/talent/thumbs/talent-14_RileyMorgan.png', description: 'East Asian male in his early 20s with short, wavy dark brown hair and a light skin tone.' },
            { id: 'isabella', name: 'Isabella Rodriguez', image: '/shared/images/talent/talent-16_IsabellaRodriguez.png', thumb: '/shared/images/talent/thumbs/talent-16_IsabellaRodriguez.png', description: 'A Caucasian woman in her 40s with grey shoulder-length hair and intense blue eyes.' },
            { id: 'quinn', name: 'Quinn Santos', image: '/shared/images/talent/talent-17_QuinnSantos.png', thumb: '/shared/images/talent/thumbs/talent-17_QuinnSantos.png', description: 'Young Latino male in early 20s with short black hair, medium brown skin, and distinctive broad nose and full lips.' },
            { id: 'casey', name: 'Casey White', image: '/shared/images/talent/talent-18_CaseyWhite.png', thumb: '/shared/images/talent/thumbs/talent-18_CaseyWhite.png', description: 'A mid 20s Asian female with long black hair pulled back, medium skin tone, and a symmetrical face.' },
            { id: 'drew', name: 'Drew Martinez', image: '/shared/images/talent/talent-20_DrewMartinez.png', thumb: '/shared/images/talent/thumbs/talent-20_DrewMartinez.png', description: 'Young East Asian male with short black hair and white eyebrows.' },
            { id: 'avery', name: 'Avery Taylor', image: '/shared/images/talent/talent-21_AveryTaylor.png', thumb: '/shared/images/talent/thumbs/talent-21_AveryTaylor.png', description: 'A mid-20s Black female with short curly black hair, medium brown skin, and strong eyebrows.' },
            { id: 'parker', name: 'Parker Miller', image: '/shared/images/talent/talent-22_ParkerMiller.png', thumb: '/shared/images/talent/thumbs/talent-22_ParkerMiller.png', description: 'A young male with athletic build and warm features.' },
            { id: 'morgan', name: 'Morgan Kim', image: '/shared/images/talent/talent-23_MorganKim.png', thumb: '/shared/images/talent/thumbs/talent-23_MorganKim.png', description: 'A young Caucasian male in his early 20s with platinum blonde hair styled with volume, fair skin, striking blue eyes, and prominent eyebrows.' },
            { id: 'andre', name: 'Andre Jackson', image: '/shared/images/talent/talent-24_AndreJackson.png', thumb: '/shared/images/talent/thumbs/talent-24_AndreJackson.png', description: 'A late 20s Black male with a short buzz cut and dark brown skin, featuring smooth skin and symmetrical features.' },
            { id: 'sofia', name: 'Sofia Rodriguez', image: '/shared/images/talent/talent-27_SofiaRodriguez.png', thumb: '/shared/images/talent/thumbs/talent-27_SofiaRodriguez.png', description: 'A young Latina female with warm brown skin and dark hair.' },
            { id: 'clara', name: 'Clara Devereaux', image: '/shared/images/talent/talent-29_ClaraDevereaux.png', thumb: '/shared/images/talent/thumbs/talent-29_ClaraDevereaux.png', description: 'A young female with elegant features and fair skin.' }
        ];

        const PRODUCTS = [
            { id: '21bg97', name: 'Tote Bag', image: '/assets/brand/rondorff/products/21bg97.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21bg97.jpg', description: 'Peach/coral canvas tote bag with bold "FEARLESS SUMMER" black text print, casual beach accessory' },
            { id: '21ca653dd', name: 'Cap', image: '/assets/brand/rondorff/products/21ca653dd.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ca653dd.jpg', description: 'Bright orange baseball cap with curved brim, "Sunset Boy" embroidered text, sporty summer style' },
            { id: '21sr20dd', name: 'Swim Orange', image: '/assets/brand/rondorff/products/21sr20dd.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21sr20dd.jpg', description: 'Orange/peach low-rise European swim briefs, minimal coverage, athletic cut, sporty silhouette' },
            { id: '21sr21b', name: 'Swim Beige', image: '/assets/brand/rondorff/products/21sr21b.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21sr21b.jpg', description: 'Beige/tan low-rise European swim briefs, minimal coverage, athletic cut, sporty silhouette' },
            { id: '21ss20', name: 'Terry Shorts', image: '/assets/brand/rondorff/products/21ss20.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ss20.jpg', description: 'Cream/off-white terry cloth shorts, soft texture, relaxed fit, drawstring waist' },
            { id: '21ss21', name: 'Cargo Shorts', image: '/assets/brand/rondorff/products/21ss21.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ss21.jpg', description: 'Khaki/beige cargo shorts, utilitarian pockets, casual summer style' },
            { id: '21sw2019', name: 'Ombre Tank', image: '/assets/brand/rondorff/products/21sw2019.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21sw2019.jpg', description: 'Sleeveless muscle tank top with pink-to-orange ombre gradient, soft cotton, relaxed fit' },
            { id: '21tk189', name: 'Ribbed Tank', image: '/assets/brand/rondorff/products/21tk189.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21tk189.jpg', description: 'Beige/cream ribbed tank top, fine knit texture, classic athletic cut' },
            { id: '21ts1115dd', name: 'Ombre Tee', image: '/assets/brand/rondorff/products/21ts1115dd.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ts1115dd.jpg', description: 'Crew neck t-shirt with pink-to-orange ombre gradient, soft cotton, relaxed fit' },
            { id: '21ts1267', name: 'Sunset Tank', image: '/assets/brand/rondorff/products/21ts1267.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ts1267.jpg', description: 'Sleeveless muscle tee with pink-to-coral gradient and "SUNSET BOY" text graphic' },
            { id: '21ts1505', name: 'Camp Shirt', image: '/assets/brand/rondorff/products/21ts1505.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ts1505.jpg', description: 'Cream/beige knit button-up camp collar shirt, relaxed summer fit, breathable fabric' },
            { id: '21ur30', name: 'Brief White', image: '/assets/brand/rondorff/products/21ur30.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ur30.jpg', description: 'White low-rise European swim briefs, minimal coverage, athletic cut, sporty silhouette' },
            { id: '21ur42', name: 'Brief Black', image: '/assets/brand/rondorff/products/21ur42.jpg', thumb: '/assets/brand/rondorff/products/thumbs/21ur42.jpg', description: 'Black low-rise European swim briefs, minimal coverage, athletic cut, sporty silhouette' }
        ];


        // Global pose counter for cycling through poses (ensures variety)
        let poseCounter = 0;

        // Interaction levels - for both environment and duo interaction
        const LEVEL_LABELS = ['Low', 'Medium', 'High', 'Random'];

        // Environment interaction (how model interacts with surroundings)
        const ENV_INTERACTION = {
            low: 'standing upright, not touching or leaning on anything, minimal contact with environment',
            medium: 'casually interacting with environment - perhaps hand resting on a surface, slight lean, or feet in water',
            high: 'actively engaging with environment - sitting on rocks, leaning against wall, lying on sand, climbing, or immersed in water'
        };

        // Duo interaction (how models interact with each other)
        const DUO_INTERACTION = {
            low: 'standing near each other independently, each in their own space, minimal interaction, both looking at camera or different directions',
            medium: 'standing side by side as friends, relaxed body language, perhaps one glancing at the other, easy masculine camaraderie',
            high: 'close friendly interaction - arm around shoulder, playful push, walking arm in arm, genuine laughter together, natural friendly bond'
        };

        // Cinematic framings - explicit crop instructions
        const CINEMATIC_FRAMINGS = [
            'WIDE ENVIRONMENTAL SHOT - model appears SMALL in the vast landscape, taking up only 20% of the frame, emphasizing the dramatic location',
            'MEDIUM SHOT COMPOSITION - classic editorial framing from waist up, face and outfit clearly visible',
            'MODEL POSITIONED IN LOWER THIRD of frame with dramatic sky and environment filling upper 2/3',
            'THREE-QUARTER LENGTH - classic fashion photography framing showing full outfit',
            'OFF-CENTER COMPOSITION - model positioned on left or right third of frame, not centered'
        ];

        // Duo poses - two models interacting naturally
        const DUO_POSES = [
            'walking together along shoreline, easy conversation',
            'standing side by side, looking in same direction',
            'one seated, one standing nearby, layered composition',
            'both leaning against rocks, relaxed casual stance',
            'walking together, natural movement',
            'standing at different depths, one closer to camera',
            'both seated, relaxed, each in their own space'
        ];

        // Footwear options for full body shots (beach/summer appropriate)
        const FOOTWEAR = [
            'barefoot on the sand',
            'barefoot',
            'wearing minimal leather sandals',
            'wearing casual espadrilles',
            'wearing simple slides',
            'barefoot, feet visible in sand'
        ];

        // Preset environments
        const BEACH_IMAGES = [
            'Setset_Location_3_4_12_1769017618938 1.png',
            'Setset_Location_3_4_14_1769017366739 2.png',
            'Setset_Location_3_4_left_15_1769017370424 1.png',
            'Setset_Location_3_4_left_16_1769017374445 1.png',
            'Setset_Location_3_4_right_15_1769017623224 1.png',
            'Setset_Location_3_4_right_16_1769017625111 1.png',
            'Setset_Location_3_4_right_17_1769017371953 1.png',
            'Setset_Location_center_25_1769017385249 1.png',
            'Setset_Location_depth_10_1769017359213 1.png',
            'Setset_Location_depth_32_1769017396278 1.png',
            'Setset_Location_foreground_20_1768604125915 3.png',
            'Setset_Location_left_05_1769017353609 2.png',
            'Setset_Location_left_06_1769017355376 1.png',
            'Setset_Location_left_26_1768594347008 2.png',
            'Setset_Location_left_26_1769017645908 1.png',
            'Setset_Location_low_angle_19_1769017377305 1.png',
            'Setset_Location_right_08_1769017614142 1.png',
            'Setset_Location_right_30_1769017391812 1.png',
            'Setset_Location_wide_01_1768604080879 3.png',
            'Setset_Location_wide_01_1769017345542 1.png',
            'Setset_Location_wide_02_1768518346167 2.png',
            'Setset_Location_wide_02_1769017350673 1.png',
            'Setset_Location_wide_11_1769017363062 2.png',
            'Setset_Location_wide_21_1769017630522 1.png',
            'Setset_Location_wide_22_1769017632677 1.png'
        ];

        const ARCHITECTURE_IMAGES = [
            'Setset_Location_3_4_11_1769017979925 1.png',
            'Setset_Location_3_4_12_1769017981652 1.png',
            'Setset_Location_3_4_12_1769018653858 1.png',
            'Setset_Location_3_4_left_07_1768595721045 2.png',
            'Setset_Location_3_4_right_15_1769018656715 1.png',
            'Setset_Location_3_4_right_16_1769018201128 1.png',
            'Setset_Location_3_4_right_16_1769018660698 1.png',
            'Setset_Location_center_02_1768595713242 2.png',
            'Setset_Location_center_03_1769024890410 1.png',
            'Setset_Location_center_04_1769018176460 1.png',
            'Setset_Location_center_04_1769018641273 1.png',
            'Setset_Location_center_24_1769017999834 1.png',
            'Setset_Location_center_24_1769018193084 2.png',
            'Setset_Location_center_24_1769018669930 2.png',
            'Setset_Location_depth_09_1769018648389 1.png',
            'Setset_Location_depth_29_1769018186910 1.png',
            'Setset_Location_foreground_20_1769024877914 1.png',
            'Setset_Location_foreground_31_1769018183822 1.png',
            'Setset_Location_left_03_1768595944837 2.png',
            'Setset_Location_low_angle_17_1769017991175 1.png',
            'Setset_Location_low_angle_17_1769018658974 1.png',
            'Setset_Location_right_07_1769018645148 1.png',
            'Setset_Location_right_08_1768596493361 3.png',
            'Setset_Location_right_08_1769017976707 1.png',
            'Setset_Location_right_08_1769024901692 1.png',
            'Setset_Location_wide_01_1769017962075 3.png',
            'Setset_Location_wide_01_1769024913596 2.png',
            'Setset_Location_wide_11_1768594945886 2.png',
            'Setset_Location_wide_22_1769017996899 1.png'
        ];

        // ========== STATE ==========
        const state = {
            selectedModels: [],
            modelTab: 'rondorff', // 'rondorff' or 'setset'
            selectedProducts: {}, // { productId: groupNumber (1-4) }
            customProducts: [], // Array of { url, file, analysis, group }
            productTab: 'rondorff', // 'rondorff' or 'upload'
            environments: [], // Array of { url, file, analysis }
            selectedPresetEnvs: [], // Array of preset image filenames
            envTab: 'upload', // 'upload', 'beach', 'architecture'
            ratio: '16:9',
            seeds: 1,
            duoPercent: 50,
            interactionLevel: 1, // 0=Low, 1=Medium, 2=High, 3=Random
            dynamicLevel: 1, // 0=Low, 1=Medium, 2=High, 3=Random
            cinematicMode: false,
            describeEnvOnly: false, // Don't use env image, just describe it
            additionalPrompt: '',
            results: [],
            modelFalUrls: {},
            productFalUrls: {},
            customProductFalUrls: {},
            presetEnvFalUrls: {}
        };

        // ========== DOM ==========
        const elements = {
            modelTabs: document.getElementById('model-tabs'),
            modelGridRondorff: document.getElementById('model-grid-rondorff'),
            modelGridSetset: document.getElementById('model-grid-setset'),
            modelPanelRondorff: document.getElementById('model-panel-rondorff'),
            modelPanelSetset: document.getElementById('model-panel-setset'),
            productTabs: document.getElementById('product-tabs'),
            productGrid: document.getElementById('product-grid'),
            customProductGrid: document.getElementById('custom-product-grid'),
            productPanelRondorff: document.getElementById('product-panel-rondorff'),
            productPanelUpload: document.getElementById('product-panel-upload'),
            productFileInput: document.getElementById('product-file-input'),
            environmentGrid: document.getElementById('environment-grid'),
            envFileInput: document.getElementById('env-file-input'),
            envTabs: document.querySelectorAll('.env-tab'),
            envUploadPanel: document.getElementById('env-upload-panel'),
            envBeachPanel: document.getElementById('env-beach-panel'),
            envArchitecturePanel: document.getElementById('env-architecture-panel'),
            beachGrid: document.getElementById('beach-grid'),
            architectureGrid: document.getElementById('architecture-grid'),
            additionalPrompt: document.getElementById('additional-prompt'),
            ratioButtons: document.getElementById('ratio-buttons'),
            seedsButtons: document.getElementById('seeds-buttons'),
            duoSlider: document.getElementById('duo-slider'),
            duoValue: document.getElementById('duo-value'),
            interactionSlider: document.getElementById('interaction-slider'),
            interactionValue: document.getElementById('interaction-value'),
            dynamicSlider: document.getElementById('dynamic-slider'),
            dynamicValue: document.getElementById('dynamic-value'),
            cinematicToggle: document.getElementById('cinematic-toggle'),
            describeOnlyToggle: document.getElementById('describe-only-toggle'),
            selectionSummary: document.getElementById('selection-summary'),
            generateBtn: document.getElementById('generate-btn'),
            loader: document.getElementById('loader'),
            loaderMessage: document.getElementById('loader-message'),
            loaderProgress: document.getElementById('loader-progress'),
            progressSection: document.getElementById('progress-section'),
            progressTitle: document.getElementById('progress-title'),
            progressCount: document.getElementById('progress-count'),
            progressBar: document.getElementById('progress-bar'),
            resultsSection: document.getElementById('results-section'),
            resultsGrid: document.getElementById('results-grid')
        };

        // Focused env slot for paste
        let focusedEnvSlot = null;

        // Init lightbox
        const lightbox = new Lightbox({
            onDownload: (url, filename) => {
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
            }
        });

        // ========== RENDER ==========
        function renderModels() {
            // Render Ron Dorff models
            elements.modelGridRondorff.innerHTML = '';
            MODELS.forEach(model => {
                const card = document.createElement('div');
                card.className = 'model-card';
                card.dataset.id = model.id;
                card.dataset.source = 'rondorff';
                if (state.selectedModels.includes(model.id)) card.classList.add('selected');
                card.innerHTML = `
                    <img src="${model.thumb}" alt="${model.name}">
                    <div class="model-name">${model.name}</div>
                `;
                card.addEventListener('click', () => toggleModel(model.id, 'rondorff'));
                elements.modelGridRondorff.appendChild(card);
            });

            // Render Setset models
            elements.modelGridSetset.innerHTML = '';
            SETSET_MODELS.forEach(model => {
                const card = document.createElement('div');
                card.className = 'model-card';
                card.dataset.id = model.id;
                card.dataset.source = 'setset';
                if (state.selectedModels.includes(model.id)) card.classList.add('selected');
                card.innerHTML = `
                    <img src="${model.thumb}" alt="${model.name}">
                    <div class="model-name">${model.name.split(' ')[0]}</div>
                `;
                card.addEventListener('click', () => toggleModel(model.id, 'setset'));
                elements.modelGridSetset.appendChild(card);
            });
        }

        function renderProducts() {
            elements.productGrid.innerHTML = '';
            PRODUCTS.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.id = product.id;
                const group = state.selectedProducts[product.id] || 0;
                if (group > 0) card.classList.add('has-group');

                card.innerHTML = `
                    <div class="product-name">${product.name}</div>
                    <img class="product-image" src="${product.thumb}" alt="${product.name}">
                    <div class="group-buttons">
                        <button class="group-btn g1 ${group === 1 ? 'active' : ''}" data-group="1">1</button>
                        <button class="group-btn g2 ${group === 2 ? 'active' : ''}" data-group="2">2</button>
                        <button class="group-btn g3 ${group === 3 ? 'active' : ''}" data-group="3">3</button>
                        <button class="group-btn g4 ${group === 4 ? 'active' : ''}" data-group="4">4</button>
                    </div>
                `;

                // Group button clicks
                card.querySelectorAll('.group-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const groupNum = parseInt(btn.dataset.group);
                        setProductGroup(product.id, groupNum);
                    });
                });

                elements.productGrid.appendChild(card);
            });
        }

        // Track focused custom product slot for paste
        let focusedCustomProductSlot = null;

        function renderCustomProducts() {
            elements.customProductGrid.innerHTML = '';
            for (let i = 0; i < 7; i++) {
                const slot = document.createElement('div');
                slot.className = 'custom-product-slot';
                slot.dataset.index = i;
                slot.tabIndex = 0; // Make focusable for paste

                const customProduct = state.customProducts[i];
                if (customProduct) {
                    slot.classList.add('filled');
                    if (customProduct.group > 0) slot.classList.add('has-group');

                    const group = customProduct.group || 0;
                    slot.innerHTML = `
                        <img src="${customProduct.url}" alt="Product">
                        <button class="remove-btn">&times;</button>
                        <div class="group-buttons">
                            <button class="group-btn g1 ${group === 1 ? 'active' : ''}" data-group="1">1</button>
                            <button class="group-btn g2 ${group === 2 ? 'active' : ''}" data-group="2">2</button>
                            <button class="group-btn g3 ${group === 3 ? 'active' : ''}" data-group="3">3</button>
                            <button class="group-btn g4 ${group === 4 ? 'active' : ''}" data-group="4">4</button>
                        </div>
                    `;

                    // Remove button handler
                    slot.querySelector('.remove-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeCustomProduct(i);
                    });

                    // Group button handlers
                    slot.querySelectorAll('.group-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const groupNum = parseInt(btn.dataset.group);
                            setCustomProductGroup(i, groupNum);
                        });
                    });
                } else {
                    slot.innerHTML = `
                        <div class="placeholder">
                            <div>+ Click & paste</div>
                            <div class="placeholder-hint">or drag & drop</div>
                        </div>
                    `;
                }

                // Focus handling for paste
                slot.addEventListener('focus', () => {
                    focusedCustomProductSlot = i;
                    slot.classList.add('paste-ready');
                });
                slot.addEventListener('blur', () => {
                    slot.classList.remove('paste-ready');
                });

                slot.addEventListener('click', () => {
                    if (!state.customProducts[i]) {
                        slot.focus();
                    }
                });

                // Drag & drop
                slot.addEventListener('dragover', (e) => { e.preventDefault(); slot.style.borderColor = 'var(--jet)'; });
                slot.addEventListener('dragleave', () => { slot.style.borderColor = ''; });
                slot.addEventListener('drop', (e) => handleCustomProductDrop(e, i));

                elements.customProductGrid.appendChild(slot);
            }
        }

        function handleCustomProductDrop(e, index) {
            e.preventDefault();
            e.target.closest('.custom-product-slot').style.borderColor = '';
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if (files.length > 0) {
                processCustomProductFile(files[0], index);
            }
        }

        function processCustomProductFile(file, index) {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.customProducts[index] = {
                    url: e.target.result,
                    file: file,
                    analysis: null,
                    group: 0,
                    falUrl: null
                };
                renderCustomProducts();
                updateSummary();
            };
            reader.readAsDataURL(file);
        }

        function removeCustomProduct(index) {
            state.customProducts.splice(index, 1);
            renderCustomProducts();
            updateSummary();
        }

        function setCustomProductGroup(index, groupNum) {
            const current = state.customProducts[index].group || 0;
            if (current === groupNum) {
                state.customProducts[index].group = 0; // Toggle off
            } else {
                state.customProducts[index].group = groupNum;
            }
            renderCustomProducts();
            updateSummary();
        }

        function renderEnvironments() {
            elements.environmentGrid.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const slot = document.createElement('div');
                slot.className = 'env-slot';
                slot.dataset.index = i;
                slot.tabIndex = 0; // Make focusable for paste

                if (state.environments[i]) {
                    slot.classList.add('filled');
                    slot.innerHTML = `
                        <img src="${state.environments[i].url}" alt="Environment">
                        <button class="remove-btn" onclick="removeEnvironment(${i}); event.stopPropagation();">&times;</button>
                    `;
                } else {
                    slot.innerHTML = `
                        <div class="placeholder">
                            <div>+ Click & paste</div>
                            <div class="placeholder-hint">or drag & drop</div>
                        </div>
                    `;
                }

                // Focus handling for paste
                slot.addEventListener('focus', () => {
                    focusedEnvSlot = i;
                    slot.classList.add('paste-ready');
                });
                slot.addEventListener('blur', () => {
                    slot.classList.remove('paste-ready');
                });

                slot.addEventListener('click', () => {
                    if (!state.environments[i]) {
                        slot.focus();
                    }
                });

                // Drag & drop
                slot.addEventListener('dragover', (e) => { e.preventDefault(); slot.style.borderColor = 'var(--jet)'; });
                slot.addEventListener('dragleave', () => { slot.style.borderColor = ''; });
                slot.addEventListener('drop', (e) => handleEnvDrop(e, i));

                elements.environmentGrid.appendChild(slot);
            }
        }

        function renderPresetEnvironments() {
            // Beach grid
            elements.beachGrid.innerHTML = '';
            BEACH_IMAGES.forEach(filename => {
                const item = document.createElement('div');
                item.className = 'preset-env-item';
                item.dataset.filename = filename;
                if (state.selectedPresetEnvs.includes(filename)) {
                    item.classList.add('selected');
                }
                item.innerHTML = `<img src="/assets/brand/rondorff/environments/beach/${encodeURIComponent(filename)}" alt="Beach">`;
                item.addEventListener('click', () => togglePresetEnv(filename));
                elements.beachGrid.appendChild(item);
            });

            // Architecture grid
            elements.architectureGrid.innerHTML = '';
            ARCHITECTURE_IMAGES.forEach(filename => {
                const item = document.createElement('div');
                item.className = 'preset-env-item';
                item.dataset.filename = filename;
                if (state.selectedPresetEnvs.includes(filename)) {
                    item.classList.add('selected');
                }
                item.innerHTML = `<img src="/assets/brand/rondorff/environments/architecture/${encodeURIComponent(filename)}" alt="Architecture">`;
                item.addEventListener('click', () => togglePresetEnv(filename));
                elements.architectureGrid.appendChild(item);
            });
        }

        function togglePresetEnv(filename) {
            const idx = state.selectedPresetEnvs.indexOf(filename);
            if (idx >= 0) {
                state.selectedPresetEnvs.splice(idx, 1);
            } else {
                state.selectedPresetEnvs.push(filename);
            }
            renderPresetEnvironments();
            updatePresetCounts();
            updateSummary();
        }

        function updatePresetCounts() {
            const beachSelected = state.selectedPresetEnvs.filter(f => BEACH_IMAGES.includes(f)).length;
            const archSelected = state.selectedPresetEnvs.filter(f => ARCHITECTURE_IMAGES.includes(f)).length;
            document.getElementById('beach-count').textContent = `${beachSelected} selected`;
            document.getElementById('architecture-count').textContent = `${archSelected} selected`;
        }

        function deselectBeach() {
            state.selectedPresetEnvs = state.selectedPresetEnvs.filter(f => !BEACH_IMAGES.includes(f));
            renderPresetEnvironments();
            updatePresetCounts();
            updateSummary();
        }

        function deselectArchitecture() {
            state.selectedPresetEnvs = state.selectedPresetEnvs.filter(f => !ARCHITECTURE_IMAGES.includes(f));
            renderPresetEnvironments();
            updatePresetCounts();
            updateSummary();
        }

        document.getElementById('deselect-beach').addEventListener('click', deselectBeach);
        document.getElementById('deselect-architecture').addEventListener('click', deselectArchitecture);

        function switchEnvTab(tab) {
            state.envTab = tab;
            elements.envTabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            elements.envUploadPanel.style.display = tab === 'upload' ? 'block' : 'none';
            elements.envBeachPanel.style.display = tab === 'beach' ? 'block' : 'none';
            elements.envArchitecturePanel.style.display = tab === 'architecture' ? 'block' : 'none';
        }

        // Tab click handlers
        document.querySelectorAll('.env-tab').forEach(tab => {
            tab.addEventListener('click', () => switchEnvTab(tab.dataset.tab));
        });

        // ========== HANDLERS ==========
        function toggleModel(id, source) {
            const idx = state.selectedModels.indexOf(id);
            if (idx >= 0) {
                state.selectedModels.splice(idx, 1);
            } else {
                state.selectedModels.push(id);
            }
            updateModelUI();
            updateSummary();
        }

        // Get model object by id (from either MODELS or SETSET_MODELS)
        function getModelById(id) {
            return MODELS.find(m => m.id === id) || SETSET_MODELS.find(m => m.id === id);
        }

        function setProductGroup(productId, groupNum) {
            const current = state.selectedProducts[productId] || 0;
            if (current === groupNum) {
                // Toggle off
                delete state.selectedProducts[productId];
            } else {
                state.selectedProducts[productId] = groupNum;
            }
            renderProducts();
            updateSummary();
        }

        function updateModelUI() {
            // Update both grids
            document.querySelectorAll('.model-card').forEach(card => {
                card.classList.toggle('selected', state.selectedModels.includes(card.dataset.id));
            });
        }

        // Model tab switching
        function switchModelTab(tab) {
            state.modelTab = tab;
            elements.modelTabs.querySelectorAll('.section-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            elements.modelPanelRondorff.classList.toggle('active', tab === 'rondorff');
            elements.modelPanelSetset.classList.toggle('active', tab === 'setset');
        }

        // Product tab switching
        function switchProductTab(tab) {
            state.productTab = tab;
            elements.productTabs.querySelectorAll('.section-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            elements.productPanelRondorff.classList.toggle('active', tab === 'rondorff');
            elements.productPanelUpload.classList.toggle('active', tab === 'upload');
        }

        function handleEnvDrop(e, index) {
            e.preventDefault();
            e.target.closest('.env-slot').style.borderColor = '';
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if (files.length > 0) {
                processEnvFile(files[0], index);
            }
        }

        // Clipboard paste handler
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;

            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        // Check if we're pasting into custom products
                        if (focusedCustomProductSlot !== null && state.productTab === 'upload') {
                            let slotIndex = focusedCustomProductSlot;
                            if (state.customProducts[slotIndex]) {
                                slotIndex = state.customProducts.findIndex((p, i) => !p);
                                if (slotIndex === -1) slotIndex = state.customProducts.length;
                            }
                            if (slotIndex < 7) {
                                processCustomProductFile(file, slotIndex);
                            }
                            return;
                        }

                        // Otherwise paste into environment
                        let slotIndex = focusedEnvSlot;
                        if (slotIndex === null || state.environments[slotIndex]) {
                            slotIndex = state.environments.findIndex((e, i) => !e);
                            if (slotIndex === -1) slotIndex = 0;
                        }
                        processEnvFile(file, slotIndex);
                    }
                    return;
                }
            }
        });

        elements.envFileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            let slotIndex = focusedEnvSlot || 0;
            files.forEach((file, idx) => {
                if (slotIndex + idx < 5) {
                    processEnvFile(file, slotIndex + idx);
                }
            });
            e.target.value = '';
        });

        async function processEnvFile(file, index) {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.environments[index] = {
                    url: e.target.result,
                    file: file,
                    analysis: null
                };
                renderEnvironments();
                updateSummary();
            };
            reader.readAsDataURL(file);
        }

        window.removeEnvironment = function(index) {
            state.environments.splice(index, 1);
            renderEnvironments();
            updateSummary();
        };

        // Settings handlers
        elements.ratioButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                elements.ratioButtons.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                state.ratio = e.target.dataset.value;
            }
        });

        elements.seedsButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                elements.seedsButtons.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                state.seeds = parseInt(e.target.dataset.value);
                updateSummary();
            }
        });

        elements.duoSlider.addEventListener('input', (e) => {
            state.duoPercent = parseInt(e.target.value);
            elements.duoValue.textContent = `${state.duoPercent}%`;
        });

        elements.interactionSlider.addEventListener('input', (e) => {
            state.interactionLevel = parseInt(e.target.value);
            elements.interactionValue.textContent = LEVEL_LABELS[state.interactionLevel];
        });

        elements.dynamicSlider.addEventListener('input', (e) => {
            state.dynamicLevel = parseInt(e.target.value);
            elements.dynamicValue.textContent = LEVEL_LABELS[state.dynamicLevel];
        });


        elements.cinematicToggle.addEventListener('click', () => {
            state.cinematicMode = !state.cinematicMode;
            elements.cinematicToggle.classList.toggle('active', state.cinematicMode);
        });

        elements.describeOnlyToggle.addEventListener('click', () => {
            state.describeEnvOnly = !state.describeEnvOnly;
            elements.describeOnlyToggle.classList.toggle('active', state.describeEnvOnly);
        });

        function updateSummary() {
            const modelCount = state.selectedModels.length;

            // Count groups from both preset products and custom products
            const presetGroups = new Set(Object.values(state.selectedProducts));
            const customGroups = new Set(state.customProducts.filter(p => p && p.group > 0).map(p => p.group));
            const allGroups = new Set([...presetGroups, ...customGroups]);
            const groupCount = allGroups.size;

            const uploadedEnvCount = state.environments.filter(e => e).length;
            const presetEnvCount = state.selectedPresetEnvs.length;
            const envCount = uploadedEnvCount + presetEnvCount;
            const totalImages = envCount * state.seeds;

            elements.selectionSummary.textContent = `${modelCount} model${modelCount !== 1 ? 's' : ''}, ${groupCount} group${groupCount !== 1 ? 's' : ''}, ${envCount} env${envCount !== 1 ? 's' : ''} = ${totalImages} image${totalImages !== 1 ? 's' : ''}`;
            elements.generateBtn.disabled = modelCount === 0 || groupCount === 0 || envCount === 0;
        }

        // Additional prompt handler
        elements.additionalPrompt.addEventListener('input', (e) => {
            state.additionalPrompt = e.target.value;
        });

        // ========== GENERATION ==========
        elements.generateBtn.addEventListener('click', generate);

        async function generate() {
            if (state.selectedModels.length === 0) return;
            const uploadedEnvs = state.environments.filter(e => e);
            const hasEnvs = uploadedEnvs.length > 0 || state.selectedPresetEnvs.length > 0;
            if (!hasEnvs) return;

            // Reset pose counter for new generation
            poseCounter = 0;

            // Build combined environments list
            const allEnvs = [];

            // Add uploaded environments
            uploadedEnvs.forEach((env, i) => {
                allEnvs.push({
                    type: 'uploaded',
                    url: env.url,
                    file: env.file,
                    falUrl: env.falUrl,
                    analysis: env.analysis
                });
            });

            // Add preset environments
            state.selectedPresetEnvs.forEach(filename => {
                const isBeach = BEACH_IMAGES.includes(filename);
                const folder = isBeach ? 'beach' : 'architecture';
                allEnvs.push({
                    type: 'preset',
                    filename: filename,
                    folder: folder,
                    path: `/assets/brand/rondorff/environments/${folder}/${encodeURIComponent(filename)}`,
                    falUrl: state.presetEnvFalUrls[filename] || null,
                    analysis: null
                });
            });

            console.log('');
            console.log('╔════════════════════════════════════════╗');
            console.log('║     RON DORFF - FEARLESS SUMMER        ║');
            console.log('╚════════════════════════════════════════╝');
            console.log(`⚙️ Settings: Seeds=${state.seeds}, Duo=${state.duoPercent}%, Interaction=${state.interactionLevel}%, Cinematic=${state.cinematicMode}`);
            console.log(`👤 Models: ${state.selectedModels.join(', ')}`);
            console.log(`👕 Products: ${Object.keys(state.selectedProducts).length} items in ${new Set(Object.values(state.selectedProducts)).size} groups`);
            console.log(`📍 Environments: ${allEnvs.length} (${uploadedEnvs.length} uploaded, ${state.selectedPresetEnvs.length} preset)`);
            console.log(`🎭 Poses: smart selection based on environment`);
            if (state.additionalPrompt) console.log(`✨ Additional styling: ${state.additionalPrompt}`);
            console.log('');

            // Show loader
            elements.loader.classList.add('active');
            elements.loaderMessage.textContent = 'Preparing assets...';
            elements.loaderProgress.textContent = 'Uploading model references...';

            // Upload models (parallel) - now supports both MODELS and SETSET_MODELS
            console.log('👤 Uploading model references...');
            await Promise.all(state.selectedModels.map(async (modelId) => {
                if (!state.modelFalUrls[modelId]) {
                    const model = getModelById(modelId);
                    if (!model) {
                        console.error(`Model ${modelId} not found`);
                        return;
                    }
                    const response = await fetch(model.image);
                    const blob = await response.blob();
                    const file = new File([blob], `${modelId}.jpg`, { type: 'image/jpeg' });
                    const formData = new FormData();
                    formData.append('image', file);
                    const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                    const uploadData = await uploadRes.json();
                    state.modelFalUrls[modelId] = uploadData.url;
                    console.log(`📤 [${model.name}] Uploaded:`, uploadData.url);
                } else {
                    console.log(`✓ [${modelId}] Already uploaded`);
                }
            }));

            // Upload preset products (parallel)
            console.log('👕 Uploading product images...');
            elements.loaderProgress.textContent = 'Uploading product images...';
            const selectedProductIds = Object.keys(state.selectedProducts);
            await Promise.all(selectedProductIds.map(async (productId) => {
                if (!state.productFalUrls[productId]) {
                    const product = PRODUCTS.find(p => p.id === productId);
                    const response = await fetch(product.image);
                    const blob = await response.blob();
                    const file = new File([blob], `${productId}.jpg`, { type: 'image/jpeg' });
                    const formData = new FormData();
                    formData.append('image', file);
                    const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                    const uploadData = await uploadRes.json();
                    state.productFalUrls[productId] = uploadData.url;
                    console.log(`📤 [${product.name}] Uploaded:`, uploadData.url);
                } else {
                    console.log(`✓ [${productId}] Already uploaded`);
                }
            }));

            // Upload custom products (parallel)
            const customProductsWithGroups = state.customProducts.filter(p => p && p.group > 0);
            if (customProductsWithGroups.length > 0) {
                console.log('👕 Uploading custom products...');
                elements.loaderProgress.textContent = 'Uploading custom products...';
                await Promise.all(customProductsWithGroups.map(async (customProduct, i) => {
                    if (!customProduct.falUrl) {
                        const formData = new FormData();
                        formData.append('image', customProduct.file);
                        const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                        const uploadData = await uploadRes.json();
                        customProduct.falUrl = uploadData.url;
                        console.log(`📤 [Custom Product ${i + 1}] Uploaded:`, uploadData.url);
                    }
                }));
            }

            // Upload environments (parallel)
            console.log('📍 Uploading environments...');
            elements.loaderProgress.textContent = 'Uploading environments...';
            await Promise.all(allEnvs.map(async (env, i) => {
                if (!env.falUrl) {
                    if (env.type === 'uploaded') {
                        const formData = new FormData();
                        formData.append('image', env.file);
                        const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                        const uploadData = await uploadRes.json();
                        env.falUrl = uploadData.url;
                        // Also update the original uploaded env
                        const originalIdx = uploadedEnvs.findIndex(e => e.file === env.file);
                        if (originalIdx >= 0) uploadedEnvs[originalIdx].falUrl = uploadData.url;
                    } else {
                        // Preset environment - fetch and upload
                        const response = await fetch(env.path);
                        const blob = await response.blob();
                        const file = new File([blob], env.filename, { type: 'image/png' });
                        const formData = new FormData();
                        formData.append('image', file);
                        const uploadRes = await fetch('/api/upload', { method: 'POST', body: formData });
                        const uploadData = await uploadRes.json();
                        env.falUrl = uploadData.url;
                        state.presetEnvFalUrls[env.filename] = uploadData.url;
                    }
                    console.log(`📤 [Env ${i + 1}] Uploaded:`, env.falUrl);
                }
            }));

            // Analyze environments (parallel)
            console.log('🔍 Analyzing environments...');
            elements.loaderProgress.textContent = 'Analyzing environments...';
            await Promise.all(allEnvs.map(async (env, i) => {
                if (!env.analysis) {
                    env.analysis = await analyzeEnvironment(env.falUrl, i);
                }
            }));
            console.log('✅ All environments analyzed');

            // Build tasks
            elements.loader.classList.remove('active');
            elements.progressSection.style.display = 'block';
            elements.resultsSection.style.display = 'block';

            // Get product groups (from both preset and custom products)
            const groups = {};

            // Add preset products to groups
            for (const [productId, groupNum] of Object.entries(state.selectedProducts)) {
                if (!groups[groupNum]) groups[groupNum] = [];
                groups[groupNum].push({ type: 'preset', id: productId });
            }

            // Add custom products to groups
            state.customProducts.forEach((customProduct, idx) => {
                if (customProduct && customProduct.group > 0) {
                    const groupNum = customProduct.group;
                    if (!groups[groupNum]) groups[groupNum] = [];
                    groups[groupNum].push({ type: 'custom', index: idx, product: customProduct });
                }
            });

            const groupNumbers = Object.keys(groups).map(Number).sort();

            // Build tasks: one per environment × seeds
            const tasks = [];
            allEnvs.forEach((env, envIdx) => {
                for (let seed = 0; seed < state.seeds; seed++) {
                    // Determine if this is a duo shot based on duoPercent
                    const isDuo = state.selectedModels.length >= 2 && Math.random() * 100 < state.duoPercent;

                    // Assign groups to this image
                    let assignedGroups;
                    if (isDuo && groupNumbers.length >= 2) {
                        // Pick 2 random different groups for duo
                        const shuffled = [...groupNumbers].sort(() => Math.random() - 0.5);
                        assignedGroups = [shuffled[0], shuffled[1]];
                    } else {
                        // Pick random group for solo
                        assignedGroups = [groupNumbers[Math.floor(Math.random() * groupNumbers.length)]];
                    }

                    tasks.push({
                        env,
                        envIdx,
                        seed,
                        isDuo,
                        assignedGroups,
                        groups
                    });
                }
            });

            // Log task summary
            const duoCount = tasks.filter(t => t.isDuo).length;
            const soloCount = tasks.length - duoCount;
            console.log('═══════════════════════════════════════');
            console.log(`🚀 Starting generation: ${tasks.length} images`);
            console.log(`   Solo: ${soloCount} | Duo: ${duoCount}`);
            console.log(`   Groups: ${groupNumbers.join(', ')}`);
            console.log(`   Environments: ${allEnvs.length}`);
            console.log(`   Seeds: ${state.seeds}`);
            console.log('═══════════════════════════════════════');

            elements.progressTitle.textContent = 'Generating...';
            elements.progressCount.textContent = `0 / ${tasks.length}`;
            elements.progressBar.style.width = '0%';

            let completed = 0;

            // Process in batches
            const BATCH_SIZE = 3;
            for (let i = 0; i < tasks.length; i += BATCH_SIZE) {
                const batch = tasks.slice(i, i + BATCH_SIZE);

                await Promise.all(batch.map(async (task) => {
                    const taskId = `Env${task.envIdx + 1}-Seed${task.seed + 1}`;
                    try {
                        console.log(`🎨 [${taskId}] Building prompt...`);
                        const prompt = buildPrompt(task);
                        const imageUrls = buildImageUrls(task);

                        console.log(`📝 [${taskId}] ${task.isDuo ? 'DUO' : 'SOLO'} shot`);
                        console.log(`   Groups: ${task.assignedGroups.join(', ')}`);
                        console.log(`   Images: ${imageUrls.length} references`);
                        console.log(`   Prompt: ${prompt.substring(0, 150)}...`);

                        const response = await fetch('/api/remix-gemini', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: 'gemini-3-pro',
                                prompt: prompt,
                                image_urls: imageUrls,
                                aspect_ratio: state.ratio,
                                resolution: '2K'
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.images && data.images.length > 0) {
                                console.log(`✅ [${taskId}] Generated ${data.images.length} image(s)`);
                                data.images.forEach(img => {
                                    addResult({
                                        url: img.url,
                                        prompt: prompt,
                                        envIdx: task.envIdx,
                                        isDuo: task.isDuo
                                    });
                                });
                            } else {
                                console.error(`❌ [${taskId}] No images in response:`, data);
                            }
                        } else {
                            const errorText = await response.text();
                            console.error(`❌ [${taskId}] Generation failed (${response.status}):`, errorText);
                        }
                    } catch (err) {
                        console.error(`❌ [${taskId}] Generation error:`, err);
                    }

                    completed++;
                    elements.progressCount.textContent = `${completed} / ${tasks.length}`;
                    elements.progressBar.style.width = `${(completed / tasks.length) * 100}%`;
                }));
            }

            elements.progressTitle.textContent = 'Complete!';
            elements.generateBtn.disabled = false;
        }

        // Enhance user's styling notes into richer prompt language
        function enhanceStylingNotes(input) {
            const lower = input.toLowerCase();
            let enhanced = '';

            // Detect and expand common styling keywords
            if (lower.includes('90s') || lower.includes('nineties') || lower.includes('vintage')) {
                enhanced += 'Captured with the aesthetic of 90s fashion photography, film grain texture, slightly desaturated warm tones, nostalgic analog feel. ';
            }
            if (lower.includes('flash') || lower.includes('strobe')) {
                enhanced += 'Direct flash photography creating harsh shadows, blown-out highlights, raw and immediate feel like paparazzi or snapshot aesthetic. ';
            }
            if (lower.includes('glow') || lower.includes('glowy') || lower.includes('dreamy')) {
                enhanced += 'Soft glowing skin with ethereal light diffusion, dreamy haze, gentle highlights wrapping around the subject. ';
            }
            if (lower.includes('film') || lower.includes('analog') || lower.includes('grain')) {
                enhanced += 'Shot on film with natural grain, organic color rendering, subtle imperfections that add character and warmth. ';
            }
            if (lower.includes('golden') || lower.includes('sunset') || lower.includes('magic hour')) {
                enhanced += 'Bathed in golden hour light, warm amber tones, long shadows, sun flares catching the lens. ';
            }
            if (lower.includes('moody') || lower.includes('dark') || lower.includes('shadow')) {
                enhanced += 'Moody atmospheric lighting with deep shadows, dramatic contrast, mysterious and contemplative mood. ';
            }
            if (lower.includes('bright') || lower.includes('airy') || lower.includes('light')) {
                enhanced += 'Bright airy lighting, open shadows, fresh and clean aesthetic with luminous quality. ';
            }
            if (lower.includes('raw') || lower.includes('gritty') || lower.includes('real')) {
                enhanced += 'Raw unpolished aesthetic, authentic and gritty, imperfect and real, documentary-style honesty. ';
            }
            if (lower.includes('soft') || lower.includes('diffused')) {
                enhanced += 'Soft diffused lighting, gentle gradients, no harsh shadows, flattering and smooth. ';
            }
            if (lower.includes('contras') || lower.includes('punchy')) {
                enhanced += 'High contrast with punchy blacks and bright highlights, bold and graphic quality. ';
            }
            if (lower.includes('desaturate') || lower.includes('muted') || lower.includes('faded')) {
                enhanced += 'Desaturated muted color palette, faded tones, understated and sophisticated. ';
            }
            if (lower.includes('saturate') || lower.includes('vivid') || lower.includes('vibrant')) {
                enhanced += 'Rich saturated colors, vivid and vibrant, bold color presence. ';
            }
            if (lower.includes('backlit') || lower.includes('silhouette') || lower.includes('rim light')) {
                enhanced += 'Backlit with rim lighting around the subject, sun behind creating halo effect, dramatic silhouette edges. ';
            }
            if (lower.includes('natural') || lower.includes('available light')) {
                enhanced += 'Natural available light only, authentic to the environment, no artificial lighting feel. ';
            }
            if (lower.includes('polaroid') || lower.includes('instant')) {
                enhanced += 'Polaroid instant film aesthetic, slightly washed out, soft focus edges, nostalgic snapshot quality. ';
            }
            if (lower.includes('editorial') || lower.includes('magazine') || lower.includes('vogue')) {
                enhanced += 'High fashion editorial quality, magazine-ready, polished yet with artistic edge. ';
            }

            // If no keywords matched, use the input directly but frame it nicely
            if (!enhanced) {
                enhanced = `The image should evoke: ${input}. `;
            }

            console.log(`   ✨ Enhanced styling: "${input}" → "${enhanced.substring(0, 80)}..."`);
            return enhanced;
        }

        // Helper to get level value (handles random)
        function getEffectiveLevel(level) {
            if (level === 3) { // Random
                return Math.floor(Math.random() * 3); // 0, 1, or 2
            }
            return level;
        }

        function getLevelKey(level) {
            const keys = ['low', 'medium', 'high'];
            return keys[level];
        }

        async function analyzeEnvironment(imageUrl, envIndex) {
            console.log(`🔍 [Env ${envIndex + 1}] Starting analysis...`);

            // Get effective levels (resolve random to actual value)
            const effectiveDynamic = getEffectiveLevel(state.dynamicLevel);
            const effectiveInteraction = getEffectiveLevel(state.interactionLevel);

            // Dynamic level affects pose energy
            const dynamicDescs = [
                'subtle and minimal - standing upright, simple weight shift, relaxed stance',
                'relaxed editorial - casual stance, natural body language, slight movement',
                'expressive and dynamic - strong poses, dramatic angles, active movement'
            ];
            const dynamicDesc = dynamicDescs[effectiveDynamic];

            // Interaction level affects environment engagement
            const interactionDesc = ENV_INTERACTION[getLevelKey(effectiveInteraction)];

            const basePrompt = `Analyze this image for a men's fashion photoshoot.

1. LOCATION (2 sentences): Describe the setting, lighting, and atmosphere.

2. POSE SUGGESTION: Suggest ONE specific pose that works naturally with this environment.
   - Energy level: ${dynamicDesc}
   - Environment interaction: ${interactionDesc}
   Be specific about body position, what the model is doing, and how they engage with the surroundings.

Format your response as:
LOCATION: [description]
POSE: [specific pose suggestion]`;

            try {
                const response = await fetch('/api/analyze-gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_url: imageUrl, prompt: basePrompt })
                });

                if (response.ok) {
                    const data = await response.json();
                    const result = data.content || 'LOCATION: a scenic outdoor location\nPOSE: standing naturally';
                    console.log(`✅ [Env ${envIndex + 1}] Analysis complete:`);
                    console.log(result);
                    return result;
                } else {
                    console.error(`❌ [Env ${envIndex + 1}] Analysis failed:`, response.status);
                }
            } catch (err) {
                console.error(`❌ [Env ${envIndex + 1}] Analysis error:`, err);
            }
            return 'LOCATION: a scenic outdoor location\nPOSE: standing naturally';
        }

        function buildPrompt(task) {
            const { env, assignedGroups, groups, isDuo } = task;

            // Parse location and pose from environment analysis
            let location = 'scenic outdoor location with warm golden light';
            let suggestedPose = 'standing naturally with relaxed confident stance';

            if (env.analysis) {
                const locationMatch = env.analysis.match(/LOCATION:\s*(.+?)(?=POSE:|$)/si);
                const poseMatch = env.analysis.match(/POSE:\s*(.+?)$/si);

                if (locationMatch) location = locationMatch[1].trim();
                if (poseMatch) suggestedPose = poseMatch[1].trim();

                // Fallback cleanup if no structured format
                if (!locationMatch && !poseMatch) {
                    location = env.analysis.replace(/ACTIONS:.*$/s, '').trim();
                }
            }

            // Get models (now supports both MODELS and SETSET_MODELS)
            const modelDescs = state.selectedModels.map(id => {
                const model = getModelById(id);
                return model ? model.description : 'a fashion model';
            });

            // Get outfits for each person - with emphasis on exact match
            const outfits = [];
            assignedGroups.forEach((groupNum) => {
                const productItems = groups[groupNum];
                const items = productItems.map(item => {
                    if (item.type === 'preset') {
                        const product = PRODUCTS.find(p => p.id === item.id);
                        return product ? product.description : 'fashion item';
                    } else {
                        // Custom product - use generic description
                        return 'the clothing item shown in the reference image';
                    }
                });
                // Join items and add emphasis for exact matching
                const outfitDescription = items.join(' AND ');
                outfits.push(outfitDescription);
            });

            // Get effective interaction level for this shot
            const effectiveInteraction = getEffectiveLevel(state.interactionLevel);
            const interactionKey = getLevelKey(effectiveInteraction);

            // Use suggested pose from environment analysis (or build duo pose)
            let pose;
            if (isDuo) {
                // For duos: combine environment interaction with duo interaction
                const duoInteraction = DUO_INTERACTION[interactionKey];
                const basePose = DUO_POSES[poseCounter % DUO_POSES.length];
                pose = `${basePose}, ${duoInteraction}`;
            } else {
                pose = suggestedPose;
            }
            poseCounter++;

            // Get framing for cinematic mode
            const framing = state.cinematicMode
                ? CINEMATIC_FRAMINGS[poseCounter % CINEMATIC_FRAMINGS.length]
                : 'full body shot';

            // Footwear
            const footwear = FOOTWEAR[Math.floor(Math.random() * FOOTWEAR.length)];

            console.log(`   🎭 Pose: ${pose}`);
            console.log(`   📐 Framing: ${framing}`);
            console.log(`   🤝 Interaction: ${interactionKey}`);

            // Build clean, simple prompt - CLOTHING FIRST for emphasis
            let parts = [];

            // CLOTHING INSTRUCTION FIRST - most important
            const numModels = state.selectedModels.length;
            const clothingImageStart = numModels + 1; // Product images come after model images
            if (isDuo) {
                parts.push(`MANDATORY CLOTHING - The models MUST wear EXACTLY these items from the reference images:`);
                parts.push(`First model wears (see reference image ${clothingImageStart}): ${outfits[0]}`);
                parts.push(`Second model wears (see reference image ${clothingImageStart + 1}): ${outfits[1] || outfits[0]}`);
            } else {
                parts.push(`MANDATORY CLOTHING - The model MUST wear EXACTLY this outfit shown in reference image ${clothingImageStart}: ${outfits[0]}`);
            }

            // Style prefix
            if (state.cinematicMode) {
                parts.push('CINEMATIC FILM GRAIN ANALOG PHOTOGRAPHY - shot on 35mm film with visible grain, warm color cast, soft focus edges, nostalgic 90s aesthetic');
            }
            parts.push('High-end fashion editorial photograph');

            // Framing
            parts.push(framing);

            // Subject and pose
            if (isDuo) {
                parts.push(`Two male models, ${pose}`);
                parts.push(`First model: ${modelDescs[0]}`);
                if (modelDescs.length >= 2) {
                    parts.push(`Second model: ${modelDescs[1]}`);
                }
            } else {
                const modelDesc = modelDescs[Math.floor(Math.random() * modelDescs.length)];
                parts.push(`Male model ${pose}`);
                parts.push(`Model: ${modelDesc}`);
            }

            // Footwear
            parts.push(footwear);

            // Location
            parts.push(`Location: ${location}`);

            // Additional styling from user
            if (state.additionalPrompt && state.additionalPrompt.trim()) {
                const enhanced = enhanceStylingNotes(state.additionalPrompt.trim());
                parts.push(enhanced);
            }

            // Color palette for cinematic
            if (state.cinematicMode) {
                parts.push('Color palette: warm coral, sand, mauve tones');
            }

            // Quality suffix
            parts.push('Professional fashion photography, warm golden tones, sun-kissed skin, vivid full color (never black and white), Ron Dorff Fearless Summer aesthetic');
            parts.push('IMPORTANT: Single cohesive photograph, not a collage. Clothes must be worn NORMALLY - shirts pulled DOWN covering torso, NOT lifted or tucked up. Model should NOT be centered - position off to one side of the frame');
            parts.push(`CLOTHING REMINDER: Reproduce the EXACT clothing from the product reference images - same colors, patterns, and style. Items: ${outfits.join('; ')}`);

            return parts.join('. ') + '.';
        }

        function buildImageUrls(task) {
            const urls = [];

            // Add model references
            state.selectedModels.forEach(modelId => {
                if (state.modelFalUrls[modelId]) {
                    urls.push(state.modelFalUrls[modelId]);
                }
            });

            // Add product references (both preset and custom)
            task.assignedGroups.forEach(groupNum => {
                const productItems = task.groups[groupNum];
                productItems.forEach(item => {
                    if (item.type === 'preset') {
                        if (state.productFalUrls[item.id]) {
                            urls.push(state.productFalUrls[item.id]);
                        }
                    } else if (item.type === 'custom') {
                        if (item.product && item.product.falUrl) {
                            urls.push(item.product.falUrl);
                        }
                    }
                });
            });

            // Add environment reference (unless describe-only mode)
            if (task.env.falUrl && !state.describeEnvOnly) {
                urls.push(task.env.falUrl);
            }

            return urls;
        }

        function addResult(result) {
            state.results.push(result);
            const resultIndex = state.results.length - 1;

            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML = `
                <img src="${result.url}" alt="Result">
                <div class="result-label">${result.isDuo ? 'Duo' : 'Solo'} - Env ${result.envIdx + 1}</div>
            `;
            card.addEventListener('click', () => {
                const lightboxResults = state.results.map((r, idx) => ({
                    url: r.url,
                    prompt: r.prompt,
                    modelName: 'Ron Dorff',
                    filename: `RonDorff_FearlessSummer_${String(idx + 1).padStart(2, '0')}.png`
                }));
                lightbox.setResults(lightboxResults);
                lightbox.open(resultIndex);
            });
            elements.resultsGrid.prepend(card);
        }

        // ========== INIT ==========
        function init() {
            renderModels();
            renderProducts();
            renderCustomProducts();
            renderEnvironments();
            renderPresetEnvironments();
            updateSummary();

            // Model tab click handlers
            elements.modelTabs.querySelectorAll('.section-tab').forEach(tab => {
                tab.addEventListener('click', () => switchModelTab(tab.dataset.tab));
            });

            // Product tab click handlers
            elements.productTabs.querySelectorAll('.section-tab').forEach(tab => {
                tab.addEventListener('click', () => switchProductTab(tab.dataset.tab));
            });
        }

        init();
    </script>
</body>
</html>
