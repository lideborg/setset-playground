<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light">
    <title>Location Creator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèõÔ∏è</text></svg>">
    <link rel="stylesheet" href="/shared/css/tokens.css">
    <link rel="stylesheet" href="/shared/css/base.css">
    <link rel="stylesheet" href="/shared/css/components.css">
    <style>
        :root {
            color-scheme: light only;
        }

        .container {
            max-width: 900px;
        }

        .generator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .generator-section {
            background: var(--off-white);
            padding: var(--space-md);
            border-radius: var(--radius-md);
        }

        .generator-section.full-width {
            grid-column: 1 / -1;
        }

        .section-title {
            font-size: var(--text-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--carbon);
            margin-bottom: var(--space-sm);
        }

        /* Description textarea */
        .description-input {
            width: 100%;
            padding: 12px 14px;
            font-size: var(--text-md);
            font-family: var(--font-sans);
            color: var(--carbon);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-sm);
            background: var(--white);
            resize: none;
            min-height: 120px;
            line-height: 1.5;
        }

        .description-input:focus {
            outline: none;
            border-color: var(--jet);
        }

        .description-input::placeholder {
            color: var(--slate);
        }

        /* Button groups */
        .button-group {
            display: flex;
            gap: var(--space-xs);
        }

        .button-group .btn {
            flex: 1;
        }

        .button-group-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
        }

        .button-group-wrap .btn {
            padding: 10px 16px;
        }

        /* Slider */
        .slider-row {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .slider-label {
            font-size: var(--text-sm);
            color: var(--slate);
            min-width: 60px;
        }

        .slider-label.right {
            text-align: right;
        }

        .people-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--gainsboro);
            border-radius: 4px;
            cursor: pointer;
        }

        .people-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--jet);
            border-radius: 50%;
            cursor: pointer;
        }

        .people-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--jet);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--jet);
            min-width: 40px;
            text-align: center;
        }

        /* Generate section */
        .generate-section {
            margin-top: var(--space-md);
        }

        .calc-display {
            font-size: var(--text-md);
            color: var(--carbon);
            margin-bottom: var(--space-sm);
            text-align: center;
        }

        /* Progress */
        .progress-section {
            display: none;
            margin-top: var(--space-lg);
            padding: var(--space-lg);
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gainsboro);
        }

        .progress-section.visible {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .progress-title {
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--slate);
        }

        .progress-count {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--jet);
        }

        .progress-bar-container {
            height: 8px;
            background: var(--off-white);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--jet);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Results */
        .results-section {
            display: none;
            margin-top: var(--space-lg);
        }

        .results-section.visible {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .results-header h3 {
            font-size: var(--text-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--carbon);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
        }

        @media (max-width: 900px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .generator-grid {
                grid-template-columns: 1fr;
            }
        }

        .result-card {
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--gainsboro);
            transition: all var(--transition-fast);
            background: var(--off-white);
        }

        .result-card:hover {
            border-color: var(--jet);
        }

        .result-card img {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
            display: block;
        }

        .result-card[data-ratio="3:4"] img,
        .result-card[data-ratio="2:3"] img {
            aspect-ratio: 3/4;
        }

        .result-card[data-ratio="16:9"] img,
        .result-card[data-ratio="21:9"] img {
            aspect-ratio: 16/9;
        }

        .result-card[data-ratio="1:1"] img {
            aspect-ratio: 1/1;
        }

        .result-placeholder {
            width: 100%;
            aspect-ratio: 4/3;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            background: var(--off-white);
        }

        .result-placeholder .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--gainsboro);
            border-top-color: var(--jet);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .result-placeholder p {
            font-size: var(--text-xs);
            color: var(--slate);
        }

        .result-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: var(--space-sm);
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .result-card:hover .result-overlay {
            opacity: 1;
        }

        .result-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .result-btn {
            flex: 1;
            padding: 6px 10px;
            background: var(--white);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .result-btn:hover {
            background: var(--jet);
            color: var(--white);
        }

        .result-tag {
            position: absolute;
            top: var(--space-xs);
            left: var(--space-xs);
            padding: 2px 6px;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 10px;
            border-radius: var(--radius-xs);
            text-transform: uppercase;
        }

        /* Lightbox - magazine cover style with responsive scaling */
        .lightbox {
            padding: 4vw;
        }

        .lightbox-content {
            height: auto;
            max-height: calc(100vh - 8vw);
            width: 90vw;
            max-width: 1600px;
            grid-template-columns: 1fr minmax(250px, 20%);
            gap: 0;
        }

        .lightbox-left {
            background: var(--jet);
            padding: 4vw;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-image {
            max-height: calc(100vh - 16vw);
            max-width: 100%;
            object-fit: contain;
        }

        .lightbox-right {
            min-width: 250px;
            max-height: calc(100vh - 8vw);
            padding: var(--space-lg);
        }

        .lightbox-section {
            margin-bottom: var(--space-md);
        }

        .lightbox-prompt-text {
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: var(--text-xs);
            line-height: 1.6;
        }

        .lightbox-nav {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .lightbox-nav:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .lightbox-prev {
            left: 5vw;
        }

        .lightbox-next {
            right: calc(20% + 5vw);
        }

        .lightbox-close {
            top: 4vw;
            right: 4vw;
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .lightbox-close:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        /* Inline Loader */
        .inline-loader {
            display: none;
            text-align: center;
            padding: var(--space-xl) var(--space-lg);
            background: var(--white);
            border: 1px solid var(--gainsboro);
            border-radius: var(--radius-lg);
            margin-top: var(--space-lg);
        }

        .inline-loader.visible {
            display: block;
        }

        .loader-message {
            font-size: var(--text-lg);
            font-weight: 500;
            color: var(--jet);
            margin-bottom: var(--space-sm);
            transition: opacity 0.25s ease;
        }

        .loader-message.fade-out {
            opacity: 0;
        }

        .loader-message.fade-in {
            opacity: 1;
        }

        .loader-progress {
            font-size: var(--text-sm);
            color: var(--slate);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <h1>Location Creator</h1>
            <p class="hero-subtitle">Generate diverse location and environment shots with compositional variety</p>
        </div>

        <!-- Generator Controls -->
        <div class="generator-grid">
            <!-- Description -->
            <div class="generator-section full-width">
                <div class="section-title">Describe the Location</div>
                <textarea class="description-input" id="description-input"
                    placeholder="Describe the location or environment...&#10;&#10;Example: Brutalist concrete museum interior with dramatic skylights, geometric shapes, raw concrete walls, diffused natural light streaming through angular windows"></textarea>
            </div>

            <!-- People Slider -->
            <div class="generator-section full-width">
                <div class="section-title">Include People</div>
                <div class="slider-row">
                    <span class="slider-label">None</span>
                    <input type="range" class="people-slider" id="people-slider" min="0" max="100" value="30">
                    <span class="slider-label right">All</span>
                    <span class="slider-value" id="people-value">30%</span>
                </div>
            </div>

            <!-- Gender (multi-select) -->
            <div class="generator-section">
                <div class="section-title">Gender</div>
                <div class="button-group" id="gender-group">
                    <button class="btn btn--toggle active" data-value="female">Female</button>
                    <button class="btn btn--toggle active" data-value="male">Male</button>
                </div>
            </div>

            <!-- Framing (multi-select) -->
            <div class="generator-section">
                <div class="section-title">Framing</div>
                <div class="button-group" id="framing-group">
                    <button class="btn btn--toggle active" data-value="full-body">Full Body</button>
                    <button class="btn btn--toggle" data-value="half-body">Half Body</button>
                    <button class="btn btn--toggle" data-value="portrait">Portrait</button>
                </div>
            </div>

            <!-- Clothing Style -->
            <div class="generator-section full-width">
                <div class="section-title">Clothing</div>
                <div class="button-group" id="clothing-group">
                    <button class="btn btn--toggle active" data-value="auto">Auto</button>
                    <button class="btn btn--toggle" data-value="editorial">Editorial</button>
                    <button class="btn btn--toggle" data-value="luxury">Luxury</button>
                    <button class="btn btn--toggle" data-value="casual">Casual</button>
                    <button class="btn btn--toggle" data-value="formal">Formal</button>
                    <button class="btn btn--toggle" data-value="athleisure">Athleisure</button>
                    <button class="btn btn--toggle" data-value="swimwear">Swimwear</button>
                </div>
            </div>

            <!-- Time of Day (multi-select) -->
            <div class="generator-section full-width">
                <div class="section-title">Time of Day (select multiple)</div>
                <div class="button-group-wrap" id="lighting-group">
                    <button class="btn btn--toggle" data-value="sunrise">Sunrise</button>
                    <button class="btn btn--toggle" data-value="morning">Morning</button>
                    <button class="btn btn--toggle active" data-value="midday">Midday</button>
                    <button class="btn btn--toggle active" data-value="afternoon">Afternoon</button>
                    <button class="btn btn--toggle" data-value="golden">Golden Hour</button>
                    <button class="btn btn--toggle" data-value="sunset">Sunset</button>
                    <button class="btn btn--toggle" data-value="overcast">Overcast</button>
                </div>
            </div>

            <!-- Model (multi-select) -->
            <div class="generator-section">
                <div class="section-title">Model</div>
                <div class="button-group" id="model-group">
                    <button class="btn btn--toggle active" data-value="reve">Reve</button>
                    <button class="btn btn--toggle" data-value="zimage">Z-Image</button>
                </div>
            </div>

            <!-- Aspect Ratio -->
            <div class="generator-section">
                <div class="section-title">Aspect Ratio</div>
                <div class="button-group" id="aspect-group">
                    <button class="btn btn--toggle" data-value="3:4">3:4</button>
                    <button class="btn btn--toggle active" data-value="4:3">4:3</button>
                    <button class="btn btn--toggle" data-value="16:9">16:9</button>
                    <button class="btn btn--toggle" data-value="1:1">1:1</button>
                </div>
            </div>

            <!-- Number of Results -->
            <div class="generator-section full-width">
                <div class="section-title">Number of Results</div>
                <div class="button-group" id="count-group">
                    <button class="btn btn--toggle" data-value="8">8</button>
                    <button class="btn btn--toggle active" data-value="12">12</button>
                    <button class="btn btn--toggle" data-value="16">16</button>
                    <button class="btn btn--toggle" data-value="20">20</button>
                </div>
            </div>
        </div>

        <!-- Generate -->
        <div class="generate-section">
            <div class="calc-display" id="calc-display">12 images @ $0.04 each = $0.48</div>
            <button class="btn btn--primary btn--lg btn--block" id="generate-btn">Generate Locations</button>
        </div>

        <!-- Progress -->
        <div class="progress-section" id="progress-section">
            <div class="progress-header">
                <span class="progress-title">Generating</span>
                <span class="progress-count" id="progress-count">0 / 0</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <!-- Results -->
        <div class="results-section" id="results-section">
            <div class="results-header">
                <h3>Generated Locations</h3>
                <button class="btn" id="download-all-btn">Download All</button>
            </div>
            <div class="results-grid" id="results-grid"></div>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox" onclick="if(event.target === this) closeLightbox()">
        <button class="lightbox-close" id="lightbox-close" onclick="closeLightbox()">&times;</button>
        <button class="lightbox-nav lightbox-prev" id="lightbox-prev" onclick="navigateLightbox(-1)">&larr;</button>
        <button class="lightbox-nav lightbox-next" id="lightbox-next" onclick="navigateLightbox(1)">&rarr;</button>
        <div class="lightbox-content">
            <div class="lightbox-left">
                <img class="lightbox-image" id="lightbox-image" src="" alt="Generated location">
            </div>
            <div class="lightbox-right">
                <div class="lightbox-section">
                    <h3 class="lightbox-section-title">Composition</h3>
                    <p class="lightbox-model-text" id="lightbox-composition"></p>
                </div>
                <div class="lightbox-section">
                    <h3 class="lightbox-section-title">Prompt</h3>
                    <p class="lightbox-prompt-text" id="lightbox-prompt"></p>
                </div>
                <div class="lightbox-section">
                    <h3 class="lightbox-section-title">Settings</h3>
                    <p class="lightbox-prompt-text" id="lightbox-settings"></p>
                </div>
                <button class="lightbox-download" id="lightbox-download">Download Image</button>
            </div>
        </div>
    </div>

    <script src="/shared/js/api.js"></script>
    <script src="/shared/js/loader.js"></script>
    <script src="/shared/data/editorial-moods.js"></script>
    <script>
        // State
        const state = {
            description: '',
            peoplePercent: 30,
            genders: ['female', 'male'],  // multi-select genders
            framings: ['full-body'],  // multi-select framings
            clothingStyle: 'auto',  // auto, editorial, casual, swimwear, streetwear, formal
            lighting: ['midday', 'afternoon'],  // multi-select time of day
            models: ['reve'],
            aspectRatio: '4:3',
            resultCount: 12,
            results: [],
            generating: false,
            lightboxIndex: 0
        };

        // Framing descriptions for prompts
        const FRAMING_DESCRIPTIONS = {
            'full-body': 'full-body shot showing complete figure head to toe, entire person visible with feet on ground',
            'half-body': 'half-body shot from waist up, showing torso, arms, and face clearly',
            'portrait': 'portrait close-up from chest up, focus on face and upper body'
        };

        // Model costs per image
        const MODEL_COSTS = {
            'reve': 0.04,
            'zimage': 0.01
        };

        // Aspect ratio to dimensions (for models that need explicit sizes)
        const ASPECT_SIZES = {
            '3:4': { width: 768, height: 1024 },
            '4:3': { width: 1024, height: 768 },
            '16:9': { width: 1280, height: 720 },
            '1:1': { width: 1024, height: 1024 }
        };

        // Composition types - ALL must show FULL PERSON (head to toe) or 3/4 (head to knees)
        // NEVER cut off the head - face must ALWAYS be visible
        const COMPOSITION_TYPES = [
            // Full body (most shots should be these)
            { type: 'wide', label: 'Wide', desc: 'full-body, head-to-toe, person fills ~2/3 of frame height' },
            { type: 'center', label: 'Center', desc: 'full-body centered, environment on both sides' },
            { type: 'left', label: 'Left', desc: 'full-body on left third, not too tight, environment fills right' },
            { type: 'right', label: 'Right', desc: 'full-body on right third, environment fills left' },
            { type: 'depth', label: 'Depth', desc: 'full-body with depth layers, person still prominent' },
            // 3/4 body (fewer of these)
            { type: 'threequarter', label: '3/4', desc: '3/4 body from head to knees, face clearly visible, slightly tighter' },
            { type: 'threequarter_left', label: '3/4 Left', desc: '3/4 body on left side, head to knees, face visible' },
            { type: 'threequarter_right', label: '3/4 Right', desc: '3/4 body on right side, head to knees, face visible' },
            // Special
            { type: 'low_angle', label: 'Low Angle', desc: 'full-body from slightly lower angle, sky above' },
            { type: 'foreground', label: 'Foreground', desc: 'blurry foreground element, full-body in focus behind' }
        ];

        // Lighting variations by time of day
        const LIGHTING_BY_TYPE = {
            sunrise: [
                'early sunrise light, fresh yellow-beige tones, soft warm glow just after dawn',
                'sunrise golden light, long gentle shadows, crisp morning air feeling',
                'dawn light with fresh peachy-yellow warmth, sky transitioning from pink to blue',
                'early morning sun low on horizon, soft directional light, ethereal quality'
            ],
            morning: [
                'bright morning light, clean and fresh, slightly warm',
                'mid-morning sunlight, clear and crisp, light shadows',
                'fresh morning daylight, bright but not harsh, optimistic quality',
                'morning sun with slight warmth, clear visibility, energetic atmosphere'
            ],
            midday: [
                'hard direct sunlight, strong shadows, high contrast',
                'harsh midday sun, crisp shadows on ground',
                'bright direct daylight, sun high in sky',
                'strong sunlight creating sharp defined shadows'
            ],
            afternoon: [
                'soft late afternoon light, warm but not golden',
                'diffused natural light with gentle directionality',
                'soft directional light, fashion campaign quality',
                'gentle side light creating subtle dimension'
            ],
            golden: [
                'golden hour warm light, long dramatic shadows',
                'late day golden sunlight, rich warm tones',
                'magic hour lighting, everything bathed in gold',
                'pre-sunset golden glow, flattering warm light on skin'
            ],
            sunset: [
                'sunset light, warm orange and golden glow, dramatic long shadows',
                'rich sunset tones, deep orange and amber light, romantic atmosphere',
                'end of day sunset, sky painted orange and pink, warm golden light on subject',
                'dramatic sunset lighting, sun low on horizon, intense warm colors'
            ],
            overcast: [
                'soft overcast light, even and flattering',
                'cloudy diffused light, no harsh shadows',
                'flat overcast sky, even illumination',
                'grey sky ambient light, soft and moody'
            ]
        };

        // Get lighting variations based on selected types
        function getSelectedLighting() {
            let variations = [];
            state.lighting.forEach(type => {
                if (LIGHTING_BY_TYPE[type]) {
                    variations = variations.concat(LIGHTING_BY_TYPE[type]);
                }
            });
            return variations.length > 0 ? variations : LIGHTING_BY_TYPE.soft;
        }

        // Interaction prompts - adds life and variety to the scene (from location-generator)
        const INTERACTION_PROMPTS = [
            // Sitting
            'sitting casually on a chair',
            'sitting on the floor',
            'perched on a stool',
            'resting on a low bench',
            'sitting on steps',
            'sitting cross-legged on the ground',
            'lounging on a couch',
            'sitting on a window sill',
            'sitting on the edge of a table',
            'sitting backwards on a chair',
            // Leaning
            'leaning against the wall',
            'leaning on a table',
            'leaning in a doorway',
            'leaning on a railing',
            'leaning against a column',
            'leaning on a window frame',
            // Crouching/Kneeling
            'crouching down',
            'kneeling on one knee',
            'squatting casually',
            // Lying
            'lying on the floor looking up',
            'lying on a couch',
            'sprawled on a rug',
            // Dynamic poses
            'walking through the space',
            'mid-stride walking toward camera',
            'turning to look over shoulder',
            'adjusting their jacket',
            'running hand through hair',
            'arms crossed leaning back',
            'hands in pockets relaxed stance',
            'stretching arms overhead',
            // Props/Objects
            'holding a coffee cup',
            'reading a magazine',
            'holding sunglasses',
            'draped in a blanket',
            'wrapped in an oversized coat',
            'holding flowers',
            'carrying a bag over shoulder'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            updateCalcDisplay();
        });

        function setupEventListeners() {
            // Description
            document.getElementById('description-input').addEventListener('input', (e) => {
                state.description = e.target.value;
            });

            // People slider
            const peopleSlider = document.getElementById('people-slider');
            const peopleValue = document.getElementById('people-value');
            peopleSlider.addEventListener('input', (e) => {
                state.peoplePercent = parseInt(e.target.value);
                peopleValue.textContent = `${state.peoplePercent}%`;
            });

            // Gender multi-select (toggle)
            document.querySelectorAll('#gender-group .btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const value = btn.dataset.value;
                    const index = state.genders.indexOf(value);

                    if (index > -1) {
                        // Don't allow deselecting if it's the only one
                        if (state.genders.length > 1) {
                            state.genders.splice(index, 1);
                            btn.classList.remove('active');
                        }
                    } else {
                        state.genders.push(value);
                        btn.classList.add('active');
                    }
                });
            });

            // Framing multi-select (toggle)
            document.querySelectorAll('#framing-group .btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const value = btn.dataset.value;
                    const index = state.framings.indexOf(value);

                    if (index > -1) {
                        // Don't allow deselecting if it's the only one
                        if (state.framings.length > 1) {
                            state.framings.splice(index, 1);
                            btn.classList.remove('active');
                        }
                    } else {
                        state.framings.push(value);
                        btn.classList.add('active');
                    }
                });
            });

            // Clothing style single-select
            document.querySelectorAll('#clothing-group .btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#clothing-group .btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.clothingStyle = btn.dataset.value;
                });
            });

            // Lighting multi-select (toggle)
            document.querySelectorAll('#lighting-group .btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const value = btn.dataset.value;
                    const index = state.lighting.indexOf(value);

                    if (index > -1) {
                        // Don't allow deselecting if it's the only one
                        if (state.lighting.length > 1) {
                            state.lighting.splice(index, 1);
                            btn.classList.remove('active');
                        }
                    } else {
                        state.lighting.push(value);
                        btn.classList.add('active');
                    }
                });
            });

            // Model multi-select (toggle)
            document.querySelectorAll('#model-group .btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const value = btn.dataset.value;
                    const index = state.models.indexOf(value);

                    if (index > -1) {
                        if (state.models.length > 1) {
                            state.models.splice(index, 1);
                            btn.classList.remove('active');
                        }
                    } else {
                        state.models.push(value);
                        btn.classList.add('active');
                    }
                    updateCalcDisplay();
                });
            });

            // Aspect ratio single-select
            document.querySelectorAll('#aspect-group .btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#aspect-group .btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.aspectRatio = btn.dataset.value;
                });
            });

            // Count single-select
            document.querySelectorAll('#count-group .btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#count-group .btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.resultCount = parseInt(btn.dataset.value);
                    updateCalcDisplay();
                });
            });

            // Generate button
            document.getElementById('generate-btn').addEventListener('click', generateLocations);

            // Download all button
            document.getElementById('download-all-btn').addEventListener('click', downloadAll);

            // Keyboard navigation for lightbox
            document.addEventListener('keydown', (e) => {
                if (!document.getElementById('lightbox').classList.contains('visible')) return;
                if (e.key === 'Escape') closeLightbox();
                if (e.key === 'ArrowLeft') navigateLightbox(-1);
                if (e.key === 'ArrowRight') navigateLightbox(1);
            });
        }

        function updateCalcDisplay() {
            const totalImages = state.resultCount * state.models.length;
            const totalCost = state.models.reduce((sum, m) => sum + (MODEL_COSTS[m] || 0.04) * state.resultCount, 0);
            const modelNames = state.models.map(m => m === 'reve' ? 'Reve' : 'Z-Image').join(' + ');
            document.getElementById('calc-display').textContent = `${state.resultCount} prompts √ó ${state.models.length} model${state.models.length > 1 ? 's' : ''} = ${totalImages} images ‚âà $${totalCost.toFixed(2)}`;
        }

        // Add people to the first X prompts programmatically
        function addPeopleToPrompts(prompts, peopleCount) {
            if (peopleCount === 0) return prompts;

            const descLower = state.description ? state.description.toLowerCase() : '';
            const isSoftMood = descLower.includes('soft') || descLower.includes('gentle') ||
                              descLower.includes('warm') || descLower.includes('cozy');
            const isBeachContext = descLower.includes('beach') || descLower.includes('pool') ||
                                   descLower.includes('ocean') || descLower.includes('water') ||
                                   descLower.includes('swim') || descLower.includes('resort');

            // Modular clothing system: base + accessories + footwear
            const CLOTHING_SYSTEM = {
                editorial: {
                    base: {
                        female: [
                            'wearing an elegant midi dress',
                            'wearing tailored trousers with a silk blouse',
                            'wearing a designer coat over a minimalist outfit',
                            'wearing a flowing maxi skirt with a fitted top',
                            'wearing a structured blazer with wide-leg pants',
                            'wearing a knit sweater dress',
                            'wearing an oversized coat draped over shoulders',
                            'wearing a sleek jumpsuit',
                            'wearing a wrap dress',
                            'wearing high-waisted trousers with a tucked blouse'
                        ],
                        male: [
                            'wearing tailored trousers with a crisp button-up shirt',
                            'wearing a designer overcoat over a turtleneck',
                            'wearing a blazer with relaxed-fit trousers',
                            'wearing a knit sweater with tailored pants',
                            'wearing a linen suit with open collar',
                            'wearing a leather jacket over a simple tee',
                            'wearing an oversized coat with slim trousers',
                            'wearing a mock neck with pleated trousers',
                            'wearing a deconstructed blazer with wide pants',
                            'wearing a shawl-collar cardigan with fitted trousers'
                        ]
                    },
                    accessories: ['with minimal gold jewelry', 'carrying a structured leather bag', 'with a silk scarf', 'with statement earrings', 'with a designer belt', ''],
                    footwear: {
                        female: ['in pointed-toe heels', 'in sleek ankle boots', 'in strappy sandals', 'in elegant mules', 'in classic pumps', ''],
                        male: ['in leather dress shoes', 'in suede loafers', 'in Chelsea boots', 'in minimalist sneakers', 'in oxford shoes', '']
                    }
                },
                luxury: {
                    base: {
                        female: [
                            'wearing a minimalist slip dress',
                            'wearing a cashmere coat',
                            'wearing a simple white shirt and tailored black trousers',
                            'wearing an understated beige knit set',
                            'wearing a camel-tone wool coat',
                            'wearing a cream silk blouse with navy trousers',
                            'wearing a soft grey cashmere sweater dress',
                            'wearing an ivory linen suit',
                            'wearing a taupe merino wool co-ord'
                        ],
                        male: [
                            'wearing a perfectly fitted navy suit with no tie',
                            'wearing a cashmere sweater with tailored trousers',
                            'wearing a minimalist white shirt and black pants',
                            'wearing an unstructured linen blazer',
                            'wearing a tonal grey wool outfit',
                            'wearing a camel overcoat over neutral basics',
                            'wearing a charcoal cashmere rollneck with grey trousers',
                            'wearing an ivory knit with beige chinos',
                            'wearing a soft grey suit with no tie'
                        ]
                    },
                    accessories: ['with a discreet luxury watch', 'carrying a minimal leather tote', 'with a cashmere scarf draped', ''],
                    footwear: {
                        female: ['in Bottega-style woven sandals', 'in soft suede loafers', 'in minimal leather flats', 'in elegant kitten heels', ''],
                        male: ['in soft suede loafers', 'in minimal leather sneakers', 'in handcrafted leather shoes', 'in understated dress shoes', '']
                    }
                },
                casual: {
                    base: {
                        female: [
                            'wearing jeans and a simple t-shirt',
                            'wearing a casual sundress',
                            'wearing denim shorts and a tank top',
                            'wearing a hoodie and leggings',
                            'wearing a relaxed linen shirt and shorts',
                            'wearing a cozy oversized sweater with jeans',
                            'wearing a denim jacket over a maxi dress',
                            'wearing cargo pants with a cropped tee',
                            'wearing a flannel shirt tied at waist with jeans'
                        ],
                        male: [
                            'wearing jeans and a plain t-shirt',
                            'wearing chinos and a polo shirt',
                            'wearing shorts and a casual button-up',
                            'wearing a hoodie and joggers',
                            'wearing a relaxed linen shirt and shorts',
                            'wearing a simple sweater with jeans',
                            'wearing a denim jacket with black jeans',
                            'wearing cargo shorts with a henley',
                            'wearing a flannel shirt with chinos'
                        ]
                    },
                    accessories: ['with a baseball cap', 'carrying a canvas tote', 'with a crossbody bag', 'wearing sunglasses', ''],
                    footwear: {
                        female: ['in white sneakers', 'in canvas slip-ons', 'in flat sandals', 'in Converse', 'in Birkenstocks', ''],
                        male: ['in white sneakers', 'in canvas slip-ons', 'in leather sandals', 'in Vans', 'in boat shoes', '']
                    }
                },
                formal: {
                    base: {
                        female: [
                            'wearing an elegant evening gown',
                            'wearing a sleek black cocktail dress',
                            'wearing a tailored suit',
                            'wearing a sophisticated midi dress',
                            'wearing a sequined top with elegant trousers',
                            'wearing a floor-length formal dress',
                            'wearing a velvet slip dress',
                            'wearing a structured satin gown',
                            'wearing an off-shoulder evening dress'
                        ],
                        male: [
                            'wearing a classic black tuxedo',
                            'wearing a tailored three-piece suit',
                            'wearing a formal suit with tie',
                            'wearing a dinner jacket with dress pants',
                            'wearing an elegant dark suit',
                            'wearing a midnight blue tuxedo',
                            'wearing a double-breasted suit',
                            'wearing a velvet dinner jacket',
                            'wearing a classic peak-lapel suit'
                        ]
                    },
                    accessories: ['with diamond jewelry', 'with a clutch purse', 'with a pocket square', 'with cufflinks', 'with a statement necklace', ''],
                    footwear: {
                        female: ['in strappy stilettos', 'in elegant pointed heels', 'in embellished sandals', 'in satin pumps', ''],
                        male: ['in patent leather oxfords', 'in polished dress shoes', 'in velvet loafers', 'in classic black brogues', '']
                    }
                },
                athleisure: {
                    base: {
                        female: [
                            'wearing yoga pants and a sports bra',
                            'wearing a matching workout set',
                            'wearing running shorts and a crop top',
                            'wearing leggings with an oversized hoodie',
                            'wearing a tennis skirt and fitted top',
                            'wearing a seamless ribbed set',
                            'wearing biker shorts with an oversized tee',
                            'wearing a zip-up sports jacket with leggings',
                            'wearing a cropped sweatshirt with high-waist leggings'
                        ],
                        male: [
                            'wearing joggers and a fitted tank',
                            'wearing athletic shorts and a compression top',
                            'wearing a tracksuit',
                            'wearing gym shorts and a hoodie',
                            'wearing running tights with a performance tee',
                            'wearing a tech fleece set',
                            'wearing basketball shorts with a muscle tee',
                            'wearing slim joggers with a quarter-zip',
                            'wearing a windbreaker with training pants'
                        ]
                    },
                    accessories: ['with a gym bag', 'with a fitness watch', 'with a headband', 'with wireless earbuds', ''],
                    footwear: {
                        female: ['in running shoes', 'in minimalist trainers', 'in Nike Air Max', 'in studio sneakers', ''],
                        male: ['in running shoes', 'in training sneakers', 'in Nike or Adidas', 'in high-tops', '']
                    }
                },
                swimwear: {
                    base: {
                        female: [
                            'wearing a stylish one-piece swimsuit',
                            'wearing an elegant bikini',
                            'wearing a high-waisted bikini',
                            'wearing a sleek monokini',
                            'wearing a triangle bikini',
                            'wearing a bandeau bikini top with high-cut bottoms',
                            'wearing a plunging one-piece',
                            'wearing a ribbed bikini set',
                            'wearing a cut-out swimsuit'
                        ],
                        male: [
                            'wearing tailored swim trunks',
                            'wearing classic swim shorts',
                            'wearing board shorts',
                            'wearing fitted swim briefs',
                            'wearing retro-style swim shorts',
                            'wearing quick-dry swim trunks',
                            'wearing patterned swim shorts',
                            'wearing solid color swim briefs',
                            'wearing linen-blend swim shorts'
                        ]
                    },
                    accessories: ['with a sheer sarong', 'with oversized sunglasses', 'with a straw sun hat', 'with a beach tote', 'carrying a woven bag', 'with a linen cover-up', ''],
                    footwear: {
                        female: ['in minimal leather sandals', 'in strappy flat sandals', 'in elegant slides', 'in espadrilles', 'barefoot', ''],
                        male: ['in leather slides', 'in minimal flip-flops', 'in canvas espadrilles', 'in woven sandals', 'barefoot', '']
                    }
                }
            };

            // Build a complete outfit from the system
            function buildOutfit(style, gender) {
                const system = CLOTHING_SYSTEM[style] || CLOTHING_SYSTEM.editorial;
                const base = system.base[gender] || system.base.female;
                const accessories = system.accessories;
                const footwear = system.footwear[gender] || system.footwear.female;

                // Pick random base
                const baseOutfit = base[Math.floor(Math.random() * base.length)];

                // 50% chance of accessory
                const accessory = Math.random() < 0.5 ? accessories[Math.floor(Math.random() * accessories.length)] : '';

                // 70% chance of footwear mention
                const shoes = Math.random() < 0.7 ? footwear[Math.floor(Math.random() * footwear.length)] : '';

                // Combine
                let outfit = baseOutfit;
                if (accessory) outfit += `, ${accessory}`;
                if (shoes) outfit += `, ${shoes}`;

                return outfit;
            }

            // Determine which style to use
            function getClothingStyle() {
                if (state.clothingStyle === 'auto') {
                    if (isBeachContext) return 'swimwear';
                    return 'editorial';
                }
                return state.clothingStyle;
            }

            const activeClothingStyle = getClothingStyle();

            // Sentence structure templates for variety
            const templates = [
                (g, i, f, e, c) => `A ${g} fashion model ${i}, ${f}, ${e}, ${c}`,
                (g, i, f, e, c) => `${f} of a ${g} model ${i}, ${e}, ${c}`,
                (g, i, f, e, c) => `A ${g} model ${c}, ${i}, ${f}, ${e}`,
                (g, i, f, e, c) => `${e}, a ${g} fashion model ${i}, ${f}, ${c}`,
                (g, i, f, e, c) => `A fierce ${g} model ${c}, ${i} in the scene, ${f}, ${e}`
            ];

            // Shuffle prompts indices so people aren't always on first X
            const indices = prompts.map((_, i) => i).sort(() => Math.random() - 0.5);
            const peopleIndices = new Set(indices.slice(0, peopleCount));

            return prompts.map((prompt, i) => {
                if (!peopleIndices.has(i)) return prompt; // No person for this prompt

                // Select gender - randomize instead of alternating
                let gender;
                if (state.genders.length === 2) {
                    gender = Math.random() < 0.5 ? 'female' : 'male';
                } else {
                    gender = state.genders[0];
                }

                // Select framing - random from selected
                const selectedFraming = state.framings[Math.floor(Math.random() * state.framings.length)];
                const framingDesc = FRAMING_DESCRIPTIONS[selectedFraming];

                // Get expression - pick from ALL pools but filter out closed eyes and open mouths
                const allExpressions = ALL_EXPRESSIONS.filter(e =>
                    !e.prompt.includes('closed') &&
                    !e.prompt.includes('open mouth') &&
                    !e.prompt.includes('mouth open')
                );
                const expression = allExpressions[Math.floor(Math.random() * allExpressions.length)];

                // Get interaction - random
                const interaction = INTERACTION_PROMPTS[Math.floor(Math.random() * INTERACTION_PROMPTS.length)];

                // Build complete outfit (base + accessories + footwear)
                const clothing = buildOutfit(activeClothingStyle, gender);

                // Pick random template for sentence structure variety
                const template = templates[Math.floor(Math.random() * templates.length)];
                const personDesc = template(gender, interaction, framingDesc, expression.prompt, clothing);

                // Append to prompt
                return `${prompt}, ${personDesc}`;
            });
        }

        // Generate prompts via GPT
        async function generatePrompts(count) {
            // Calculate how many should have people
            const peopleCount = Math.round(count * (state.peoplePercent / 100));

            const systemPrompt = `You are writing DETAILED, EVOCATIVE prompts for fashion campaign backdrop photography.

YOUR PROMPTS MUST BE:
1. HIGHLY DESCRIPTIVE - paint a vivid picture with specific details (textures, colors, atmosphere, light quality)
2. EACH ONE UNIQUE - every prompt should describe a distinctly different scene/angle/mood
3. TRUE TO THE LOCATION - capture the specific character described (if they say "dark volcanic rocks" - make them DARK, not bright)

PROMPT STRUCTURE - each prompt should include:
- Specific environmental details (what exactly do we see? what textures? what colors?)
- Atmosphere and mood (how does the air feel? what's the quality of light?)
- Spatial description (where is the standing space for the model?)
- Lighting specifics (direction, quality, shadows, highlights)

EXAMPLE OF GOOD VS BAD:
BAD: "Standing space on left with rocks on right, overcast lighting"
GOOD: "Jagged obsidian-black volcanic rock formations rise on the right, their porous surfaces catching subtle highlights, while the left third opens to a flat expanse of dark weathered stone where a figure could stand, the overcast sky creating soft even illumination that emphasizes the raw mineral textures"

BACKDROP REQUIREMENTS:
- Every shot must have clear space for a full-body OR half-body person
- Ground must be visible for full-body shots
- Person should fill significant portion of frame (not tiny in distance)

STYLE: Campaign/editorial - confident, quiet, not overly dramatic or adventure-tourism feeling`;

            // Build lighting instruction based on time of day
            const lightingTypes = [];
            if (state.lighting.includes('sunrise')) lightingTypes.push('sunrise light with fresh yellow-beige warmth');
            if (state.lighting.includes('morning')) lightingTypes.push('bright clean morning light');
            if (state.lighting.includes('midday')) lightingTypes.push('hard direct midday sunlight');
            if (state.lighting.includes('afternoon')) lightingTypes.push('soft afternoon light');
            if (state.lighting.includes('golden')) lightingTypes.push('golden hour warm light');
            if (state.lighting.includes('sunset')) lightingTypes.push('sunset light with warm orange-golden glow');
            if (state.lighting.includes('overcast')) lightingTypes.push('overcast even lighting');
            const lightingInstruction = lightingTypes.length > 0 ? lightingTypes.join(', ') : 'natural light';

            const userPrompt = `Write ${count} DETAILED backdrop prompts for this location. Each must be HIGHLY DESCRIPTIVE and DISTINCTLY DIFFERENT.

===== THE LOCATION =====
${state.description || 'An interesting environmental location'}

===== CRITICAL =====
- STAY TRUE to the location description above. If it says "dark volcanic rocks" they must be DARK, not bright.
- Each prompt must be 2-3 sentences of RICH DESCRIPTION - textures, colors, atmosphere, specific details
- Every prompt must be DIFFERENT - vary the angle, the specific elements shown, the mood

===== COMPOSITION TYPES (use these labels) =====

CRITICAL: The person's HEAD and FACE must ALWAYS be visible. NEVER cut off at the waist showing only legs.

FULL-BODY (~75% of shots): [Wide], [Center], [Left], [Right], [Depth]
- Head-to-toe, entire person visible
- Person fills significant portion of frame (not tiny)
- [Left] should not be too tight - give breathing room

3/4 BODY (~15% of shots): [3/4], [3/4 Left], [3/4 Right]
- Head to approximately knees
- FACE MUST BE VISIBLE - this is upper 3/4, not lower
- Slightly tighter framing

SPECIAL (~10%): [Low Angle], [Foreground]
- [Low Angle] = full-body from slightly lower, sky above
- [Foreground] = blurry element in front, full-body sharp behind

===== LIGHTING =====
Distribute across prompts: ${lightingInstruction}

===== PEOPLE =====
DO NOT include any people in these prompts. Generate ONLY empty environment/backdrop descriptions. People will be added programmatically later.

===== FORMAT =====
Start each with [CompositionType] then 2-3 sentences of vivid description.
Return ONLY a JSON array of strings.`;

            try {
                console.log('üèõÔ∏è [Location Creator] Generating prompts...');

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        images: [],
                        prompt: userPrompt,
                        system: systemPrompt
                    })
                });

                const data = await response.json();

                if (data.error) {
                    console.error('üèõÔ∏è [Location Creator] GPT Error:', data.error);
                    throw new Error(data.error);
                }

                let content = data.content || '';
                console.log('üèõÔ∏è [Location Creator] GPT Response received, length:', content.length);

                // Extract JSON array from response
                const jsonMatch = content.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    const rawPrompts = JSON.parse(jsonMatch[0]);

                    // Handle both string arrays and object arrays
                    const processedPrompts = rawPrompts.map(p => {
                        let promptText = p;
                        if (typeof p === 'object' && p !== null) {
                            promptText = p.prompt || p.description || p.text || p.content || JSON.stringify(p);
                        }
                        return promptText;
                    });

                    // Now programmatically add people to the first X prompts
                    return addPeopleToPrompts(processedPrompts, peopleCount);
                }

                throw new Error('Failed to parse prompts');
            } catch (error) {
                console.error('üèõÔ∏è [Location Creator] Prompt generation error:', error);
                return generateFallbackPrompts(count);
            }
        }

        function generateFallbackPrompts(count) {
            const prompts = [];
            const peopleCount = Math.round(count * (state.peoplePercent / 100));
            const baseDesc = state.description || 'Dramatic architectural interior with interesting lighting';

            // Check if description suggests softer mood
            const descLower = state.description ? state.description.toLowerCase() : '';
            const isSoftMood = descLower.includes('soft') || descLower.includes('gentle') ||
                              descLower.includes('warm') || descLower.includes('cozy');

            // Shuffle compositions
            const shuffledComps = [...COMPOSITION_TYPES].sort(() => Math.random() - 0.5);
            const shuffledLighting = [...getSelectedLighting()].sort(() => Math.random() - 0.5);
            const shuffledInteractions = [...INTERACTION_PROMPTS].sort(() => Math.random() - 0.5);

            for (let i = 0; i < count; i++) {
                const comp = shuffledComps[i % shuffledComps.length];
                const lighting = shuffledLighting[i % shuffledLighting.length];
                const includePerson = i < peopleCount;

                let personText = '';
                if (includePerson) {
                    // Use ALL expressions but filter out closed eyes and open mouths
                    const allExpressions = ALL_EXPRESSIONS.filter(e =>
                        !e.prompt.includes('closed') &&
                        !e.prompt.includes('open mouth') &&
                        !e.prompt.includes('mouth open')
                    );
                    const expression = allExpressions[Math.floor(Math.random() * allExpressions.length)];
                    const interaction = shuffledInteractions[i % shuffledInteractions.length];

                    // Cycle through selected framings
                    const selectedFraming = state.framings[i % state.framings.length];
                    const framingDesc = FRAMING_DESCRIPTIONS[selectedFraming];

                    // Select gender based on state
                    let gender;
                    if (state.genders.length === 2) {
                        // 50/50 split
                        gender = i % 2 === 0 ? 'female' : 'male';
                    } else {
                        gender = state.genders[0];
                    }

                    // Detect beach/water context for appropriate clothing
                    const isBeachContext = descLower.includes('beach') || descLower.includes('pool') ||
                                           descLower.includes('ocean') || descLower.includes('water') ||
                                           descLower.includes('swim') || descLower.includes('resort');

                    let clothing;
                    if (isBeachContext) {
                        clothing = gender === 'female'
                            ? 'wearing stylish swimwear or resort wear'
                            : 'wearing stylish swim trunks or resort wear';
                    } else {
                        clothing = gender === 'female'
                            ? 'wearing editorial fashion (dress, tailored trousers with blouse, or designer coat)'
                            : 'wearing editorial fashion (tailored trousers with button-up shirt, blazer, or designer coat)';
                    }

                    personText = `, a ${gender} model ${interaction}, ${framingDesc}, ${expression.prompt}, ${clothing}, commanding editorial presence`;
                }

                const prompt = `[${comp.label}] ${comp.desc}, ${baseDesc}, ${lighting}${personText}, professional fashion photography, photorealistic`;
                prompts.push(prompt);
            }

            return prompts;
        }

        // Main generation function
        async function generateLocations() {
            if (state.generating) return;
            if (!state.description.trim()) {
                alert('Please describe the location you want to generate');
                return;
            }

            state.generating = true;
            state.results = [];

            const count = state.resultCount;
            const totalImages = count * state.models.length;

            // Show loader and progress
            startLoadingAnimation(`Creating ${count} unique compositions...`);
            document.getElementById('progress-section').classList.add('visible');
            document.getElementById('progress-count').textContent = `0 / ${totalImages}`;
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('results-section').classList.remove('visible');
            document.getElementById('results-grid').innerHTML = '';
            document.getElementById('generate-btn').disabled = true;

            try {
                // Step 1: Generate prompts via GPT
                document.querySelector('.progress-title').textContent = 'Creating compositions...';
                const prompts = await generatePrompts(count);
                console.log(`üèõÔ∏è [Location Creator] Generated ${prompts.length} prompts`);

                // Step 2: Create placeholder cards
                const jobs = [];
                let resultIndex = 0;

                prompts.forEach((prompt, promptIndex) => {
                    state.models.forEach((model) => {
                        // Extract composition type from prompt
                        const compMatch = prompt.match(/^\[([^\]]+)\]/);
                        const compType = compMatch ? compMatch[1] : 'Shot';

                        addResultPlaceholder(resultIndex, compType);
                        state.results.push({
                            id: resultIndex,
                            prompt,
                            model,
                            composition: compType,
                            url: null,
                            generating: true
                        });
                        jobs.push({ index: resultIndex, prompt, model });
                        resultIndex++;
                    });
                });

                // Stop loader, show results with placeholders
                stopLoadingAnimation();
                document.getElementById('results-section').classList.add('visible');
                document.querySelector('.progress-title').textContent = 'Generating';

                // Step 3: Generate images in parallel (batches of 10)
                let completed = 0;
                const batchSize = 10;

                for (let i = 0; i < jobs.length; i += batchSize) {
                    const batch = jobs.slice(i, i + batchSize);
                    const batchPromises = batch.map(async (job) => {
                        const { index, prompt, model } = job;
                        try {
                            const params = {
                                model: model,
                                prompt: prompt,
                                num_images: 1
                            };

                            if (model === 'reve') {
                                params.aspect_ratio = state.aspectRatio;
                            } else {
                                params.image_size = ASPECT_SIZES[state.aspectRatio] || ASPECT_SIZES['4:3'];
                            }

                            const response = await fetch('/api/generate', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(params)
                            });

                            const data = await response.json();

                            if (data.images && data.images[0]) {
                                const imageUrl = data.images[0].url;
                                state.results[index].url = imageUrl;
                                state.results[index].generating = false;
                                state.results[index].aspectRatio = state.aspectRatio;
                                updateResultCard(index, imageUrl);
                            } else {
                                throw new Error('No image returned');
                            }
                        } catch (error) {
                            console.error(`Generation ${index} failed:`, error);
                            state.results[index].error = error.message;
                            state.results[index].generating = false;
                            updateResultError(index);
                        }

                        completed++;
                        document.getElementById('progress-count').textContent = `${completed} / ${totalImages}`;
                        document.getElementById('progress-bar').style.width = `${(completed / totalImages) * 100}%`;
                    });

                    await Promise.all(batchPromises);
                }

                document.querySelector('.progress-title').textContent = 'Complete';

            } catch (error) {
                console.error('Generation error:', error);
                stopLoadingAnimation();
                alert('Failed to generate: ' + error.message);
            } finally {
                state.generating = false;
                document.getElementById('generate-btn').disabled = false;
            }
        }

        function addResultPlaceholder(index, compType) {
            const grid = document.getElementById('results-grid');
            const html = `
                <div class="result-card" id="result-${index}" data-index="${index}" data-ratio="${state.aspectRatio}">
                    <div class="result-placeholder">
                        <div class="spinner"></div>
                        <p>${compType}</p>
                    </div>
                </div>
            `;
            grid.insertAdjacentHTML('beforeend', html);
        }

        function updateResultCard(index, imageUrl) {
            const card = document.getElementById(`result-${index}`);
            if (!card) return;

            const result = state.results[index];
            card.innerHTML = `
                <img src="${imageUrl}" alt="Generated location ${index + 1}" onclick="openLightbox(${index})">
                <span class="result-tag">${result.composition}</span>
                <div class="result-overlay">
                    <div class="result-actions">
                        <button class="result-btn" onclick="event.stopPropagation(); downloadImage(${index})">Download</button>
                    </div>
                </div>
            `;
        }

        function updateResultError(index) {
            const card = document.getElementById(`result-${index}`);
            if (!card) return;

            card.innerHTML = `
                <div class="result-placeholder">
                    <p>Failed</p>
                </div>
            `;
        }

        // Lightbox functions
        function openLightbox(index) {
            state.lightboxIndex = index;
            updateLightboxContent();
            document.getElementById('lightbox').classList.add('visible');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('visible');
        }

        function navigateLightbox(direction) {
            const validResults = state.results.filter(r => r.url);
            const currentValidIndex = validResults.findIndex(r => r.id === state.lightboxIndex);
            const newValidIndex = currentValidIndex + direction;

            if (newValidIndex >= 0 && newValidIndex < validResults.length) {
                state.lightboxIndex = validResults[newValidIndex].id;
                updateLightboxContent();
            }
        }

        function updateLightboxContent() {
            const result = state.results[state.lightboxIndex];
            if (!result || !result.url) return;

            const modelNames = { 'reve': 'Reve', 'zimage': 'Z-Image' };
            document.getElementById('lightbox-image').src = result.url;
            document.getElementById('lightbox-composition').textContent = result.composition || 'Shot';
            document.getElementById('lightbox-prompt').textContent = result.prompt;
            document.getElementById('lightbox-settings').textContent = `Model: ${modelNames[result.model] || result.model}\nAspect: ${result.aspectRatio || '4:3'}\nPeople: ${state.peoplePercent}%`;
            document.getElementById('lightbox-download').onclick = () => downloadImage(state.lightboxIndex);
        }

        // Download functions
        async function downloadImage(index) {
            const result = state.results[index];
            if (!result || !result.url) return;

            const compLabel = (result.composition || 'shot').toLowerCase().replace(/\s+/g, '_');
            const filename = `Setset_Location_${compLabel}_${String(index + 1).padStart(2, '0')}_${Date.now()}.png`;

            try {
                const response = await fetch(`/api/proxy-download?url=${encodeURIComponent(result.url)}`);
                const blob = await response.blob();
                const downloadUrl = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);
            } catch (error) {
                console.error('Download failed:', error);
                window.open(result.url, '_blank');
            }
        }

        async function downloadAll() {
            const validResults = state.results.filter(r => r.url);
            for (let i = 0; i < validResults.length; i++) {
                await downloadImage(validResults[i].id);
                await new Promise(r => setTimeout(r, 300));
            }
        }
    </script>
</body>
</html>
